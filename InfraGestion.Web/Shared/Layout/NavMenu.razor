@using InfraGestion.Web.Core.Models
@using InfraGestion.Web.Core.Services
@using InfraGestion.Web.Features.Auth.Services

@inject NavigationService NavService
@inject AuthService AuthService
@inject NavigationManager Navigation

<div class="top-row ps-3 navbar navbar-dark">
    <div class="container-fluid">
        <div class="navbar-brand">
            <img src="/images/logoSideBar.png" alt="Logo 1" class="brand-logo" />
        </div>
        <button title="Navigation menu" class="navbar-toggler" @onclick="ToggleNavMenu">
            <span class="navbar-toggler-icon"></span>
        </button>
    </div>
</div>

<div class="@NavMenuCssClass nav-scrollable" @onclick="ToggleNavMenu">
    <nav class="nav flex-column">
        @foreach (var item in navItems)
        {
            @if (item.IsSpacer)
            {
                <div class="nav-spacer"></div>
            }
            else
            {
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="@item.Route" Match="@(item.ExactMatch ? NavLinkMatch.All : NavLinkMatch.Prefix)">
                        <svg class="nav-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                            <path d="@item.IconPath" />
                        </svg>
                        @item.Title
                    </NavLink>
                </div>
            }
        }

        <div class="nav-item px-3">
            <button class="nav-link logout-button" @onclick="HandleLogout">
                <svg class="nav-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M120,216a8,8,0,0,1-8,8H48a16,16,0,0,1-16-16V48A16,16,0,0,1,48,32h64a8,8,0,0,1,0,16H48V208h64A8,8,0,0,1,120,216Zm109.66-93.66l-40-40a8,8,0,0,0-11.32,11.32L204.69,120H112a8,8,0,0,0,0,16h92.69l-26.35,26.34a8,8,0,0,0,11.32,11.32l40-40A8,8,0,0,0,229.66,122.34Z" />
                </svg>
                Log out
            </button>
        </div>
    </nav>
</div>

@code {
    private bool collapseNavMenu = true;
    private string? NavMenuCssClass => collapseNavMenu ? "collapse" : null;
    private List<NavItem> navItems = new();
    private string currentRole = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadNavItems();
    }

    private async Task LoadNavItems()
    {
        var user = await AuthService.GetCurrentUserAsync();
        currentRole = user?.Role ?? string.Empty;
        Console.WriteLine($"DEBUG NavMenu - User: {user?.Username}, Role: '{currentRole}'");
        navItems = NavService.GetNavItemsForRole(currentRole);
        Console.WriteLine($"DEBUG NavMenu - NavItems count: {navItems.Count}");
        foreach (var item in navItems)
        {
            Console.WriteLine($"  - {item.Title} ({item.Route})");
        }
    }

    private void ToggleNavMenu()
    {
        collapseNavMenu = !collapseNavMenu;
    }

    private async Task HandleLogout()
    {
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/login", forceLoad: true);
    }
}
