@page "/decommissioning"
@using InfraGestion.Web.Features.Inventory.Models
@using InfraGestion.Web.Features.Inventory.Services
@using InfraGestion.Web.Features.Inventory.Helpers
@using InfraGestion.Web.Features.Inventory.Components
@using InfraGestion.Web.Shared.Components
@inject DecommissioningService DecommissioningService
@inject NavigationManager Navigation

<PageTitle>Gestión de Bajas Técnicas - InfraCom</PageTitle>

<div class="decommissioning-page">
    <!-- Header -->
    <div class="page-header-wrapper">
        <div class="page-header">
            <div class="header-text">
                <h1 class="page-title">Gestión de Bajas Técnicas</h1>
                <p class="page-description">Administración de los registros de bajas propuestas para los dispositivos de la empresa</p>
            </div>
            <div class="header-actions">
                <button class="btn-add-primary" @onclick="OpenCreateModal">
                    <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M228,128a12,12,0,0,1-12,12H140v76a12,12,0,0,1-24,0V140H40a12,12,0,0,1,0-24h76V40a12,12,0,0,1,24,0v76h76A12,12,0,0,1,228,128Z" />
                    </svg>
                    Agregar Baja Técnica
                </button>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filters-container">
        <div class="search-box">
            <svg class="search-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z" />
            </svg>
            <input type="text" class="search-input" 
                   placeholder="Buscar por ID equipo, nombre, técnico, receptor, destino..." 
                   @bind="searchTerm"
                   @bind:event="oninput" 
                   @bind:after="HandleSearch" />
        </div>

        <div class="filter-group">
            <select class="filter-select" @bind="selectedStatus" @bind:after="HandleFilterChange">
                <option value="">Estado: Todos</option>
                @foreach (var status in Enum.GetValues<DecommissioningStatus>())
                {
                    <option value="@status">@DecommissioningStatusHelper.GetStatusDisplayName(status)</option>
                }
            </select>

            <select class="filter-select" @bind="selectedReason" @bind:after="HandleFilterChange">
                <option value="">Motivo: Todos</option>
                @foreach (var reason in Enum.GetValues<DecommissioningReason>())
                {
                    <option value="@reason">@DecommissioningReasonHelper.GetReasonDisplayName(reason)</option>
                }
            </select>

            <button class="btn-export">
                <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M74.34,85.66A8,8,0,0,1,85.66,74.34L120,108.69V24a8,8,0,0,1,16,0v84.69l34.34-34.35a8,8,0,0,1,11.32,11.32l-48,48a8,8,0,0,1-11.32,0ZM240,136v64a16,16,0,0,1-16,16H32a16,16,0,0,1-16-16V136a16,16,0,0,1,16-16H84.4a4,4,0,0,1,2.83,1.17L111,145A24,24,0,0,0,145,145l23.8-23.8A4,4,0,0,1,171.6,120H224A16,16,0,0,1,240,136Zm-40,32a12,12,0,1,0-12,12A12,12,0,0,0,200,168Z" />
                </svg>
                Exportar
            </button>
        </div>
    </div>

    <!-- Table with horizontal scroll -->
    <div class="table-wrapper">
        <div class="table-container">
            <table class="decommissioning-table">
                <thead>
                    <tr>
                        <th>ID del equipo</th>
                        <th>Nombre del Equipo</th>
                        <th>Técnico</th>
                        <th>Fecha de solicitud</th>
                        <th>Estado</th>
                        <th>Motivo</th>
                        <th>Justificación</th>
                        <th>Fecha de baja</th>
                        <th>Destino final</th>
                        <th>Receptor de equipo</th>
                        <th class="actions-column"></th>
                    </tr>
                </thead>
                <tbody>
                    @if (isLoading)
                    {
                        <tr>
                            <td colspan="11" class="loading-cell">
                                <div class="spinner"></div>
                                <span>Cargando datos...</span>
                            </td>
                        </tr>
                    }
                    else if (filteredRequests == null || !filteredRequests.Any())
                    {
                        <tr>
                            <td colspan="11" class="empty-cell">
                                <svg class="empty-icon" viewBox="0 0 256 256" fill="currentColor"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path
                                        d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z" />
                                </svg>
                                <p>No se encontraron registros que coincidan con los filtros aplicados</p>
                            </td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var request in filteredRequests)
                        {
                            <tr>
                                <td class="device-id-cell">@($"DEV{request.DeviceId:D3}")</td>
                                <td class="device-name-cell">@request.DeviceName</td>
                                <td class="technician-cell">@request.TechnicianName</td>
                                <td class="date-cell">@request.RequestDate.ToString("dd/MM/yyyy")</td>
                                <td class="status-cell">
                                    <span class="status-badge @DecommissioningStatusHelper.GetStatusBadgeClass(request.Status)">
                                        @DecommissioningStatusHelper.GetStatusDisplayName(request.Status)
                                    </span>
                                </td>
                                <td class="reason-cell">
                                    <span class="reason-badge @DecommissioningReasonHelper.GetReasonBadgeClass(request.Reason)">
                                        @DecommissioningReasonHelper.GetReasonDisplayName(request.Reason)
                                    </span>
                                </td>
                                <td class="justification-cell">
                                    @request.Justification
                                </td>
                                <td class="date-cell">
                                    @(request.DecommissioningDate?.ToString("dd/MM/yyyy") ?? "-")
                                </td>
                                <td class="destination-cell">@(request.FinalDestination ?? "-")</td>
                                <td class="receiver-cell">@(request.ReceiverName ?? "-")</td>
                                <td class="actions-cell">
                                    <button class="btn-action btn-edit" @onclick="() => OpenEditModal(request.Id)" title="Editar">
                                        <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor"
                                            xmlns="http://www.w3.org/2000/svg">
                                            <path
                                                d="M229.66,58.34l-32-32a8,8,0,0,0-11.32,0l-96,96A8,8,0,0,0,88,128v32a8,8,0,0,0,8,8h32a8,8,0,0,0,5.66-2.34l96-96A8,8,0,0,0,229.66,58.34ZM124.69,152H104V131.31l64-64L188.69,88ZM200,76.69,179.31,56,192,43.31,212.69,64ZM224,128v80a16,16,0,0,1-16,16H48a16,16,0,0,1-16-16V48A16,16,0,0,1,48,32h80a8,8,0,0,1,0,16H48V208H208V128a8,8,0,0,1,16,0Z" />
                                        </svg>
                                    </button>
                                    <button class="btn-action btn-delete"
                                        @onclick="() => OpenDeleteConfirmModal(request.Id, request.DeviceName)" title="Eliminar">
                                        <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor"
                                            xmlns="http://www.w3.org/2000/svg">
                                            <path
                                                d="M216,48H176V40a24,24,0,0,0-24-24H104A24,24,0,0,0,80,40v8H40a8,8,0,0,0,0,16h8V208a16,16,0,0,0,16,16H192a16,16,0,0,0,16-16V64h8a8,8,0,0,0,0-16ZM112,168a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Zm48,0a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Zm0-120H96V40a8,8,0,0,1,8-8h48a8,8,0,0,1,8,8Z" />
                                        </svg>
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create Decommissioning Modal -->
<DecommissioningForm IsOpen="@showCreateModal"
                    OnClose="@CloseCreateModal"
                    OnSubmit="@HandleCreate" />

<!-- Edit Decommissioning Modal -->
<DecommissioningFormEdit IsOpen="@showEditModal"
                        RequestId="@selectedRequestId"
                        OnClose="@CloseEditModal"
                        OnSubmit="@HandleEdit"
                        OnLoadRequest="@LoadRequestForEdit"
                        @ref="editFormRef" />

<!-- Delete Confirm Modal -->
<ConfirmDialog IsOpen="@showDeleteConfirmModal" Title="Eliminar Baja Técnica"
    Message="@deleteConfirmMessage" ConfirmText="Eliminar" CancelText="Cancelar" 
    OnConfirm="@HandleDelete" OnCancel="@CloseDeleteConfirmModal" />

@code {
    // Data
    private List<DecommissioningRequest> allRequests = new();
    private List<DecommissioningRequest> filteredRequests = new();
    private bool isLoading = true;

    // Filters
    private string searchTerm = string.Empty;
    private string selectedStatus = string.Empty;
    private string selectedReason = string.Empty;

    // Modals
    private bool showCreateModal = false;
    private bool showEditModal = false;

    // Delete confirmation
    private bool showDeleteConfirmModal = false;
    private int requestIdToDelete = 0;
    private int selectedRequestId = 0;
    private string deleteConfirmMessage = string.Empty;

    // Form references
    private DecommissioningFormEdit? editFormRef;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        allRequests = await DecommissioningService.GetAllDecommissioningRequestsAsync();
        ApplyFilters();
        isLoading = false;
    }

    private void HandleSearch()
    {
        ApplyFilters();
    }

    private void HandleFilterChange()
    {
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        var query = allRequests.AsEnumerable();

        // Search filter
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            query = query.Where(r =>
                r.DeviceId.ToString().Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                r.DeviceName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                r.TechnicianName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                (r.ReceiverName != null && r.ReceiverName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) ||
                (r.FinalDestination != null && r.FinalDestination.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)));
        }

        // Status filter
        if (!string.IsNullOrEmpty(selectedStatus))
        {
            var statusFilter = Enum.Parse<DecommissioningStatus>(selectedStatus);
            query = query.Where(r => r.Status == statusFilter);
        }

        // Reason filter
        if (!string.IsNullOrEmpty(selectedReason))
        {
            var reasonFilter = Enum.Parse<DecommissioningReason>(selectedReason);
            query = query.Where(r => r.Reason == reasonFilter);
        }

        filteredRequests = query.ToList();
    }

    // Modal handlers
    private void OpenCreateModal()
    {
        showCreateModal = true;
    }

    private void CloseCreateModal()
    {
        showCreateModal = false;
    }

    private void OpenEditModal(int id)
    {
        selectedRequestId = id;
        showEditModal = true;
    }

    private void CloseEditModal()
    {
        showEditModal = false;
        selectedRequestId = 0;
    }

    private void OpenDeleteConfirmModal(int id, string deviceName)
    {
        requestIdToDelete = id;
        deleteConfirmMessage = $"¿Está seguro que desea eliminar la solicitud de baja técnica para el equipo \"{deviceName}\"? Esta acción no se puede deshacer.";
        showDeleteConfirmModal = true;
    }

    private void CloseDeleteConfirmModal()
    {
        showDeleteConfirmModal = false;
        requestIdToDelete = 0;
        deleteConfirmMessage = string.Empty;
    }

    private async Task HandleCreate(DecommissioningRequest newRequest)
    {
        // TODO: Call service to create decommissioning request
        // var success = await DecommissioningService.CreateDecommissioningRequestAsync(newRequest);
        // if (success)
        // {
        //     await LoadData();
        //     CloseCreateModal();
        // }
        
        // For now, just close the modal
        Console.WriteLine($"Create decommissioning request for device: {newRequest.DeviceId}");
        CloseCreateModal();
    }

    private async Task LoadRequestForEdit(int id)
    {
        var request = await DecommissioningService.GetDecommissioningRequestByIdAsync(id);
        if (request != null && editFormRef != null)
        {
            editFormRef.SetRequest(request);
        }
    }

    private async Task HandleEdit(DecommissioningRequest updatedRequest)
    {
        var success = await DecommissioningService.UpdateDecommissioningRequestAsync(updatedRequest);
        if (success)
        {
            await LoadData();
            CloseEditModal();
        }
        else
        {
            // TODO: Show error message to user
            Console.WriteLine($"[ERROR] Failed to update decommissioning request #{updatedRequest.Id}");
            CloseEditModal();
        }
    }

    private async Task HandleDelete()
    {
        var success = await DecommissioningService.DeleteDecommissioningRequestAsync(requestIdToDelete);
        if (success)
        {
            await LoadData();
        }
        CloseDeleteConfirmModal();
    }

    // Helper methods
    private string TruncateText(string text, int maxLength)
    {
        if (string.IsNullOrEmpty(text) || text.Length <= maxLength)
            return text;

        return text.Substring(0, maxLength) + "...";
    }
}
