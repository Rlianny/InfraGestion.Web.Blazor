@page "/inventory"
@using InfraGestion.Web.Features.Inventory.Models
@using InfraGestion.Web.Features.Inventory.Services
@using InfraGestion.Web.Features.Inventory.Helpers
@using InfraGestion.Web.Features.Inventory.Components
@using InfraGestion.Web.Features.Users.Components
@using InfraGestion.Web.Features.Departments.Services
@inject DeviceService DeviceService
@inject DepartmentService DepartmentService
@inject NavigationManager Navigation

<div class="device-list-page">
    <!-- Header -->
    <div class="page-header-wrapper">
        <div class="page-header">
            <div class="header-text">
                <h1 class="page-title">Gestión de Inventario</h1>
                <p class="page-description">Administración de equipos de infraestructura</p>
            </div>
            <button class="btn-add-device" @onclick="OpenCreateModal">
                <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M228,128a12,12,0,0,1-12,12H140v76a12,12,0,0,1-24,0V140H40a12,12,0,0,1,0-24h76V40a12,12,0,0,1,24,0v76h76A12,12,0,0,1,228,128Z" />
                </svg>
                Agregar Equipo
            </button>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-container">
        <div class="stat-card">
            <div class="stat-value">@statistics["Total"]</div>
            <div class="stat-label">Total de equipos</div>
        </div>
        <div class="stat-card">
            <div class="stat-value stat-operational">@statistics["Operational"]</div>
            <div class="stat-label">Operativos</div>
        </div>
        <div class="stat-card">
            <div class="stat-value stat-maintenance">@statistics["UnderMaintenance"]</div>
            <div class="stat-label">Mantenimiento</div>
        </div>
        <div class="stat-card">
            <div class="stat-value stat-decommissioned">@statistics["Decommissioned"]</div>
            <div class="stat-label">Dado de baja</div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filters-container">
        <div class="search-box">
            <svg class="search-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z" />
            </svg>
            <input type="text" class="search-input" placeholder="Buscar por ID, nombre, ..." @bind="searchTerm"
                @bind:event="oninput" @bind:after="HandleSearch" />
        </div>

        <div class="filter-group">
            <select class="filter-select" @bind="selectedType" @bind:after="HandleFilterChange">
                <option value="">Tipo: Todos</option>
                <option value="@DeviceType.ConnectivityAndNetwork">Conectividad y Red</option>
                <option value="@DeviceType.ComputingAndIT">Cómputo e Informática</option>
                <option value="@DeviceType.ElectricalInfrastructureAndSupport">Infraestructura y Soporte</option>
                <option value="@DeviceType.CommunicationsAndTransmission">Comunicaciones y Transmisión</option>
                <option value="@DeviceType.DiagnosticAndMeasurement">Diagnóstico y Medición</option>
            </select>

            <select class="filter-select" @bind="selectedState" @bind:after="HandleFilterChange">
                <option value="">Estado: Todos</option>
                <option value="@OperationalState.Operational">Operativo</option>
                <option value="@OperationalState.UnderMaintenance">En Mantenimiento</option>
                <option value="@OperationalState.Decommissioned">De Baja</option>
                <option value="@OperationalState.BeingTransferred">Siendo Trasladado</option>
            </select>

            <!-- Department Dynamic Filter -->
            <select class="filter-select" @bind="selectedLocation" @bind:after="HandleFilterChange">
                <option value="">Ubicación Actual: Todos</option>
                @foreach (var dept in availableDepartments)
                {
                    <option value="@dept">@dept</option>
                }
            </select>

            <button class="btn-export">
                <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M74.34,85.66A8,8,0,0,1,85.66,74.34L120,108.69V24a8,8,0,0,1,16,0v84.69l34.34-34.35a8,8,0,0,1,11.32,11.32l-48,48a8,8,0,0,1-11.32,0ZM240,136v64a16,16,0,0,1-16,16H32a16,16,0,0,1-16-16V136a16,16,0,0,1,16-16H84.4a4,4,0,0,1,2.83,1.17L111,145A24,24,0,0,0,145,145l23.8-23.8A4,4,0,0,1,171.6,120H224A16,16,0,0,1,240,136Zm-40,32a12,12,0,1,0-12,12A12,12,0,0,0,200,168Z" />
                </svg>
                Exportar
            </button>
        </div>
    </div>

    <!-- Table -->
    <div class="table-container">
        <table class="devices-table">
            <thead>
                <tr>
                    <th>ID de equipo</th>
                    <th>Nombre</th>
                    <th>Tipo</th>
                    <th>Estado</th>
                    <th>Ubicación</th>
                    <th class="actions-column"></th>
                </tr>
            </thead>
            <tbody>
                @if (isLoading)
                {
                    <tr>
                        <td colspan="6" class="loading-cell">
                            <div class="spinner"></div>
                            <span>Cargando equipos...</span>
                        </td>
                    </tr>
                }
                else if (filteredDevices == null || !filteredDevices.Any())
                {
                    <tr>
                        <td colspan="6" class="empty-cell">
                            <svg class="empty-icon" viewBox="0 0 256 256" fill="currentColor"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z" />
                            </svg>
                            <p>No se encontraron equipos que coincidan con los filtros aplicados</p>
                        </td>
                    </tr>
                }
                else
                {
                    @foreach (var device in filteredDevices)
                    {
                        <tr>
                            <td class="id-cell">DEV@(device.Id.ToString("D3"))</td>
                            <td class="name-cell">@device.Name</td>
                            <td>
                                <span class="type-badge @DeviceTypeHelper.GetTypeBadgeClass(device.Type)">
                                    @DeviceTypeHelper.GetTypeDisplayName(device.Type)
                                </span>
                            </td>
                            <td>
                                <span class="status-badge @OperationalStateHelper.GetStateBadgeClass(device.State)">
                                    @OperationalStateHelper.GetStateDisplayName(device.State)
                                </span>
                            </td>
                            <td class="location-cell">@device.Location</td>
                            <td class="actions-cell">
                                <button class="btn-action btn-edit" @onclick="() => OpenEditModal(device.Id)" title="Editar">
                                    <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path
                                            d="M229.66,58.34l-32-32a8,8,0,0,0-11.32,0l-96,96A8,8,0,0,0,88,128v32a8,8,0,0,0,8,8h32a8,8,0,0,0,5.66-2.34l96-96A8,8,0,0,0,229.66,58.34ZM124.69,152H104V131.31l64-64L188.69,88ZM200,76.69,179.31,56,192,43.31,212.69,64ZM224,128v80a16,16,0,0,1-16,16H48a16,16,0,0,1-16-16V48A16,16,0,0,1,48,32h80a8,8,0,0,1,0,16H48V208H208V128a8,8,0,0,1,16,0Z" />
                                    </svg>
                                </button>
                                <button class="btn-action btn-delete" @onclick="() => HandleDelete(device.Id)" title="Eliminar">
                                    <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path
                                            d="M216,48H176V40a24,24,0,0,0-24-24H104A24,24,0,0,0,80,40v8H40a8,8,0,0,0,0,16h8V208a16,16,0,0,0,16,16H192a16,16,0,0,0,16-16V64h8a8,8,0,0,0,0-16ZM112,168a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Zm48,0a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Zm0-120H96V40a8,8,0,0,1,8-8h48a8,8,0,0,1,8,8Z" />
                                    </svg>
                                </button>
                                <button class="btn-action btn-view" @onclick="() => NavigateToDetails(device.Id)"
                                    title="Ver detalles">
                                    <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path
                                            d="M247.31,124.76c-.35-.79-8.82-19.58-27.65-38.41C194.57,61.26,162.88,48,128,48S61.43,61.26,36.34,86.35C17.51,105.18,9,124,8.69,124.76a8,8,0,0,0,0,6.5c.35.79,8.82,19.57,27.65,38.4C61.43,194.74,93.12,208,128,208s66.57-13.26,91.66-38.34c18.83-18.83,27.3-37.61,27.65-38.4A8,8,0,0,0,247.31,124.76ZM128,192c-30.78,0-57.67-11.19-79.93-33.25A133.47,133.47,0,0,1,25,128,133.33,133.33,0,0,1,48.07,97.25C70.33,75.19,97.22,64,128,64s57.67,11.19,79.93,33.25A133.46,133.46,0,0,1,231.05,128C223.84,141.46,192.43,192,128,192Zm0-112a48,48,0,1,0,48,48A48.05,48.05,0,0,0,128,80Zm0,80a32,32,0,1,1,32-32A32,32,0,0,1,128,160Z" />
                                    </svg>
                                </button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Modals -->
<Modal IsOpen="@showCreateModal" Title="Agregar Equipo" OnClose="@CloseCreateModal">
    <DeviceFormCreate FormModel="@createDeviceRequest" OnValidSubmit="@HandleCreateDevice"
        OnCancel="@CloseCreateModal" />
</Modal>

<Modal IsOpen="@showEditModal" Title="Editar Equipo" OnClose="@CloseEditModal">
    <DeviceFormEdit FormModel="@updateDeviceRequest" OnValidSubmit="@HandleUpdateDevice" OnCancel="@CloseEditModal" />
</Modal>

@code {
    private List<Device> allDevices = new();
    private List<Device> filteredDevices = new();
    private Dictionary<string, int> statistics = new();
    private bool isLoading = true;

    private string searchTerm = string.Empty;
    private string selectedType = string.Empty;
    private string selectedState = string.Empty;
    private string selectedLocation = string.Empty;

    // Departments Dynamic List
    private List<string> availableDepartments = new();

    private bool showCreateModal = false;
    private CreateDeviceRequest createDeviceRequest = new();

    private bool showEditModal = false;
    private UpdateDeviceRequest updateDeviceRequest = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDepartments(); // Departments Dynamic List
        await LoadDevices();
        await LoadStatistics();
    }

    // Departments Dynamic List
    private async Task LoadDepartments()
    {
        availableDepartments = await DepartmentService.GetAllDepartmentNamesAsync();
    }

    private async Task LoadDevices()
    {
        isLoading = true;
        allDevices = await DeviceService.GetAllDevicesAsync();
        filteredDevices = allDevices;
        isLoading = false;
    }

    private async Task LoadStatistics()
    {
        statistics = await DeviceService.GetStatisticsAsync();
    }

    private async Task HandleSearch()
    {
        await ApplyFilters();
    }

    private async Task HandleFilterChange()
    {
        await ApplyFilters();
    }

    private async Task ApplyFilters()
    {
        DeviceType? typeFilter = string.IsNullOrEmpty(selectedType) ? null : Enum.Parse<DeviceType>(selectedType);
        OperationalState? stateFilter = string.IsNullOrEmpty(selectedState) ? null :
        Enum.Parse<OperationalState>(selectedState);

        filteredDevices = await DeviceService.SearchDevicesAsync(searchTerm, typeFilter, stateFilter, selectedLocation);
    }

    private void OpenCreateModal()
    {
        createDeviceRequest = new CreateDeviceRequest();
        showCreateModal = true;
    }

    private void CloseCreateModal()
    {
        showCreateModal = false;
        createDeviceRequest = new CreateDeviceRequest();
    }

    private async Task HandleCreateDevice(CreateDeviceRequest request)
    {
        await DeviceService.CreateDeviceAsync(request);
        await LoadDevices();
        await LoadStatistics();
        await ApplyFilters();
        CloseCreateModal();
    }

    private async Task OpenEditModal(int deviceId)
    {
        var device = await DeviceService.GetDeviceByIdAsync(deviceId);
        if (device != null)
        {
            updateDeviceRequest = new UpdateDeviceRequest
            {
                Id = device.Id,
                Name = device.Name,
                Type = device.Type,
                PurchaseDate = DateTime.Today,
                State = device.State,
                Location = device.Location
            };
            showEditModal = true;
        }
    }

    private void CloseEditModal()
    {
        showEditModal = false;
        updateDeviceRequest = new UpdateDeviceRequest();
    }

    private async Task HandleUpdateDevice(UpdateDeviceRequest request)
    {
        await DeviceService.UpdateDeviceAsync(request);
        await LoadDevices();
        await LoadStatistics();
        await ApplyFilters();
        CloseEditModal();
    }

    private async Task HandleDelete(int deviceId)
    {

        try
        {
            var success = await DeviceService.DeleteDeviceAsync(deviceId);

            if (success)
            {
                Console.WriteLine("Device deleted successfully!");

                await LoadDevices();
                await LoadStatistics();
                await ApplyFilters();
            }
        }
        catch (Exception ex)
        {

        }
    }

    private void NavigateToDetails(int deviceId)
    {
        Navigation.NavigateTo($"/inventory/{deviceId}");
    }
}