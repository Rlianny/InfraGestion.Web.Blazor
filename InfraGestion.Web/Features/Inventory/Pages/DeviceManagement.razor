@page "/inventory"
@using InfraGestion.Web.Features.Inventory.Models
@using InfraGestion.Web.Features.Inventory.Services
@using InfraGestion.Web.Features.Inventory.Helpers
@using InfraGestion.Web.Features.Inventory.Components
@using InfraGestion.Web.Features.Departments.Services
@using InfraGestion.Web.Shared.Components
@inject DeviceService DeviceService
@inject DepartmentService DepartmentService
@inject NavigationManager Navigation

<div class="device-list-page">
    <!-- Header -->
    <div class="page-header-wrapper">
        <div class="page-header">
            <div class="header-text">
                <h1 class="page-title">Gestión de Inventario</h1>
                <p class="page-description">Administración de equipos de infraestructura</p>
            </div>
            <button class="btn-add-device" @onclick="OpenCreateModal">
                <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M228,128a12,12,0,0,1-12,12H140v76a12,12,0,0,1-24,0V140H40a12,12,0,0,1,0-24h76V40a12,12,0,0,1,24,0v76h76A12,12,0,0,1,228,128Z" />
                </svg>
                Agregar Equipo
            </button>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-container">
        <div class="stat-card">
            <div class="stat-value">@statistics["Total"]</div>
            <div class="stat-label">Total de equipos</div>
        </div>
        <div class="stat-card">
            <div class="stat-value stat-pending">@statistics["UnderRevision"]</div>
            <div class="stat-label">Pendientes de revision</div>
        </div>
        <div class="stat-card">
            <div class="stat-value stat-revised">@statistics["Revised"]</div>
            <div class="stat-label">Revisados</div>
        </div>
        <div class="stat-card">
            <div class="stat-value stat-operational">@statistics["Operational"]</div>
            <div class="stat-label">Operativos</div>
        </div>
        <div class="stat-card">
            <div class="stat-value stat-maintenance">@statistics["UnderMaintenance"]</div>
            <div class="stat-label">Mantenimiento</div>
        </div>
        <div class="stat-card">
            <div class="stat-value stat-decommissioned">@statistics["Decommissioned"]</div>
            <div class="stat-label">Dado de baja</div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filters-container">
        <div class="search-box">
            <svg class="search-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z" />
            </svg>
            <input type="text" class="search-input" placeholder="Buscar por ID, nombre, ..." @bind="searchTerm"
                @bind:event="oninput" @bind:after="HandleSearch" />
        </div>

        <div class="filter-group">
            <select class="filter-select" @bind="selectedType" @bind:after="HandleFilterChange">
                <option value="">Tipo: Todos</option>
                @foreach (var type in GetAvailableTypes())
                {
                    <option value="@type">@DeviceTypeHelper.GetTypeDisplayName(type)</option>
                }
            </select>

            <select class="filter-select" @bind="selectedState" @bind:after="HandleFilterChange">
                <option value="">Estado: Todos</option>
                @foreach (var state in GetAvailableStates())
                {
                    <option value="@state">@OperationalStateHelper.GetStateDisplayName(state)</option>
                }
            </select>

            <!-- Department Dynamic Filter -->
            <select class="filter-select" @bind="selectedLocation" @bind:after="HandleFilterChange">
                <option value="">Ubicación Actual: Todos</option>
                @foreach (var location in GetAvailableLocations())
                {
                    <option value="@location">@location</option>
                }
            </select>

            <button class="btn-export">
                <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M74.34,85.66A8,8,0,0,1,85.66,74.34L120,108.69V24a8,8,0,0,1,16,0v84.69l34.34-34.35a8,8,0,0,1,11.32,11.32l-48,48a8,8,0,0,1-11.32,0ZM240,136v64a16,16,0,0,1-16,16H32a16,16,0,0,1-16-16V136a16,16,0,0,1,16-16H84.4a4,4,0,0,1,2.83,1.17L111,145A24,24,0,0,0,145,145l23.8-23.8A4,4,0,0,1,171.6,120H224A16,16,0,0,1,240,136Zm-40,32a12,12,0,1,0-12,12A12,12,0,0,0,200,168Z" />
                </svg>
                Exportar
            </button>
        </div>
    </div>

    <!-- Table -->
    <div class="table-container">
        <table class="devices-table">
            <thead>
                <tr>
                    <th>ID de equipo</th>
                    <th>Nombre</th>
                    <th>Tipo</th>
                    <th>Estado</th>
                    <th>Ubicación</th>
                    <th class="actions-column"></th>
                </tr>
            </thead>
            <tbody>
                @if (isLoading)
                {
                    <tr>
                        <td colspan="6" class="loading-cell">
                            <div class="spinner"></div>
                            <span>Cargando equipos...</span>
                        </td>
                    </tr>
                }
                else if (filteredDevices == null || !filteredDevices.Any())
                {
                    <tr>
                        <td colspan="6" class="empty-cell">
                            <svg class="empty-icon" viewBox="0 0 256 256" fill="currentColor"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z" />
                            </svg>
                            <p>No se encontraron equipos que coincidan con los filtros aplicados</p>
                        </td>
                    </tr>
                }
                else
                {
                    @foreach (var device in filteredDevices)
                    {
                        <tr>
                            <td class="id-cell">DEV@(device.Id.ToString("D3"))</td>
                            <td class="name-cell">@device.Name</td>
                            <td>
                                <span class="type-badge @DeviceTypeHelper.GetTypeBadgeClass(device.Type)">
                                    @DeviceTypeHelper.GetTypeDisplayName(device.Type)
                                </span>
                            </td>
                            <td>
                                <StatusBadge DisplayText="@OperationalStateHelper.GetStateDisplayName(device.State)"
                                    BadgeClass="@OperationalStateHelper.GetStateBadgeClass(device.State)" />
                            </td>
                            <td class="location-cell">@device.Location</td>
                            <td class="actions-cell">
                                <button class="btn-action btn-edit" @onclick="() => OpenEditModal(device.Id)" title="Editar">
                                    <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path
                                            d="M229.66,58.34l-32-32a8,8,0,0,0-11.32,0l-96,96A8,8,0,0,0,88,128v32a8,8,0,0,0,8,8h32a8,8,0,0,0,5.66-2.34l96-96A8,8,0,0,0,229.66,58.34ZM124.69,152H104V131.31l64-64L188.69,88ZM200,76.69,179.31,56,192,43.31,212.69,64ZM224,128v80a16,16,0,0,1-16,16H48a16,16,0,0,1-16-16V48A16,16,0,0,1,48,32h80a8,8,0,0,1,0,16H48V208H208V128a8,8,0,0,1,16,0Z" />
                                    </svg>
                                </button>
                                <button class="btn-action btn-delete"
                                    @onclick="() => OpenDeleteConfirmModal(device.Id, device.Name)" title="Eliminar">
                                    <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path
                                            d="M216,48H176V40a24,24,0,0,0-24-24H104A24,24,0,0,0,80,40v8H40a8,8,0,0,0,0,16h8V208a16,16,0,0,0,16,16H192a16,16,0,0,0,16-16V64h8a8,8,0,0,0,0-16ZM112,168a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Zm48,0a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Zm0-120H96V40a8,8,0,0,1,8-8h48a8,8,0,0,1,8,8Z" />
                                    </svg>
                                </button>
                                <button class="btn-action btn-view" @onclick="() => NavigateToDetails(device.Id)"
                                    title="Ver detalles">
                                    <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path
                                            d="M213.66,82.34l-56-56A8,8,0,0,0,152,24H56A16,16,0,0,0,40,40V216a16,16,0,0,0,16,16H200a16,16,0,0,0,16-16V88A8,8,0,0,0,213.66,82.34ZM160,176H96a8,8,0,0,1,0-16h64a8,8,0,0,1,0,16Zm0-32H96a8,8,0,0,1,0-16h64a8,8,0,0,1,0,16Zm-8-56V44l44,44Z" />
                                    </svg>
                                </button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Modals -->
<Modal IsOpen="@showCreateModal" Title="Agregar Equipo" OnClose="@CloseCreateModal">
    <DeviceFormCreate FormModel="@createDeviceRequest" OnValidSubmit="@HandleCreateDevice"
        OnCancel="@CloseCreateModal" />
</Modal>

<Modal IsOpen="@showEditModal" Title="Editar Equipo" OnClose="@CloseEditModal">
    <DeviceFormEdit FormModel="@updateDeviceRequest" OnValidSubmit="@HandleUpdateDevice" OnCancel="@CloseEditModal" />
</Modal>

<ConfirmDialog IsOpen="@showDeleteConfirmModal" Title="Eliminar Equipo" Message="@deleteConfirmMessage"
    ConfirmText="Eliminar" CancelText="Cancelar" OnConfirm="@HandleDeleteDevice" OnCancel="@CloseDeleteConfirmModal" />

@code {
    private List<Device> allDevices = new();
    private List<Device> filteredDevices = new();
    private Dictionary<string, int> statistics = new()
{
{ "Total", 0 },
{ "UnderRevision", 0 },
{ "Revised", 0 },
{ "Operational", 0 },
{ "UnderMaintenance", 0 },
{ "Decommissioned", 0 },
{ "BeingTransferred", 0 }
};
    private bool isLoading = true;

    private string searchTerm = string.Empty;
    private string selectedType = string.Empty;
    private string selectedState = string.Empty;
    private string selectedLocation = string.Empty;

    // Departments Dynamic List
    private List<string> availableDepartments = new();

    private bool showCreateModal = false;
    private CreateDeviceRequest createDeviceRequest = new();

    private bool showEditModal = false;
    private UpdateDeviceRequest updateDeviceRequest = new();

    // Delete confirmation modal
    private bool showDeleteConfirmModal = false;
    private int deviceIdToDelete = 0;
    private string deleteConfirmMessage = string.Empty;

    // Dynamic filter options based on actual data
    private List<DeviceType> GetAvailableTypes()
    {
        return allDevices
        .Select(d => d.Type)
        .Distinct()
        .OrderBy(t => DeviceTypeHelper.GetTypeDisplayName(t))
        .ToList();
    }

    private List<OperationalState> GetAvailableStates()
    {
        return allDevices
        .Select(d => d.State)
        .Distinct()
        .OrderBy(s => OperationalStateHelper.GetStateDisplayName(s))
        .ToList();
    }

    private List<string> GetAvailableLocations()
    {
        return allDevices
        .Select(d => d.Location)
        .Where(l => !string.IsNullOrWhiteSpace(l))
        .Distinct()
        .OrderBy(l => l)
        .ToList();
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadDepartments(); // Departments Dynamic List
        await LoadDevices();
        await LoadStatistics();
    }

    // Departments Dynamic List
    private async Task LoadDepartments()
    {
        availableDepartments = await DepartmentService.GetAllDepartmentNamesAsync();
    }

    private async Task LoadDevices()
    {
        isLoading = true;
        allDevices = await DeviceService.GetAllDevicesAsync();
        filteredDevices = allDevices;
        isLoading = false;
    }

    private async Task LoadStatistics()
    {
        statistics = await DeviceService.GetStatisticsAsync();
    }

    private void HandleSearch()
    {
        ApplyLocalFilters();
    }

    private void HandleFilterChange()
    {
        ApplyLocalFilters();
    }

    private void ApplyLocalFilters()
    {
        var query = allDevices.AsEnumerable();

        // Filtrar por término de búsqueda
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            query = query.Where(d =>
            d.Id.ToString().Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
            d.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
            d.Location.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));
        }

        // Filtrar por tipo
        if (!string.IsNullOrEmpty(selectedType))
        {
            var typeFilter = Enum.Parse<DeviceType>(selectedType);
            query = query.Where(d => d.Type == typeFilter);
        }

        // Filtrar por estado
        if (!string.IsNullOrEmpty(selectedState))
        {
            var stateFilter = Enum.Parse<OperationalState>(selectedState);
            query = query.Where(d => d.State == stateFilter);
        }

        // Filtrar por ubicación
        if (!string.IsNullOrEmpty(selectedLocation))
        {
            query = query.Where(d => d.Location.Equals(selectedLocation, StringComparison.OrdinalIgnoreCase));
        }

        filteredDevices = query.ToList();
    }

    private void ApplyFilters()
    {
        ApplyLocalFilters();
    }

    private void OpenCreateModal()
    {
        createDeviceRequest = new CreateDeviceRequest();
        showCreateModal = true;
    }

    private void CloseCreateModal()
    {
        showCreateModal = false;
        createDeviceRequest = new CreateDeviceRequest();
    }

    private async Task HandleCreateDevice(CreateDeviceRequest request)
    {
        await DeviceService.CreateDeviceAsync(request);
        await LoadDevices();
        await LoadStatistics();
        ApplyFilters();
        CloseCreateModal();
    }

    private async Task OpenEditModal(int deviceId)
    {
        var device = await DeviceService.GetDeviceByIdAsync(deviceId);
        if (device != null)
        {
            updateDeviceRequest = new UpdateDeviceRequest
            {
                Id = device.Id,
                Name = device.Name,
                Type = device.Type,
                PurchaseDate = DateTime.Today,
                State = device.State,
                Location = device.Location
            };
            showEditModal = true;
        }
    }

    private void CloseEditModal()
    {
        showEditModal = false;
        updateDeviceRequest = new UpdateDeviceRequest();
    }

    private async Task HandleUpdateDevice(UpdateDeviceRequest request)
    {
        await DeviceService.UpdateDeviceAsync(request);
        await LoadDevices();
        await LoadStatistics();
        ApplyFilters();
        CloseEditModal();
    }

    private void NavigateToDetails(int deviceId)
    {
        Navigation.NavigateTo($"/inventory/{deviceId}");
    }

    // Delete methods
    private void OpenDeleteConfirmModal(int deviceId, string deviceName)
    {
        deviceIdToDelete = deviceId;
        deleteConfirmMessage = $"¿Está seguro que desea eliminar el equipo \"{deviceName}\"? Esta acción no se puede deshacer.";
        showDeleteConfirmModal = true;
    }

    private void CloseDeleteConfirmModal()
    {
        showDeleteConfirmModal = false;
        deviceIdToDelete = 0;
        deleteConfirmMessage = string.Empty;
    }

    private async Task HandleDeleteDevice()
    {
        var success = await DeviceService.DeleteDeviceAsync(deviceIdToDelete);
        if (success)
        {
            await LoadDevices();
            await LoadStatistics();
            ApplyFilters();
        }
        CloseDeleteConfirmModal();
    }
}