@* filepath: InfraGestion.Web/Features/Inventory/Pages/DeviceDetails.razor *@
@page "/inventory/{DeviceId:int}"
@using InfraGestion.Web.Features.Inventory.Models
@using InfraGestion.Web.Features.Inventory.Services
@using InfraGestion.Web.Features.Inventory.Helpers
@using InfraGestion.Web.Features.Inventory.Components
@using InfraGestion.Web.Features.Users.Components
@inject DeviceService DeviceService
@inject NavigationManager Navigation

@if (isLoading)
{
    <div class="loading-container">
        <div class="spinner"></div>
        <p>Cargando detalles del equipo...</p>
    </div>
}
else if (device == null)
{
    <div class="error-container">
        <p>No se encontró el equipo solicitado.</p>
        <button class="btn-back" @onclick="NavigateBack">Volver al inventario</button>
    </div>
}
else
{
    <div class="device-details-page">
        <!-- Header -->
        <div class="details-header">
            <div class="header-content">
                <h1 class="device-title">@device.Name</h1>
                <StatusBadge DisplayText="@OperationalStateHelper.GetStateDisplayName(device.State)" 
                             BadgeClass="@OperationalStateHelper.GetStateBadgeClass(device.State)" />
            </div>
            <p class="page-description">Ficha Técnica detallada del equipo</p>
            <div class="header-actions">
                <button class="btn-export">
                    <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path d="M74.34,85.66A8,8,0,0,1,85.66,74.34L120,108.69V24a8,8,0,0,1,16,0v84.69l34.34-34.35a8,8,0,0,1,11.32,11.32l-48,48a8,8,0,0,1-11.32,0ZM240,136v64a16,16,0,0,1-16,16H32a16,16,0,0,1-16-16V136a16,16,0,0,1,16-16H84.4a4,4,0,0,1,2.83,1.17L111,145A24,24,0,0,0,145,145l23.8-23.8A4,4,0,0,1,171.6,120H224A16,16,0,0,1,240,136Zm-40,32a12,12,0,1,0-12,12A12,12,0,0,0,200,168Z"/>
                    </svg>
                    Exportar
                </button>
                <button class="btn-edit" @onclick="OpenEditModal">
                    <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path d="M229.66,58.34l-32-32a8,8,0,0,0-11.32,0l-96,96A8,8,0,0,0,88,128v32a8,8,0,0,0,8,8h32a8,8,0,0,0,5.66-2.34l96-96A8,8,0,0,0,229.66,58.34ZM124.69,152H104V131.31l64-64L188.69,88ZM200,76.69,179.31,56,192,43.31,212.69,64ZM224,128v80a16,16,0,0,1-16,16H48a16,16,0,0,1-16-16V48A16,16,0,0,1,48,32h80a8,8,0,0,1,0,16H48V208H208V128a8,8,0,0,1,16,0Z"/>
                    </svg>
                    Editar
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="details-content">
            <!-- Left Column: Detalles Principales -->
            <div class="details-card">
                <h2 class="card-title">Detalles Principales</h2>
                <div class="details-grid">
                    <div class="detail-item">
                        <span class="detail-label">Tipo de Equipo</span>
                        <span class="detail-value">@DeviceTypeHelper.GetTypeDisplayName(device.Type)</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Número de Identificación</span>
                        <span class="detail-value device-id">@device.IdentificationNumber</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Fecha de Adquisición</span>
                        <span class="detail-value">@device.PurchaseDate.ToString("dd/MM/yyyy")</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Mantenimientos Realizados</span>
                        <span class="detail-value">@device.MaintenanceCount</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Costo total en Mantenimientos</span>
                        <span class="detail-value">@device.TotalMaintenanceCost.ToString("F2") USD</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Fecha del último mantenimiento</span>
                        <span class="detail-value">@(device.LastMaintenanceDate?.ToString("dd/MM/yyyy") ?? "N/A")</span>
                    </div>
                </div>
            </div>

            <!-- Right Column: Ubicación -->
            <div class="location-card">
                <h2 class="card-title">Ubicación</h2>
                <div class="location-info">
                    <div class="location-item">
                        <span class="location-label">Sección</span>
                        <span class="location-value">@device.Section</span>
                    </div>
                    <div class="location-item">
                        <span class="location-label">Departamento</span>
                        <span class="location-value">@device.Department</span>
                    </div>
                    <div class="location-item">
                        <span class="location-label">Responsable de Sección</span>
                        <span class="location-value">@device.SectionManager</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Historial de Mantenimientos -->
        <div class="history-section">
            <h2 class="section-title">Historial de Mantenimientos</h2>
            <div class="table-container">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>FECHA</th>
                            <th>TIPO</th>
                            <th>TÉCNICO</th>
                            <th>NOTAS</th>
                            <th>COSTO</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (device.MaintenanceHistory == null || !device.MaintenanceHistory.Any())
                        {
                            <tr>
                                <td colspan="5" class="empty-cell">
                                    No se encontraron registros de mantenimiento para este equipo
                                </td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var maintenance in device.MaintenanceHistory)
                            {
                                <tr>
                                    <td>@maintenance.Date.ToString("dd/MM/yyyy")</td>
                                    <td>@maintenance.Type.ToString()</td>
                                    <td>@maintenance.TechnicianName</td>
                                    <td>@maintenance.Description</td>
                                    <td>@maintenance.Cost.ToString("F2")</td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Registro de Traslados -->
        <div class="history-section">
            <h2 class="section-title">Registro de Traslados</h2>
            <div class="table-container">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>FECHA</th>
                            <th>ORIGEN</th>
                            <th>DESTINO</th>
                            <th>RECEPTOR</th>
                            <th>ESTADO</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (device.TransferHistory == null || !device.TransferHistory.Any())
                        {
                            <tr>
                                <td colspan="5" class="empty-cell">
                                    No se encontraron registros de traslados para este equipo
                                </td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var transfer in device.TransferHistory)
                            {
                                <tr>
                                    <td>@transfer.Date.ToString("dd/MM/yyyy")</td>
                                    <td>@transfer.SourceSectionName</td>
                                    <td>@transfer.DestinationSectionName</td>
                                    <td>@transfer.ReceiverName</td>
                                    <td>@transfer.Status</td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Solicitud de Baja -->
        <div class="history-section">
            <h2 class="section-title">Solicitud de Baja</h2>
            <div class="table-container">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>FECHA BAJA</th>
                            <th>RECEPTOR</th>
                            <th>DEPARTAMENTO RECEPTOR</th>
                            <th>RAZÓN</th>
                            <th>DESTINO FINAL</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (device.DecommissioningInfo == null)
                        {
                            <tr>
                                <td colspan="5" class="empty-cell">
                                    No se encontró solicitud de baja para este equipo
                                </td>
                            </tr>
                        }
                        else
                        {
                            <tr>
                                <td>@(device.DecommissioningInfo.DecommissioningDate?.ToString("dd/MM/yyyy") ?? "No especificado")</td>
                                <td>@device.DecommissioningInfo.ReceiverName</td>
                                <td>@GetDecommissioningReasonLabel(device.DecommissioningInfo.Reason)</td>
                                <td>@(device.DecommissioningInfo.FinalDestination ?? "No especificado")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}

<!-- Edit Device Modal -->
<Modal IsOpen="@showEditModal" Title="Editar Equipo" OnClose="@CloseEditModal">
    <DeviceFormEdit FormModel="@updateDeviceRequest" OnValidSubmit="@HandleUpdateDevice" OnCancel="@CloseEditModal" />
</Modal>

@code {
    [Parameter]
    public int DeviceId { get; set; }

    private Models.DeviceDetails? device;
    private bool isLoading = true;

    // Edit Modal
    private bool showEditModal = false;
    private UpdateDeviceRequest updateDeviceRequest = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDeviceDetails();
    }

    private async Task LoadDeviceDetails()
    {
        isLoading = true;
        device = await DeviceService.GetDeviceDetailsAsync(DeviceId);
        isLoading = false;
    }

    private void NavigateBack()
    {
        Navigation.NavigateTo("/inventory");
    }

    private string GetDecommissioningReasonLabel(DecommissioningReason reason)
    {
        return reason switch
        {
            DecommissioningReason.IrreparableTechnicalFailure => "Fallo técnico irreparable",
            DecommissioningReason.TechnologicalObsolescence => "Obsolescencia tecnológica",
            DecommissioningReason.EOL => "Fin de vida útil",
            DecommissioningReason.ExcessiveRepairCost => "Costo de reparación excesivo",
            DecommissioningReason.SeverePhysicalDamage => "Daño físico severo",
            DecommissioningReason.IncompatibilityWithNewInfrastructure => "Incompatibilidad con nueva infraestructura",
            DecommissioningReason.PlannedTechnologyUpgrade => "Actualización tecnológica planificada",
            DecommissioningReason.TheftOrLoss => "Robo o pérdida",
            DecommissioningReason.CustomerContractTermination => "Terminación de contrato",
            _ => "No especificado"
        };
    }

    // Edit Device Modal Methods
    private void OpenEditModal()
    {
        if (device != null)
        {
            updateDeviceRequest = new UpdateDeviceRequest
            {
                Id = device.Id,
                Name = device.Name,
                Type = device.Type,
                PurchaseDate = device.PurchaseDate,
                State = device.State,
                Location = device.Department
            };
            showEditModal = true;
        }
    }

    private void CloseEditModal()
    {
        showEditModal = false;
        updateDeviceRequest = new UpdateDeviceRequest();
    }

    private async Task HandleUpdateDevice(UpdateDeviceRequest request)
    {
        await DeviceService.UpdateDeviceAsync(request);
        await LoadDeviceDetails(); 
        CloseEditModal();
    }
}