@using InfraGestion.Web.Features.Inventory.Models
@using InfraGestion.Web.Features.Inventory.Helpers
@using InfraGestion.Web.Features.Inventory.Services
@using InfraGestion.Web.Features.Organization.Models
@using InfraGestion.Web.Features.Organization.Services
@using InfraGestion.Web.Features.Users.Models
@using InfraGestion.Web.Features.Users.Services
@using InfraGestion.Web.Shared.Components
@inject DecommissioningService DecommissioningService
@inject OrganizationService OrganizationService
@inject UserService UserService

<Modal IsOpen="@IsOpen" Title="@ModalTitle" OnClose="@HandleClose">
    <form class="decommissioning-form" @onsubmit="HandleSubmit" @onsubmit:preventDefault="true">
        @if (isLoading)
        {
            <div class="loading-container">
                <div class="spinner"></div>
                <p>Cargando información...</p>
            </div>
        }
        else if (EditRequest != null)
        {
            <div class="form-section">
                <!-- Device Name (Read-only) -->
                <div class="form-group full-width">
                    <label class="form-label">
                        Nombre del Equipo
                    </label>
                    <input type="text"
                           class="form-control readonly-field"
                           value="@EditRequest.DeviceName"
                           readonly
                           disabled />
                    <span class="field-hint">Este campo no es editable</span>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        Técnico Responsable <span class="required">*</span>
                    </label>
                    <input type="text"
                           class="form-control"
                           @bind="EditRequest.TechnicianName"
                           placeholder="Nombre del técnico"
                           required />
                </div>

                <div class="form-group">
                    <label class="form-label">
                        Fecha de Solicitud <span class="required">*</span>
                    </label>
                    <input type="date"
                           class="form-control"
                           @bind="EditRequest.RequestDate"
                           required />
                </div>

                <div class="form-group">
                    <label class="form-label">
                        Estado <span class="required">*</span>
                    </label>
                    <select class="form-control" @bind="EditRequest.Status" required>
                        <option value="">Seleccione un estado</option>
                        @foreach (DecommissioningStatus status in Enum.GetValues(typeof(DecommissioningStatus)))
                        {
                            <option value="@status">@DecommissioningStatusHelper.GetStatusDisplayName(status)</option>
                        }
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        Motivo de Baja <span class="required">*</span>
                    </label>
                    <select class="form-control" @bind="EditRequest.Reason" required>
                        <option value="">Seleccione un motivo</option>
                        @foreach (DecommissioningReason reason in Enum.GetValues(typeof(DecommissioningReason)))
                        {
                            <option value="@reason">@DecommissioningReasonHelper.GetReasonDisplayName(reason)</option>
                        }
                    </select>
                </div>

                <div class="form-group full-width">
                    <label class="form-label">
                        Justificación <span class="required">*</span>
                    </label>
                    <textarea class="form-control textarea"
                              @bind="EditRequest.Justification"
                              placeholder="Describa la justificación para la baja técnica"
                              rows="4"
                              required></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        Fecha de Baja
                    </label>
                    <input type="date"
                           class="form-control"
                           @bind="EditRequest.DecommissioningDate" />
                </div>

                <div class="form-group">
                    <label class="form-label">
                        Destino Final
                    </label>
                    <select class="form-control" @bind="selectedFinalDestinationId">
                        <option value="0">Seleccione un departamento</option>
                        @foreach (var department in departments)
                        {
                            <option value="@department.Id">@department.Name (@department.SectionName)</option>
                        }
                    </select>
                </div>

                <div class="form-group full-width">
                    <label class="form-label">
                        Receptor del Equipo
                    </label>
                    <select class="form-control" @bind="selectedReceiverUserId">
                        <option value="0">Seleccione un logístico</option>
                        @foreach (var logistician in logisticians)
                        {
                            <option value="@logistician.Id">@logistician.Name</option>
                        }
                    </select>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-cancel" @onclick="HandleClose">
                    Cancelar
                </button>
                <button type="submit" class="btn btn-submit" disabled="@isSubmitting">
                    @if (isSubmitting)
                    {
                        <span class="spinner-small"></span>
                        <span>Guardando...</span>
                    }
                    else
                    {
                        <span>Guardar Cambios</span>
                    }
                </button>
            </div>
        }
    </form>
</Modal>

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public int RequestId { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback<DecommissioningRequest> OnSubmit { get; set; }
    [Parameter] public EventCallback<int> OnLoadRequest { get; set; }

    private DecommissioningRequest? EditRequest { get; set; }
    private bool isLoading = false;
    private bool isSubmitting = false;
    private int currentRequestId = 0;
    
    // Dropdown data
    private List<Department> departments = new();
    private List<User> logisticians = new();
    
    // Selected values for dropdowns
    private int selectedFinalDestinationId = 0;
    private int selectedReceiverUserId = 0;

    private string ModalTitle => $"Editar Baja Técnica #{currentRequestId}";

    protected override async Task OnInitializedAsync()
    {
        await LoadDropdownData();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (IsOpen && RequestId != 0 && RequestId != currentRequestId)
        {
            currentRequestId = RequestId;
            // Load dropdown data when modal opens (if not already loaded)
            if (departments.Count == 0 || logisticians.Count == 0)
            {
                await LoadDropdownData();
            }
            await LoadRequest();
        }
    }

    private async Task LoadDropdownData()
    {
        try
        {
            // Load departments and logisticians in parallel
            var departmentsTask = OrganizationService.GetAllDepartmentsAsync();
            var logisticiansTask = UserService.GetUsersByRoleAsync("Logistician");
            
            await Task.WhenAll(departmentsTask, logisticiansTask);
            
            departments = await departmentsTask;
            logisticians = await logisticiansTask;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[ERROR] LoadDropdownData: {ex.Message}");
        }
    }

    private async Task LoadRequest()
    {
        isLoading = true;
        EditRequest = null;
        StateHasChanged();

        try
        {
            // Carga directa desde el servicio
            var request = await DecommissioningService.GetDecommissioningRequestByIdAsync(currentRequestId);
            if (request != null)
            {
                EditRequest = new DecommissioningRequest
                {
                    Id = request.Id,
                    DeviceId = request.DeviceId,
                    DeviceName = request.DeviceName,
                    TechnicianId = request.TechnicianId,
                    TechnicianName = request.TechnicianName,
                    RequestDate = request.RequestDate,
                    Status = request.Status,
                    Reason = request.Reason,
                    ReasonDescription = request.ReasonDescription,
                    Justification = request.Justification,
                    ReviewedDate = request.ReviewedDate,
                    ReviewedByUserId = request.ReviewedByUserId,
                    ReviewedByUserName = request.ReviewedByUserName,
                    // Receiver info
                    ReceiverUserId = request.ReceiverUserId,
                    ReceiverUserName = request.ReceiverUserName,
                    // Final destination
                    FinalDestinationId = request.FinalDestinationId,
                    FinalDestinationName = request.FinalDestinationName,
                    DecommissioningDate = request.DecommissioningDate
                };
                
                // Initialize dropdown selections from loaded data
                selectedFinalDestinationId = request.FinalDestinationId ?? 0;
                selectedReceiverUserId = request.ReceiverUserId ?? 0;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading request: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    public void SetRequest(DecommissioningRequest request)
    {
        EditRequest = new DecommissioningRequest
        {
            Id = request.Id,
            DeviceId = request.DeviceId,
            DeviceName = request.DeviceName,
            TechnicianId = request.TechnicianId,
            TechnicianName = request.TechnicianName,
            RequestDate = request.RequestDate,
            Status = request.Status,
            Reason = request.Reason,
            ReasonDescription = request.ReasonDescription,
            Justification = request.Justification,
            ReviewedDate = request.ReviewedDate,
            ReviewedByUserId = request.ReviewedByUserId,
            ReviewedByUserName = request.ReviewedByUserName,
            // Receiver info
            ReceiverUserId = request.ReceiverUserId,
            ReceiverUserName = request.ReceiverUserName,
            // Final destination
            FinalDestinationId = request.FinalDestinationId,
            FinalDestinationName = request.FinalDestinationName,
            DecommissioningDate = request.DecommissioningDate
        };
        
        // Initialize dropdown selections
        selectedFinalDestinationId = request.FinalDestinationId ?? 0;
        selectedReceiverUserId = request.ReceiverUserId ?? 0;
        
        StateHasChanged();
    }

    private async Task HandleSubmit()
    {
        if (isSubmitting || EditRequest == null) return;

        isSubmitting = true;
        
        // Update EditRequest with selected dropdown values before submit
        // Note: IDs can be negative in the database, so we check != 0 instead of > 0
        Console.WriteLine($"[DEBUG] Submitting DecommissioningFormEdit - selectedFinalDestinationId={selectedFinalDestinationId}, selectedReceiverUserId={selectedReceiverUserId}");
        if (selectedFinalDestinationId != 0)
        {
            EditRequest.FinalDestinationId = selectedFinalDestinationId;
            var selectedDepartment = departments.FirstOrDefault(d => d.Id == selectedFinalDestinationId);
            EditRequest.FinalDestinationName = selectedDepartment?.Name;
        }
        else
        {
            EditRequest.FinalDestinationId = null;
            EditRequest.FinalDestinationName = null;
        }
        
        if (selectedReceiverUserId != 0)
        {
            EditRequest.ReceiverUserId = selectedReceiverUserId;
            var selectedLogistician = logisticians.FirstOrDefault(l => l.Id == selectedReceiverUserId);
            EditRequest.ReceiverUserName = selectedLogistician?.Name;
        }
        else
        {
            EditRequest.ReceiverUserId = null;
            EditRequest.ReceiverUserName = null;
        }
        
        Console.WriteLine($"[DEBUG] EditRequest to submit: Id={EditRequest.Id}, DeviceId={EditRequest.DeviceId}, FinalDestinationId={EditRequest.FinalDestinationId}, ReceiverUserId={EditRequest.ReceiverUserId}, FinalDestinationName={EditRequest.FinalDestinationName}, ReceiverUserName={EditRequest.ReceiverUserName}");
        await OnSubmit.InvokeAsync(EditRequest);
        isSubmitting = false;
    }

    private async Task HandleClose()
    {
        if (!isSubmitting)
        {
            EditRequest = null;
            currentRequestId = 0;
            selectedFinalDestinationId = 0;
            selectedReceiverUserId = 0;
            await OnClose.InvokeAsync();
        }
    }
}
