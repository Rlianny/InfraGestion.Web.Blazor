@page "/manager/technicians"
@using InfraGestion.Web.Features.Technicians.Models
@using InfraGestion.Web.Features.Technicians.Services
@using InfraGestion.Web.Features.Technicians.Helpers
@using InfraGestion.Web.Features.Organization.Services
@using InfraGestion.Web.Features.Auth.Services
@inject TechnicianService TechnicianService
@inject OrganizationService OrganizationService
@inject AuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Equipo Técnico - InfraCom</PageTitle>

<div class="technicians-page">
    <!-- Header -->
    <PageHeader Title="Equipo Técnico" Description="Personal técnico asignado a su sección" />

    <!-- Filters -->
    <FilterBar>
        <SearchBox>
            <SearchBox @bind-Value="searchTerm" Placeholder="Buscar por nombre, especialidad ..." OnSearch="HandleSearch" />
        </SearchBox>
        <Filters>
            <FilterSelect @bind-Value="selectedSpecialty" OnChange="HandleFilterChange">
                <option value="">Especialidad: Todos</option>
                @foreach (var spec in specialties)
                {
                    <option value="@spec">@spec</option>
                }
            </FilterSelect>

            <FilterSelect @bind-Value="selectedStatus" OnChange="HandleFilterChange">
                <option value="">Estado: Todos</option>
                <option value="Active">Activo</option>
                <option value="Inactive">Inactivo</option>
                <option value="OnLeave">De Permiso</option>
            </FilterSelect>

            <ExportButton Text="Exportar" />
        </Filters>
    </FilterBar>

    <!-- Cards Grid -->
    <div class="cards-container">
        @if (isLoading)
        {
            <div class="loading-state">
                <div class="spinner"></div>
                <span>Cargando datos...</span>
            </div>
        }
        else if (filteredTechnicians == null || !filteredTechnicians.Any())
        {
            <div class="empty-state">
                <svg class="empty-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M117.25,157.92a60,60,0,1,0-66.5,0A95.83,95.83,0,0,0,3.53,195.63a8,8,0,1,0,13.4,8.74,80,80,0,0,1,134.14,0,8,8,0,0,0,13.4-8.74A95.83,95.83,0,0,0,117.25,157.92ZM40,108a44,44,0,1,1,44,44A44.05,44.05,0,0,1,40,108Zm210.14,98.7a8,8,0,0,1-11.07-2.33A79.83,79.83,0,0,0,172,168a8,8,0,0,1,0-16,44,44,0,1,0-16.34-84.87,8,8,0,1,1-5.94-14.85,60,60,0,0,1,55.53,105.64,95.83,95.83,0,0,1,47.22,37.71A8,8,0,0,1,250.14,206.7Z" />
                </svg>
                <p>No se encontraron técnicos que coincidan con los filtros aplicados</p>
            </div>
        }
        else
        {
            @foreach (var technician in filteredTechnicians)
            {
                <div class="technician-card">
                    <div class="card-header">
                        <div class="avatar-container">
                            <img src="@TechnicianPhotoHelper.GetPhotoUrl(technician.PhotoUrl, technician.Id, technician.Name)" 
                                 alt="@technician.Name" class="avatar" 
                                 onerror="this.src='/images/techs/tech01.png'" />
                        </div>
                        <div class="technician-info">
                            <h3 class="technician-name">@technician.Name</h3>
                            <p class="technician-specialty">@technician.Specialty</p>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <div class="status-container">
                            <span class="status-badge @GetStatusClass(technician.Status)">
                                <span class="status-dot"></span>
                                @GetStatusText(technician.Status)
                            </span>
                        </div>
                        
                        <div class="rating-container">
                            <span class="rating-label">Promedio de valoraciones: (@technician.Rating.ToString("0.0", System.Globalization.CultureInfo.InvariantCulture)/5)</span>
                            <div class="rating-bar">
                                <div class="rating-fill" style="width: @((technician.Rating / 5 * 100).ToString("0", System.Globalization.CultureInfo.InvariantCulture))%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-footer">
                        <button class="btn-view-profile" @onclick="() => ViewProfile(technician.Id)">
                            <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path d="M213.66,82.34l-56-56A8,8,0,0,0,152,24H56A16,16,0,0,0,40,40V216a16,16,0,0,0,16,16H200a16,16,0,0,0,16-16V88A8,8,0,0,0,213.66,82.34ZM160,51.31,188.69,80H160ZM200,216H56V40h88V88a8,8,0,0,0,8,8h48V216Z" />
                            </svg>
                            Ver Perfil
                        </button>
                        
                        <!-- Manager only has rate button, no bonus/penalty -->
                        <button class="btn-action btn-rate" @onclick="() => HandleRate(technician.Id)" title="Valorar">
                            <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path d="M234.29,114.85l-45,38.83L203,211.75a16.4,16.4,0,0,1-24.5,17.82L128,198.49,77.47,229.57A16.4,16.4,0,0,1,53,211.75l13.76-58.07-45-38.83A16.46,16.46,0,0,1,31.08,86l59-4.76,22.76-55.08a16.36,16.36,0,0,1,30.27,0l22.75,55.08,59,4.76a16.46,16.46,0,0,1,9.37,28.86Z" />
                            </svg>
                            Valorar
                        </button>
                    </div>
                </div>
            }
        }
    </div>
</div>

@code {
    // Data
    private List<Technician> allTechnicians = new();
    private List<Technician> filteredTechnicians = new();
    private List<string> specialties = new();
    private bool isLoading = true;
    private int currentSectionId = 0;
    private string currentSectionName = string.Empty;

    // Filters
    private string searchTerm = string.Empty;
    private string selectedSpecialty = string.Empty;
    private string selectedStatus = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadSectionInfo();
        await LoadData();
    }

    private async Task LoadSectionInfo()
    {
        try
        {
            var currentUser = await AuthService.GetCurrentUserAsync();
            if (currentUser != null)
            {
                currentSectionId = await OrganizationService.GetSectionIdByDepartmentAsync(currentUser.DepartmentId);
                if (currentSectionId != 0)
                {
                    var section = await OrganizationService.GetSectionByIdAsync(currentSectionId);
                    currentSectionName = section?.Name ?? string.Empty;
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading section info: {ex.Message}");
        }
    }

    private async Task LoadData()
    {
        isLoading = true;
        try
        {
            var allTechs = await TechnicianService.GetAllTechniciansAsync();
            
            // Filter technicians by current section
            if (!string.IsNullOrEmpty(currentSectionName))
            {
                allTechnicians = allTechs
                    .Where(t => t.Section.Equals(currentSectionName, StringComparison.OrdinalIgnoreCase))
                    .ToList();
                Console.WriteLine($"[DEBUG] ManagerTechnicians - filtered {allTechnicians.Count} technicians for section '{currentSectionName}'");
            }
            else
            {
                // Fallback: show all technicians if section not determined
                allTechnicians = allTechs;
                Console.WriteLine($"[DEBUG] ManagerTechnicians - section unknown, showing all {allTechnicians.Count} technicians");
            }
            
            specialties = allTechnicians
                .Select(t => t.Specialty)
                .Where(s => !string.IsNullOrEmpty(s))
                .Distinct()
                .OrderBy(s => s)
                .ToList();
                
            ApplyFilters();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading technicians: {ex.Message}");
            allTechnicians = new List<Technician>();
            filteredTechnicians = new List<Technician>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void HandleSearch()
    {
        ApplyFilters();
    }

    private void HandleFilterChange()
    {
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        var query = allTechnicians.AsEnumerable();

        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            query = query.Where(t =>
                t.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                t.Specialty.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrEmpty(selectedSpecialty))
        {
            query = query.Where(t => t.Specialty == selectedSpecialty);
        }

        if (!string.IsNullOrEmpty(selectedStatus))
        {
            var status = Enum.Parse<TechnicianStatus>(selectedStatus);
            query = query.Where(t => t.Status == status);
        }

        filteredTechnicians = query.ToList();
    }

    private void ViewProfile(int technicianId)
    {
        Navigation.NavigateTo($"/manager/technicians/{technicianId}");
    }

    private void HandleRate(int technicianId)
    {
        // TODO: Implement rating functionality
        Console.WriteLine($"Rating technician {technicianId}");
    }

    private string GetStatusClass(TechnicianStatus status) => status switch
    {
        TechnicianStatus.Active => "status-active",
        TechnicianStatus.Inactive => "status-inactive",
        TechnicianStatus.OnLeave => "status-onleave",
        _ => "status-inactive"
    };

    private string GetStatusText(TechnicianStatus status) => status switch
    {
        TechnicianStatus.Active => "Activo",
        TechnicianStatus.Inactive => "Inactivo",
        TechnicianStatus.OnLeave => "De Permiso",
        _ => "Desconocido"
    };
}
