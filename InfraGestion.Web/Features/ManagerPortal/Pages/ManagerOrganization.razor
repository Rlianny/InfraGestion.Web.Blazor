@page "/manager/organization"
@using InfraGestion.Web.Features.Organization.Models
@using InfraGestion.Web.Features.Organization.Services
@using InfraGestion.Web.Features.Organization.Helpers
@using InfraGestion.Web.Features.Auth.Services
@inject OrganizationService OrganizationService
@inject AuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Organización - Responsable de Sección</PageTitle>

<div class="organization-page">
    <!-- Header -->
    <PageHeader Title="Organización" Description="Departamentos de la sección">
        <Actions>
            <ExportButton Text="Exportar" OnClick="ExportData" />
        </Actions>
    </PageHeader>

    <!-- Filters -->
    <FilterBar>
        <SearchBox>
            <SearchBox @bind-Value="searchTerm" Placeholder="Buscar por nombre ..." OnSearch="HandleSearch" />
        </SearchBox>
        <Filters>
            <FilterSelect @bind-Value="selectedStatus" OnChange="HandleFilterChange">
                <option value="">Estado: Todos</option>
                <option value="Active">Activo</option>
                <option value="Inactive">Inactivo</option>
            </FilterSelect>
        </Filters>
    </FilterBar>

    <!-- Table -->
    <DataTable TItem="Department" Items="filteredDepartments" IsLoading="isLoading" ColumnCount="3"
               EmptyText="No se encontraron departamentos">
        <HeaderTemplate>
            <th>Departamento</th>
            <th>Sección</th>
            <th>Estado</th>
        </HeaderTemplate>
        <RowTemplate Context="dept">
            <td class="department-cell">@dept.Name</td>
            <td class="section-cell">@dept.SectionName</td>
            <td>
                <span class="status-badge @OrganizationStatusHelper.GetStatusBadgeClass(dept.Status)">
                    <span class="status-dot"></span>
                    @OrganizationStatusHelper.GetStatusDisplayName(dept.Status)
                </span>
            </td>
        </RowTemplate>
    </DataTable>
</div>

@code {
    private bool isLoading = true;
    private string searchTerm = string.Empty;
    private string selectedStatus = string.Empty;
    private int currentSectionId = 0;
    
    private List<Department> allDepartments = new();
    private List<Department> filteredDepartments = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadSectionInfo();
        await LoadData();
    }

    private async Task LoadSectionInfo()
    {
        try
        {
            var currentUser = await AuthService.GetCurrentUserAsync();
            if (currentUser != null)
            {
                currentSectionId = await OrganizationService.GetSectionIdByDepartmentAsync(currentUser.DepartmentId);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading section info: {ex.Message}");
        }
    }

    private async Task LoadData()
    {
        try
        {
            isLoading = true;
            
            if (currentSectionId != 0)
            {
                // Load only departments from the manager's section
                allDepartments = await OrganizationService.GetDepartmentsBySectionAsync(currentSectionId);
            }
            else
            {
                // Fallback: load all departments if section could not be determined
                allDepartments = await OrganizationService.GetAllDepartmentsAsync();
            }
            
            ApplyFilters();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading data: {ex.Message}");
            allDepartments = new List<Department>();
            filteredDepartments = new List<Department>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void HandleSearch()
    {
        ApplyFilters();
    }

    private void HandleFilterChange()
    {
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        filteredDepartments = allDepartments;

        // Filter by search term
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            filteredDepartments = filteredDepartments
                .Where(d => d.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }

        // Filter by status
        if (!string.IsNullOrEmpty(selectedStatus))
        {
            if (Enum.TryParse<OrganizationStatus>(selectedStatus, out var status))
            {
                filteredDepartments = filteredDepartments
                    .Where(d => d.Status == status)
                    .ToList();
            }
        }
    }

    private void ExportData()
    {
        Console.WriteLine("Exportando datos de organización...");
    }
}
