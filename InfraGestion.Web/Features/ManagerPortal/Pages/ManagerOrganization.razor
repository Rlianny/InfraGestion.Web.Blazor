@page "/manager/organization"
@using InfraGestion.Web.Features.Organization.Models
@using InfraGestion.Web.Features.Organization.Services
@using InfraGestion.Web.Features.Organization.Helpers
@using InfraGestion.Web.Features.Auth.Services
@inject OrganizationService OrganizationService
@inject AuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Organización - Responsable de Sección</PageTitle>

<div class="organization-page">
    <!-- Header -->
    <div class="page-header-wrapper">
        <div class="page-header">
            <div class="header-text">
                <h1 class="page-title">Organización</h1>
                <p class="page-description">Departamentos de la sección</p>
            </div>
            <div class="header-actions">
                <button class="btn-export" @onclick="ExportData">
                    <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path d="M74.34,85.66A8,8,0,0,1,85.66,74.34L120,108.69V24a8,8,0,0,1,16,0v84.69l34.34-34.35a8,8,0,0,1,11.32,11.32l-48,48a8,8,0,0,1-11.32,0ZM240,136v64a16,16,0,0,1-16,16H32a16,16,0,0,1-16-16V136a16,16,0,0,1,16-16H84.4a4,4,0,0,1,2.83,1.17L111,145A24,24,0,0,0,145,145l23.8-23.8A4,4,0,0,1,171.6,120H224A16,16,0,0,1,240,136Zm-40,32a12,12,0,1,0-12,12A12,12,0,0,0,200,168Z" />
                    </svg>
                    Exportar
                </button>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filters-container">
        <div class="search-box">
            <svg class="search-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z" />
            </svg>
            <input type="text" class="search-input" placeholder="Buscar por nombre ..." @bind="searchTerm"
                @bind:event="oninput" @bind:after="HandleSearch" />
        </div>

        <div class="filter-group">
            <select class="filter-select" @bind="selectedStatus" @bind:after="HandleFilterChange">
                <option value="">Estado: Todos</option>
                <option value="Active">Activo</option>
                <option value="Inactive">Inactivo</option>
            </select>
        </div>
    </div>

    <!-- Table -->
    <div class="table-container">
        <table class="organization-table">
            <thead>
                <tr>
                    <th>Departamento</th>
                    <th>Sección</th>
                    <th>Estado</th>
                </tr>
            </thead>
            <tbody>
                @if (isLoading)
                {
                    <tr>
                        <td colspan="3" class="loading-cell">
                            <div class="spinner"></div>
                            <span>Cargando datos...</span>
                        </td>
                    </tr>
                }
                else if (filteredDepartments == null || !filteredDepartments.Any())
                {
                    <tr>
                        <td colspan="3" class="empty-cell">
                            <svg class="empty-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z" />
                            </svg>
                            <p>No se encontraron departamentos</p>
                        </td>
                    </tr>
                }
                else
                {
                    @foreach (var dept in filteredDepartments)
                    {
                        <tr>
                            <td class="department-cell">@dept.Name</td>
                            <td class="section-cell">@dept.SectionName</td>
                            <td>
                                <span class="status-badge @OrganizationStatusHelper.GetStatusBadgeClass(dept.Status)">
                                    <span class="status-dot"></span>
                                    @OrganizationStatusHelper.GetStatusDisplayName(dept.Status)
                                </span>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

@code {
    private bool isLoading = true;
    private string searchTerm = string.Empty;
    private string selectedStatus = string.Empty;
    
    private List<Department> allDepartments = new();
    private List<Department> filteredDepartments = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            isLoading = true;
            
            // Get current user's section
            var user = await AuthService.GetCurrentUserAsync();
            
            // Load departments (in real implementation, filter by section)
            allDepartments = await OrganizationService.GetAllDepartmentsAsync();
            
            ApplyFilters();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading data: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void HandleSearch()
    {
        ApplyFilters();
    }

    private void HandleFilterChange()
    {
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        filteredDepartments = allDepartments;

        // Filter by search term
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            filteredDepartments = filteredDepartments
                .Where(d => d.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }

        // Filter by status
        if (!string.IsNullOrEmpty(selectedStatus))
        {
            if (Enum.TryParse<OrganizationStatus>(selectedStatus, out var status))
            {
                filteredDepartments = filteredDepartments
                    .Where(d => d.Status == status)
                    .ToList();
            }
        }
    }

    private void ExportData()
    {
        Console.WriteLine("Exportando datos de organización...");
    }
}
