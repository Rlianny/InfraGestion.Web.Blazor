@page "/manager/transfers"
@using InfraGestion.Web.Features.Transfers.Models
@using InfraGestion.Web.Features.Transfers.Services
@inject TransferService TransferService
@inject NavigationManager Navigation

<PageTitle>Traslados - InfraCom</PageTitle>

<div class="transfers-page">
    <!-- Header -->
    <PageHeader Title="Traslados de Equipos" Description="Registro de traslados de equipos en su secciÃ³n" />

    <!-- Filters -->
    <FilterBar>
        <SearchBox>
            <SearchBox @bind-Value="searchTerm" Placeholder="Buscar por nombre ..." OnSearch="HandleSearch" />
        </SearchBox>
        <Filters>
            <FilterSelect @bind-Value="selectedDateFilter" OnChange="HandleFilterChange">
                <option value="">Fecha: Todos</option>
                <option value="2024">2024</option>
                <option value="2023">2023</option>
                <option value="2022">2022</option>
                <option value="2021">2021</option>
            </FilterSelect>

            <ExportButton Text="Exportar" />
        </Filters>
    </FilterBar>

    <!-- Table -->
    <DataTable TItem="Transfer" Items="filteredTransfers" IsLoading="isLoading" ColumnCount="6"
               EmptyText="No se encontraron registros que coincidan con los filtros aplicados">
        <HeaderTemplate>
            <th>ID de equipo</th>
            <th>Nombre del equipo</th>
            <th>Origen</th>
            <th>Destino</th>
            <th>Fecha</th>
            <th>Receptor</th>
        </HeaderTemplate>
        <RowTemplate Context="transfer">
            <td class="device-id-cell">DEV@(transfer.DeviceId.ToString("D3"))</td>
            <td class="device-name-cell">@transfer.DeviceName</td>
            <td class="origin-cell">@transfer.SourceSectionName</td>
            <td class="destination-cell">@transfer.DestinationSectionName</td>
            <td class="date-cell">@transfer.TransferDate.ToString("dd/MM/yyyy")</td>
            <td class="receiver-cell">@transfer.DeviceReceiverName</td>
        </RowTemplate>
    </DataTable>
</div>

@code {
    // Data
    private List<Transfer> allTransfers = new();
    private List<Transfer> filteredTransfers = new();
    private bool isLoading = true;

    // Filters
    private string searchTerm = string.Empty;
    private string selectedDateFilter = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadTransfers();
    }

    private async Task LoadTransfers()
    {
        isLoading = true;
        allTransfers = await TransferService.GetAllTransfersAsync();
        filteredTransfers = allTransfers;
        isLoading = false;
    }

    private void HandleSearch()
    {
        ApplyFilters();
    }

    private void HandleFilterChange()
    {
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        var query = allTransfers.AsEnumerable();

        // Search filter
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            query = query.Where(t =>
                t.DeviceName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                t.SourceSectionName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                t.DestinationSectionName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                t.DeviceReceiverName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));
        }

        // Date filter
        if (!string.IsNullOrEmpty(selectedDateFilter) && int.TryParse(selectedDateFilter, out int year))
        {
            query = query.Where(t => t.TransferDate.Year == year);
        }

        filteredTransfers = query.ToList();
    }
}
