@page "/manager/transfers"
@using InfraGestion.Web.Features.Transfers.Models
@using InfraGestion.Web.Features.Transfers.Services
@using InfraGestion.Web.Features.Organization.Services
@using InfraGestion.Web.Features.Auth.Services
@inject TransferService TransferService
@inject OrganizationService OrganizationService
@inject AuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Traslados - InfraCom</PageTitle>

<div class="transfers-page">
    <!-- Header -->
    <PageHeader Title="Traslados de Equipos" Description="Registro de traslados de equipos en su secciÃ³n" />

    <!-- Filters -->
    <FilterBar>
        <SearchBox>
            <SearchBox @bind-Value="searchTerm" Placeholder="Buscar por nombre ..." OnSearch="HandleSearch" />
        </SearchBox>
        <Filters>
            <FilterSelect @bind-Value="selectedDateFilter" OnChange="HandleFilterChange">
                <option value="">Fecha: Todos</option>
                <option value="2024">2024</option>
                <option value="2023">2023</option>
                <option value="2022">2022</option>
                <option value="2021">2021</option>
            </FilterSelect>

            <ExportButton Text="Exportar" />
        </Filters>
    </FilterBar>

    <!-- Table -->
    <DataTable TItem="Transfer" Items="filteredTransfers" IsLoading="isLoading" ColumnCount="6"
               EmptyText="No se encontraron registros que coincidan con los filtros aplicados">
        <HeaderTemplate>
            <th>ID de equipo</th>
            <th>Nombre del equipo</th>
            <th>Origen</th>
            <th>Destino</th>
            <th>Fecha</th>
            <th>Receptor</th>
        </HeaderTemplate>
        <RowTemplate Context="transfer">
            <td class="device-id-cell">DEV@(transfer.DeviceId.ToString("D3"))</td>
            <td class="device-name-cell">@transfer.DeviceName</td>
            <td class="origin-cell">@transfer.SourceSectionName</td>
            <td class="destination-cell">@transfer.DestinationSectionName</td>
            <td class="date-cell">@transfer.TransferDate.ToString("dd/MM/yyyy")</td>
            <td class="receiver-cell">@transfer.DeviceReceiverName</td>
        </RowTemplate>
    </DataTable>
</div>

@code {
    // Data
    private List<Transfer> allTransfers = new();
    private List<Transfer> filteredTransfers = new();
    private bool isLoading = true;
    private int currentSectionId = 0;
    private string currentSectionName = string.Empty;

    // Filters
    private string searchTerm = string.Empty;
    private string selectedDateFilter = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadSectionInfo();
        await LoadTransfers();
    }

    private async Task LoadSectionInfo()
    {
        try
        {
            var currentUser = await AuthService.GetCurrentUserAsync();
            if (currentUser != null)
            {
                currentSectionId = await OrganizationService.GetSectionIdByDepartmentAsync(currentUser.DepartmentId);
                if (currentSectionId != 0)
                {
                    var section = await OrganizationService.GetSectionByIdAsync(currentSectionId);
                    currentSectionName = section?.Name ?? string.Empty;
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading section info: {ex.Message}");
        }
    }

    private async Task LoadTransfers()
    {
        isLoading = true;
        try
        {
            var allData = await TransferService.GetAllTransfersAsync();
            Console.WriteLine($"[DEBUG] ManagerTransfers - loaded {allData.Count} total transfers");
            
            // Filter transfers by current section (source or destination)
            if (currentSectionId != 0 || !string.IsNullOrEmpty(currentSectionName))
            {
                allTransfers = allData
                    .Where(t => 
                        t.SourceSectionId == currentSectionId || 
                        t.DestinationSectionId == currentSectionId ||
                        (!string.IsNullOrEmpty(currentSectionName) && (
                            t.SourceSectionName.Equals(currentSectionName, StringComparison.OrdinalIgnoreCase) ||
                            t.DestinationSectionName.Equals(currentSectionName, StringComparison.OrdinalIgnoreCase))))
                    .OrderByDescending(t => t.TransferDate)
                    .ToList();
            }
            else
            {
                // Fallback: show all transfers
                allTransfers = allData.OrderByDescending(t => t.TransferDate).ToList();
            }
            
            Console.WriteLine($"[DEBUG] ManagerTransfers - filtered to {allTransfers.Count} transfers for section '{currentSectionName}' (id={currentSectionId})");
            filteredTransfers = allTransfers;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading transfers: {ex.Message}");
            allTransfers = new List<Transfer>();
            filteredTransfers = new List<Transfer>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void HandleSearch()
    {
        ApplyFilters();
    }

    private void HandleFilterChange()
    {
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        var query = allTransfers.AsEnumerable();

        // Search filter
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            query = query.Where(t =>
                t.DeviceName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                t.SourceSectionName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                t.DestinationSectionName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                t.DeviceReceiverName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));
        }

        // Date filter
        if (!string.IsNullOrEmpty(selectedDateFilter) && int.TryParse(selectedDateFilter, out int year))
        {
            query = query.Where(t => t.TransferDate.Year == year);
        }

        filteredTransfers = query.ToList();
    }
}
