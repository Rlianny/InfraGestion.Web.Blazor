@page "/director/dashboard"
@using InfraGestion.Web.Features.DirectorPortal.DTOs
@using InfraGestion.Web.Features.DirectorPortal.Services
@using InfraGestion.Web.Features.Inventory.Helpers
@inject DirectorDashboardService DashboardService
@inject NavigationManager Navigation

<PageTitle>Dashboard Director - InfraCom</PageTitle>

<div class="director-dashboard">
    <!-- Header -->
    <div class="page-header-wrapper">
        <div class="page-header">
            <div class="header-text">
                <h1 class="page-title">Dashboard</h1>
                <p class="page-description">Vista Estratégica</p>
            </div>
            <button class="btn-export" @onclick="ExportDashboard">
                <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M74.34,85.66A8,8,0,0,1,85.66,74.34L120,108.69V24a8,8,0,0,1,16,0v84.69l34.34-34.35a8,8,0,0,1,11.32,11.32l-48,48a8,8,0,0,1-11.32,0ZM240,136v64a16,16,0,0,1-16,16H32a16,16,0,0,1-16-16V136a16,16,0,0,1,16-16H84.4a4,4,0,0,1,2.83,1.17L111,145A24,24,0,0,0,145,145l23.8-23.8A4,4,0,0,1,171.6,120H224A16,16,0,0,1,240,136Zm-40,32a12,12,0,1,0-12,12A12,12,0,0,0,200,168Z" />
                </svg>
                Exportar
            </button>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="loading-container">
            <div class="spinner"></div>
            <p>Cargando datos del dashboard...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="error-container">
            <p class="error-message">@errorMessage</p>
            <button class="btn-retry" @onclick="LoadDashboardData">Reintentar</button>
        </div>
    }
    else
    {
        <!-- Summary Stats Row -->
        <div class="stats-row">
            <div class="stat-card">
                <span class="stat-value">@dashboardData.Summary.TotalAssets</span>
                <span class="stat-label">Total de activos</span>
            </div>
            <div class="stat-card">
                <span class="stat-value">@dashboardData.Summary.TotalDepartments</span>
                <span class="stat-label">Departamentos</span>
            </div>
            <div class="stat-card">
                <span class="stat-value">@dashboardData.Summary.QuarterlyDecommissions</span>
                <span class="stat-label">Bajas (trimestre)</span>
            </div>
            <div class="stat-card">
                <span class="stat-value">$ @dashboardData.Summary.MaintenanceCost.ToString("N0")</span>
                <span class="stat-label">Costo Mantenimiento</span>
            </div>
        </div>

    <!-- Feature Cards Grid -->
    <div class="cards-grid">
        <!-- Visión General del Inventario -->
        <div class="feature-card">
            <div class="card-header">
                <h2 class="card-title">Visión General del Inventario</h2>
                <div class="card-icon icon-blue">
                    <svg viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path d="M224,48H32A16,16,0,0,0,16,64V88a16,16,0,0,0,16,16v88a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V104a16,16,0,0,0,16-16V64A16,16,0,0,0,224,48Zm-72,96H104a8,8,0,0,1,0-16h48a8,8,0,0,1,0,16Zm72-56H32V64H224V88Z" />
                    </svg>
                </div>
            </div>
            <div class="card-content inventory-content">
                <div class="inventory-stats">
                    <div class="inventory-stat">
                        <span class="inventory-value text-blue">@dashboardData.InventoryOverview.OperationalDevices</span>
                        <span class="inventory-label">Equipos Operativos</span>
                    </div>
                    <div class="inventory-stat">
                        <span class="inventory-value text-orange">@dashboardData.InventoryOverview.DevicesInMaintenance</span>
                        <span class="inventory-label">En Mantenimiento</span>
                    </div>
                </div>
            </div>
            <button class="btn-card btn-outline btn-outline-blue" @onclick="NavigateToInventory">
                Ver Inventario
            </button>
        </div>

        <!-- Análisis de Costos -->
        <div class="feature-card">
            <div class="card-header">
                <h2 class="card-title">Análisis de Costos</h2>
                <div class="card-icon icon-green">
                    <svg viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path d="M204,168a52.06,52.06,0,0,1-52,52H140v12a12,12,0,0,1-24,0V220H104a52.06,52.06,0,0,1-52-52,12,12,0,0,1,24,0,28,28,0,0,0,28,28h48a28,28,0,0,0,0-56H112a52,52,0,0,1,0-104h4V24a12,12,0,0,1,24,0V36h4a52.06,52.06,0,0,1,52,52,12,12,0,0,1-24,0,28,28,0,0,0-28-28H112a28,28,0,0,0,0,56h40A52.06,52.06,0,0,1,204,168Z" />
                    </svg>
                </div>
            </div>
            <div class="card-content cost-content">
                <div class="cost-row">
                    <span class="cost-label">Costo Mensual Promedio:</span>
                    <span class="cost-value">$ @dashboardData.CostAnalysis.MonthlyAverageCost.ToString("N0") US</span>
                </div>
                <div class="cost-row">
                    <span class="cost-label">Tendendia vs mes anterior:</span>
                    <span class="cost-trend @GetTrendClass(dashboardData.CostAnalysis.TrendPercentage)">
                        @FormatTrend(dashboardData.CostAnalysis.TrendPercentage)
                    </span>
                </div>
            </div>
            <button class="btn-card btn-primary" @onclick="NavigateToReports">
                Ver Más Reportes
            </button>
        </div>

        <!-- Análisis de Bajas -->
        <div class="feature-card">
            <div class="card-header">
                <h2 class="card-title">Análisis de Bajas</h2>
                <div class="card-icon icon-red">
                    <svg viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path d="M223.16,68.42l-16-32A8,8,0,0,0,200,32H56a8,8,0,0,0-7.16,4.42l-16,32A8.08,8.08,0,0,0,32,72V208a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V72A8.08,8.08,0,0,0,223.16,68.42Zm-57.5,89.24-32,32a8,8,0,0,1-11.32,0l-32-32a8,8,0,0,1,11.32-11.32L120,164.69V104a8,8,0,0,1,16,0v60.69l18.34-18.35a8,8,0,0,1,11.32,11.32ZM52.94,64l8-16H195.06l8,16Z" />
                    </svg>
                </div>
            </div>
            <div class="card-content decommission-content">
                <p class="content-subtitle">Principales causas:</p>
                <div class="causes-list">
                    @foreach (var cause in dashboardData.DecommissionAnalysis.TopCauses)
                    {
                        var maxCount = dashboardData.DecommissionAnalysis.TopCauses.Max(c => c.Count);
                        var percentage = maxCount > 0 ? (cause.Count * 100.0 / maxCount) : 0;
                        <div class="cause-item">
                            <div class="cause-info">
                                <span class="cause-name">@DecommissioningReasonHelper.GetReasonDisplayName(cause.Reason)</span>
                                <span class="cause-count">@cause.Count</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill progress-red" style="width: @percentage%"></div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Efectividad por departamento -->
        <div class="feature-card">
            <div class="card-header">
                <h2 class="card-title">Efectividad por departamento</h2>
                <div class="card-icon icon-orange">
                    <svg viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path d="M232,224H208V32h8a8,8,0,0,0,0-16H40a8,8,0,0,0,0,16h8V224H24a8,8,0,0,0,0,16H232a8,8,0,0,0,0-16ZM88,56h24a8,8,0,0,1,0,16H88a8,8,0,0,1,0-16Zm0,40h24a8,8,0,0,1,0,16H88a8,8,0,0,1,0-16Zm-8,48a8,8,0,0,1,8-8h24a8,8,0,0,1,0,16H88A8,8,0,0,1,80,144Zm72,80H104V184h48Zm16-72H144a8,8,0,0,1,0-16h24a8,8,0,0,1,0,16Zm0-40H144a8,8,0,0,1,0-16h24a8,8,0,0,1,0,16Zm0-40H144a8,8,0,0,1,0-16h24a8,8,0,0,1,0,16Z" />
                    </svg>
                </div>
            </div>
            <div class="card-content effectiveness-content">
                <div class="effectiveness-list">
                    @{
                        var maxMaintenance = dashboardData.DepartmentEffectiveness.Departments.Any() 
                            ? dashboardData.DepartmentEffectiveness.Departments.Max(d => d.MaintenanceCount) 
                            : 1;
                    }
                    @foreach (var dept in dashboardData.DepartmentEffectiveness.Departments)
                    {
                        var barPercentage = maxMaintenance > 0 ? (dept.MaintenanceCount * 100.0 / maxMaintenance) : 0;
                        <div class="effectiveness-item">
                            <div class="effectiveness-info">
                                <span class="dept-name">@dept.DepartmentName</span>
                                <span class="dept-percentage">@dept.MaintenanceCount</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill @GetMaintenanceCountColor(dept.MaintenanceCount, maxMaintenance)" style="width: @barPercentage%"></div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
    }
</div>

@code {
    private DirectorDashboardDto dashboardData = new();
    private bool isLoading = true;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        try
        {
            isLoading = true;
            errorMessage = null;
            var data = await DashboardService.GetDashboardInfoAsync();
            if (data != null)
            {
                dashboardData = data;
            }
            else
            {
                errorMessage = "Error al cargar los datos del dashboard";
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Error al cargar los datos del dashboard";
            Console.WriteLine($"Error loading dashboard data: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ExportDashboard()
    {
        // TODO: Implement export functionality
        Console.WriteLine("Exporting dashboard...");
    }

    private void NavigateToInventory()
    {
        Navigation.NavigateTo("/director/inventory");
    }

    private void NavigateToReports()
    {
        Navigation.NavigateTo("/director/reports");
    }

    private string GetTrendClass(double trend)
    {
        return trend < 0 ? "trend-positive" : "trend-negative";
    }

    private string FormatTrend(double trend)
    {
        var sign = trend < 0 ? "- " : "+ ";
        return $"{sign}{Math.Abs(trend):F1}%";
    }

    private string GetMaintenanceCountColor(int count, int maxCount)
    {
        if (maxCount == 0) return "progress-green";
        var ratio = (double)count / maxCount;
        return ratio >= 0.8 ? "progress-green" : 
               ratio >= 0.5 ? "progress-orange" : "progress-red";
    }
}
