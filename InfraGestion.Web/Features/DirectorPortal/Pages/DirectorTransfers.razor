@page "/director/transfers"
@using InfraGestion.Web.Features.Transfers.Models
@using InfraGestion.Web.Features.Transfers.Services
@inject TransferService TransferService
@inject NavigationManager Navigation

<PageTitle>Gestión de Traslados - InfraCom</PageTitle>

<div class="transfers-page">
    <!-- Header -->
    <PageHeader Title="Gestión de Traslados" Description="Administración de traslados de equipos entre secciones de la empresa" />

    <!-- Filters -->
    <FilterBar>
        <SearchBox>
            <SearchBox @bind-Value="searchTerm" Placeholder="Buscar por nombre ..." OnSearch="HandleSearch" />
        </SearchBox>
        <Filters>
            <FilterSelect @bind-Value="selectedDateFilter" OnChange="HandleFilterChange">
                <option value="">Fecha: Todos</option>
                <option value="2024">2024</option>
                <option value="2023">2023</option>
                <option value="2022">2022</option>
                <option value="2021">2021</option>
            </FilterSelect>

            <ExportButton Text="Exportar" />
        </Filters>
    </FilterBar>

    <!-- Table -->
    <DataTable TItem="Transfer" Items="filteredTransfers ?? new List<Transfer>()" IsLoading="isLoading" ColumnCount="5"
               EmptyText="No se encontraron registros que coincidan con los filtros aplicados">
        <HeaderTemplate>
            <th>ID de equipo</th>
            <th>Nombre del equipo</th>
            <th>Origen</th>
            <th>Destino</th>
            <th>Fecha</th>
        </HeaderTemplate>
        <RowTemplate Context="transfer">
            <td class="device-id-cell">@transfer.DeviceId</td>
            <td class="device-name-cell">@transfer.DeviceName</td>
            <td class="origin-cell">@transfer.SourceSectionName</td>
            <td class="destination-cell">@transfer.DestinationSectionName</td>
            <td class="date-cell">@transfer.TransferDate.ToString("dd/MM/yyyy")</td>
        </RowTemplate>
    </DataTable>
</div>

@code {
    // Data
    private List<Transfer>? transfers;
    private List<Transfer>? filteredTransfers;
    private bool isLoading = true;

    // Filters
    private string searchTerm = string.Empty;
    private string selectedDateFilter = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadTransfers();
    }

    private async Task LoadTransfers()
    {
        isLoading = true;
        transfers = await TransferService.GetAllTransfersAsync();
        filteredTransfers = transfers;
        isLoading = false;
    }

    private void HandleSearch()
    {
        ApplyFilters();
    }

    private void HandleFilterChange()
    {
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        if (transfers == null) return;

        filteredTransfers = transfers;

        // Search filter
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            filteredTransfers = filteredTransfers
                .Where(t => t.DeviceName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }

        // Date filter
        if (!string.IsNullOrWhiteSpace(selectedDateFilter))
        {
            if (int.TryParse(selectedDateFilter, out int year))
            {
                filteredTransfers = filteredTransfers
                    .Where(t => t.TransferDate.Year == year)
                    .ToList();
            }
        }
    }
}
