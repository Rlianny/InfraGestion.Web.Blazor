@page "/director/technicians"
@using InfraGestion.Web.Features.Technicians.Models
@using InfraGestion.Web.Features.Technicians.Services
@using InfraGestion.Web.Features.Technicians.Helpers
@using InfraGestion.Web.Features.DirectorPortal.Components
@inject TechnicianService TechnicianService
@inject NavigationManager Navigation

<PageTitle>Directorio de Equipo Técnico - InfraCom</PageTitle>

<div class="technicians-page">
    <!-- Header -->
    <div class="page-header-wrapper">
        <div class="page-header">
            <div class="header-text">
                <h1 class="page-title">Directorio de Equipo Técnico</h1>
                <p class="page-description">Administración del personal técnico</p>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filters-container">
        <div class="search-box">
            <svg class="search-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z" />
            </svg>
            <input type="text" class="search-input" placeholder="Buscar por nombre, especialidad ..." 
                   @bind="searchTerm" @bind:event="oninput" @bind:after="HandleSearch" />
        </div>

        <div class="filter-group">
            <select class="filter-select" @bind="selectedSection" @bind:after="HandleFilterChange">
                <option value="">Sección: Todos</option>
                @foreach (var sec in sections)
                {
                    <option value="@sec">@sec</option>
                }
            </select>

            <select class="filter-select" @bind="selectedSpecialty" @bind:after="HandleFilterChange">
                <option value="">Especialidad: Todos</option>
                @foreach (var spec in specialties)
                {
                    <option value="@spec">@spec</option>
                }
            </select>

            <button class="btn-export">
                <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M74.34,85.66A8,8,0,0,1,85.66,74.34L120,108.69V24a8,8,0,0,1,16,0v84.69l34.34-34.35a8,8,0,0,1,11.32,11.32l-48,48a8,8,0,0,1-11.32,0ZM240,136v64a16,16,0,0,1-16,16H32a16,16,0,0,1-16-16V136a16,16,0,0,1,16-16H84.4a4,4,0,0,1,2.83,1.17L111,145A24,24,0,0,0,145,145l23.8-23.8A4,4,0,0,1,171.6,120H224A16,16,0,0,1,240,136Zm-40,32a12,12,0,1,0-12,12A12,12,0,0,0,200,168Z" />
                </svg>
                Exportar
            </button>
        </div>
    </div>

    <!-- Cards Grid -->
    <div class="cards-container">
        @if (isLoading)
        {
            <div class="loading-state">
                <div class="spinner"></div>
                <span>Cargando datos...</span>
            </div>
        }
        else if (filteredTechnicians == null || !filteredTechnicians.Any())
        {
            <div class="empty-state">
                <svg class="empty-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M117.25,157.92a60,60,0,1,0-66.5,0A95.83,95.83,0,0,0,3.53,195.63a8,8,0,1,0,13.4,8.74,80,80,0,0,1,134.14,0,8,8,0,0,0,13.4-8.74A95.83,95.83,0,0,0,117.25,157.92ZM40,108a44,44,0,1,1,44,44A44.05,44.05,0,0,1,40,108Zm210.14,98.7a8,8,0,0,1-11.07-2.33A79.83,79.83,0,0,0,172,168a8,8,0,0,1,0-16,44,44,0,1,0-16.34-84.87,8,8,0,1,1-5.94-14.85,60,60,0,0,1,55.53,105.64,95.83,95.83,0,0,1,47.22,37.71A8,8,0,0,1,250.14,206.7Z" />
                </svg>
                <p>No se encontraron técnicos que coincidan con los filtros aplicados</p>
            </div>
        }
        else
        {
            @foreach (var technician in filteredTechnicians)
            {
                <div class="technician-card">
                    <div class="card-header">
                        <div class="avatar-container">
                       <img src="@InfraGestion.Web.Features.Technicians.Helpers.TechnicianPhotoHelper.GetPhotoUrl(technician.PhotoUrl, technician.Id, technician.Name)" alt="@technician.Name" class="avatar" 
                           onerror="this.src='/images/techs/tech01.png'" />
                        </div>
                        <div class="technician-info">
                            <h3 class="technician-name">@technician.Name</h3>
                            <p class="technician-specialty">@technician.Specialty</p>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <div class="status-container">
                            <span class="status-badge @GetStatusClass(technician.Status)">
                                <span class="status-dot"></span>
                                @GetStatusText(technician.Status)
                            </span>
                        </div>
                        
                        <div class="rating-container">
                            <span class="rating-label">Promedio de valoraciones: (@technician.Rating.ToString("0.0", System.Globalization.CultureInfo.InvariantCulture)/5)</span>
                            <div class="rating-bar">
                                <div class="rating-fill" style="width: @((technician.Rating / 5 * 100).ToString("0", System.Globalization.CultureInfo.InvariantCulture))%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-footer">
                        <button class="btn-view-profile" @onclick="() => ViewProfile(technician.Id)">
                            <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path d="M213.66,82.34l-56-56A8,8,0,0,0,152,24H56A16,16,0,0,0,40,40V216a16,16,0,0,0,16,16H200a16,16,0,0,0,16-16V88A8,8,0,0,0,213.66,82.34ZM160,51.31,188.69,80H160ZM200,216H56V40h88V88a8,8,0,0,0,8,8h48V216Z" />
                            </svg>
                            Ver Perfil
                        </button>
                        
                        <!-- Director Action Buttons -->
                        <TechnicianActionButtons 
                            OnRate="@(() => HandleRate(technician.Id))"
                            OnBonus="@(() => HandleBonus(technician.Id))"
                            OnPenalty="@(() => HandlePenalty(technician.Id))" />
                    </div>
                </div>
            }
        }
    </div>
</div>

@code {
    // Data
    private List<Technician> allTechnicians = new();
    private List<Technician> filteredTechnicians = new();
    private List<string> sections = new();
    private List<string> specialties = new();
    private bool isLoading = true;

    // Filters
    private string searchTerm = string.Empty;
    private string selectedSection = string.Empty;
    private string selectedSpecialty = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        try
        {
            allTechnicians = await TechnicianService.GetAllTechniciansAsync();
            sections = await TechnicianService.GetSectionsAsync();
            specialties = await TechnicianService.GetSpecialtiesAsync();
            ApplyFilters();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void HandleSearch()
    {
        ApplyFilters();
    }

    private void HandleFilterChange()
    {
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        var query = allTechnicians.AsEnumerable();

        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            query = query.Where(t =>
                t.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                t.Specialty.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrEmpty(selectedSection))
        {
            query = query.Where(t => t.Section == selectedSection);
        }

        if (!string.IsNullOrEmpty(selectedSpecialty))
        {
            query = query.Where(t => t.Specialty == selectedSpecialty);
        }

        filteredTechnicians = query.ToList();
    }

    private void ViewProfile(int technicianId)
    {
        Navigation.NavigateTo($"/director/technicians/{technicianId}");
    }

    private void HandleRate(int technicianId)
    {
        // TODO: Implement rating functionality
        Console.WriteLine($"Rating technician {technicianId}");
    }

    private void HandleBonus(int technicianId)
    {
        // TODO: Implement bonus registration
        Console.WriteLine($"Registering bonus for technician {technicianId}");
    }

    private void HandlePenalty(int technicianId)
    {
        // TODO: Implement penalty registration
        Console.WriteLine($"Registering penalty for technician {technicianId}");
    }

    private string GetStatusClass(TechnicianStatus status) => status switch
    {
        TechnicianStatus.Active => "status-active",
        TechnicianStatus.Inactive => "status-inactive",
        TechnicianStatus.OnLeave => "status-onleave",
        _ => "status-inactive"
    };

    private string GetStatusText(TechnicianStatus status) => status switch
    {
        TechnicianStatus.Active => "Activo",
        TechnicianStatus.Inactive => "Inactivo",
        TechnicianStatus.OnLeave => "De Permiso",
        _ => "Desconocido"
    };
}
