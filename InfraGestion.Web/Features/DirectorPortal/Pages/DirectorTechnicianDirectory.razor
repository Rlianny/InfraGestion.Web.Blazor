@page "/director/technicians"
@using InfraGestion.Web.Features.Technicians.Models
@using InfraGestion.Web.Features.Technicians.Services
@using InfraGestion.Web.Features.Technicians.Helpers
@using InfraGestion.Web.Features.DirectorPortal.Components
@using InfraGestion.Web.Features.Auth.Services
@using InfraGestion.Web.Core.Models
@inject TechnicianService TechnicianService
@inject AuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Directorio de Equipo Técnico - InfraCom</PageTitle>

<div class="technicians-page">
    <!-- Header -->
    <PageHeader Title="Directorio de Equipo Técnico" Description="Administración del personal técnico" />

    <!-- Filters -->
    <FilterBar>
        <SearchBox>
            <SearchBox @bind-Value="searchTerm" Placeholder="Buscar por nombre, especialidad ..." OnSearch="HandleSearch" />
        </SearchBox>
        <Filters>
            <FilterSelect @bind-Value="selectedSection" 
                          DefaultOptionText="Sección: Todos"
                          Options="@sectionOptions"
                          OnChange="HandleFilterChange" />

            <FilterSelect @bind-Value="selectedSpecialty" 
                          DefaultOptionText="Especialidad: Todos"
                          Options="@specialtyOptions"
                          OnChange="HandleFilterChange" />

            <ExportButton Text="Exportar" />
        </Filters>
    </FilterBar>

    <!-- Cards Grid -->
    <div class="cards-container">
        @if (isLoading)
        {
            <div class="loading-state">
                <div class="spinner"></div>
                <span>Cargando datos...</span>
            </div>
        }
        else if (filteredTechnicians == null || !filteredTechnicians.Any())
        {
            <div class="empty-state">
                <svg class="empty-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M117.25,157.92a60,60,0,1,0-66.5,0A95.83,95.83,0,0,0,3.53,195.63a8,8,0,1,0,13.4,8.74,80,80,0,0,1,134.14,0,8,8,0,0,0,13.4-8.74A95.83,95.83,0,0,0,117.25,157.92ZM40,108a44,44,0,1,1,44,44A44.05,44.05,0,0,1,40,108Zm210.14,98.7a8,8,0,0,1-11.07-2.33A79.83,79.83,0,0,0,172,168a8,8,0,0,1,0-16,44,44,0,1,0-16.34-84.87,8,8,0,1,1-5.94-14.85,60,60,0,0,1,55.53,105.64,95.83,95.83,0,0,1,47.22,37.71A8,8,0,0,1,250.14,206.7Z" />
                </svg>
                <p>No se encontraron técnicos que coincidan con los filtros aplicados</p>
            </div>
        }
        else
        {
            @foreach (var technician in filteredTechnicians)
            {
                <div class="technician-card">
                    <div class="card-header">
                        <div class="avatar-container">
                       <img src="@InfraGestion.Web.Features.Technicians.Helpers.TechnicianPhotoHelper.GetPhotoUrl(technician.PhotoUrl, technician.Id, technician.Name)" alt="@technician.Name" class="avatar" 
                           onerror="this.src='/images/techs/tech01.png'" />
                        </div>
                        <div class="technician-info">
                            <h3 class="technician-name">@technician.Name</h3>
                            <p class="technician-specialty">@technician.Specialty</p>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <div class="status-container">
                            <span class="status-badge @GetStatusClass(technician.Status)">
                                <span class="status-dot"></span>
                                @GetStatusText(technician.Status)
                            </span>
                        </div>
                        
                        <div class="rating-container">
                            <span class="rating-label">Promedio de valoraciones: (@technician.Rating.ToString("0.0", System.Globalization.CultureInfo.InvariantCulture)/5)</span>
                            <div class="rating-bar">
                                <div class="rating-fill" style="width: @((technician.Rating / 5 * 100).ToString("0", System.Globalization.CultureInfo.InvariantCulture))%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-footer">
                        <button class="btn-view-profile" @onclick="() => ViewProfile(technician.Id)">
                            <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path d="M213.66,82.34l-56-56A8,8,0,0,0,152,24H56A16,16,0,0,0,40,40V216a16,16,0,0,0,16,16H200a16,16,0,0,0,16-16V88A8,8,0,0,0,213.66,82.34ZM160,51.31,188.69,80H160ZM200,216H56V40h88V88a8,8,0,0,0,8,8h48V216Z" />
                            </svg>
                            Ver Perfil
                        </button>
                        
                        <!-- Director Action Buttons -->
                        <TechnicianActionButtons 
                            OnRate="@(() => HandleRate(technician.Id))"
                            OnBonus="@(() => HandleBonus(technician.Id))"
                            OnPenalty="@(() => HandlePenalty(technician.Id))" />
                    </div>
                </div>
            }
        }
    </div>
</div>

<!-- Rate Technician Modal -->
<InfraGestion.Web.Shared.Components.Modal IsOpen="@showRateModal" Title="Valorar Técnico" OnClose="@CloseRateModal">
    <RateTechnicianForm FormModel="@rateRequest" 
                        TechnicianName="@selectedTechnicianName"
                        OnValidSubmit="@HandleRateSubmit" 
                        OnCancel="@CloseRateModal"
                        IsSubmitting="@isSubmitting" />
</InfraGestion.Web.Shared.Components.Modal>

<!-- Bonus Modal -->
<InfraGestion.Web.Shared.Components.Modal IsOpen="@showBonusModal" Title="Registrar Bonificación" OnClose="@CloseBonusModal">
    <BonusForm FormModel="@bonusRequest" 
               TechnicianName="@selectedTechnicianName"
               OnValidSubmit="@HandleBonusSubmit" 
               OnCancel="@CloseBonusModal"
               IsSubmitting="@isSubmitting" />
</InfraGestion.Web.Shared.Components.Modal>

<!-- Penalty Modal -->
<InfraGestion.Web.Shared.Components.Modal IsOpen="@showPenaltyModal" Title="Registrar Penalización" OnClose="@ClosePenaltyModal">
    <PenaltyForm FormModel="@penaltyRequest" 
                 TechnicianName="@selectedTechnicianName"
                 OnValidSubmit="@HandlePenaltySubmit" 
                 OnCancel="@ClosePenaltyModal"
                 IsSubmitting="@isSubmitting" />
</InfraGestion.Web.Shared.Components.Modal>

@code {
    // Data
    private List<Technician> allTechnicians = new();
    private List<Technician> filteredTechnicians = new();
    private List<string> sections = new();
    private List<string> specialties = new();
    private bool isLoading = true;
    private UserSession? currentUser;

    // Filters
    private string searchTerm = string.Empty;
    private string selectedSection = string.Empty;
    private string selectedSpecialty = string.Empty;
    
    // Filter Options
    private List<FilterSelect.SelectOption> sectionOptions = new();
    private List<FilterSelect.SelectOption> specialtyOptions = new();

    // Modal State
    private bool showRateModal = false;
    private bool showBonusModal = false;
    private bool showPenaltyModal = false;
    private bool isSubmitting = false;

    // Modal Data
    private int selectedTechnicianId = 0;
    private string selectedTechnicianName = string.Empty;
    private RateTechnicianRequest rateRequest = new();
    private BonusRequest bonusRequest = new();
    private PenaltyRequest penaltyRequest = new();

    protected override async Task OnInitializedAsync()
    {
        currentUser = await AuthService.GetCurrentUserAsync();
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        try
        {
            allTechnicians = await TechnicianService.GetAllTechniciansAsync();
            sections = await TechnicianService.GetSectionsAsync();
            specialties = await TechnicianService.GetSpecialtiesAsync();
            
            // Build filter options
            sectionOptions = sections.Select(s => new FilterSelect.SelectOption(s, s)).ToList();
            specialtyOptions = specialties.Select(s => new FilterSelect.SelectOption(s, s)).ToList();
            
            ApplyFilters();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void HandleSearch()
    {
        ApplyFilters();
    }

    private void HandleFilterChange()
    {
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        var query = allTechnicians.AsEnumerable();

        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            query = query.Where(t =>
                t.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                t.Specialty.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrEmpty(selectedSection))
        {
            query = query.Where(t => t.Section == selectedSection);
        }

        if (!string.IsNullOrEmpty(selectedSpecialty))
        {
            query = query.Where(t => t.Specialty == selectedSpecialty);
        }

        filteredTechnicians = query.ToList();
    }

    private void ViewProfile(int technicianId)
    {
        Navigation.NavigateTo($"/director/technicians/{technicianId}");
    }

    // Rate Modal Handlers
    private void HandleRate(int technicianId)
    {
        var technician = allTechnicians.FirstOrDefault(t => t.Id == technicianId);
        if (technician == null) return;

        selectedTechnicianId = technicianId;
        selectedTechnicianName = technician.Name;
        rateRequest = new RateTechnicianRequest
        {
            TechnicianId = technicianId,
            TechnicianName = technician.Name,
            SuperiorId = currentUser?.Id,
            SuperiorUsername = currentUser?.Username ?? string.Empty,
            Rate = 3.0m
        };
        showRateModal = true;
    }

    private void CloseRateModal()
    {
        showRateModal = false;
        rateRequest = new();
    }

    private async Task HandleRateSubmit(RateTechnicianRequest request)
    {
        isSubmitting = true;
        try
        {
            var success = await TechnicianService.RateTechnicianAsync(request);
            if (success)
            {
                await LoadData();
            }
            CloseRateModal();
        }
        finally
        {
            isSubmitting = false;
        }
    }

    // Bonus Modal Handlers
    private void HandleBonus(int technicianId)
    {
        var technician = allTechnicians.FirstOrDefault(t => t.Id == technicianId);
        if (technician == null) return;

        selectedTechnicianId = technicianId;
        selectedTechnicianName = technician.Name;
        bonusRequest = new BonusRequest
        {
            TechnicianId = technicianId,
            TechnicianName = technician.Name,
            SuperiorId = currentUser?.Id,
            SuperiorUsername = currentUser?.Username ?? string.Empty,
            BonusType = BonusType.Descriptive
        };
        showBonusModal = true;
    }

    private void CloseBonusModal()
    {
        showBonusModal = false;
        bonusRequest = new();
    }

    private async Task HandleBonusSubmit(BonusRequest request)
    {
        isSubmitting = true;
        try
        {
            var success = await TechnicianService.AddBonusAsync(request);
            if (success)
            {
                await LoadData();
            }
            CloseBonusModal();
        }
        finally
        {
            isSubmitting = false;
        }
    }

    // Penalty Modal Handlers
    private void HandlePenalty(int technicianId)
    {
        var technician = allTechnicians.FirstOrDefault(t => t.Id == technicianId);
        if (technician == null) return;

        selectedTechnicianId = technicianId;
        selectedTechnicianName = technician.Name;
        penaltyRequest = new PenaltyRequest
        {
            TechnicianId = technicianId,
            TechnicianName = technician.Name,
            SuperiorId = currentUser?.Id,
            SuperiorUsername = currentUser?.Username ?? string.Empty
        };
        showPenaltyModal = true;
    }

    private void ClosePenaltyModal()
    {
        showPenaltyModal = false;
        penaltyRequest = new();
    }

    private async Task HandlePenaltySubmit(PenaltyRequest request)
    {
        isSubmitting = true;
        try
        {
            var success = await TechnicianService.AddPenaltyAsync(request);
            if (success)
            {
                await LoadData();
            }
            ClosePenaltyModal();
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private string GetStatusClass(TechnicianStatus status) => status switch
    {
        TechnicianStatus.Active => "status-active",
        TechnicianStatus.Inactive => "status-inactive",
        TechnicianStatus.OnLeave => "status-onleave",
        _ => "status-inactive"
    };

    private string GetStatusText(TechnicianStatus status) => status switch
    {
        TechnicianStatus.Active => "Activo",
        TechnicianStatus.Inactive => "Inactivo",
        TechnicianStatus.OnLeave => "De Permiso",
        _ => "Desconocido"
    };
}
