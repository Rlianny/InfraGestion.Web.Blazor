@page "/reportes/bonificaciones"
@page "/director/reports/bonuses"
@page "/reports/bonus-determination"
@using InfraGestion.Web.Features.Reports.DTOs
@using InfraGestion.Web.Features.Reports.Services
@inject FrontendReport ReportService
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>Reporte de Bonificaciones - InfraCom</PageTitle>

<div class="report-page">
    <!-- Header -->
    <PageHeader Title="Evaluación de Rendimiento para Bonificaciones" 
                Description="Análisis del rendimiento de los técnicos para determinar bonificaciones o penalizaciones">
        <Actions>
            <button class="btn-back" @onclick="GoBack">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
                </svg>
                Volver
            </button>
            <ExportButton Text="Exportar PDF" OnClick="ExportToPdf" IsLoading="isExporting" />
        </Actions>
    </PageHeader>

    <!-- Summary Stats -->
    @if (!isLoading && reportData.Any())
    {
        <div class="stats-container">
            <StatCard Label="Total Técnicos" Value="@reportData.Count.ToString()" Color="blue">
                <IconContent>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M15 14s1 0 1-1-1-4-5-4-5 3-5 4 1 1 1 1h8zm-7.978-1A.261.261 0 0 1 7 12.996c.001-.264.167-1.03.76-1.72C8.312 10.629 9.282 10 11 10c1.717 0 2.687.63 3.24 1.276.593.69.758 1.457.76 1.72l-.008.002a.274.274 0 0 1-.014.002H7.022zM11 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm3-2a3 3 0 1 1-6 0 3 3 0 0 1 6 0zM6.936 9.28a5.88 5.88 0 0 0-1.23-.247A7.35 7.35 0 0 0 5 9c-4 0-5 3-5 4 0 .667.333 1 1 1h4.216A2.238 2.238 0 0 1 5 13c0-1.01.377-2.042 1.09-2.904.243-.294.526-.569.846-.816zM4.92 10A5.493 5.493 0 0 0 4 13H1c0-.26.164-1.03.76-1.724.545-.636 1.492-1.256 3.16-1.275zM1.5 5.5a3 3 0 1 1 6 0 3 3 0 0 1-6 0zm3-2a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"/>
                    </svg>
                </IconContent>
            </StatCard>
           
            <StatCard Label="Promedio Valoración" Value="@(reportData.Any() ? reportData.Average(r => r.AverageRating).ToString("F1") : "0")" Color="yellow">
                <IconContent>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
                    </svg>
                </IconContent>
            </StatCard>
        </div>
    }

    <!-- Table -->
    <DataTable TItem="BonusDeterminationReportDto" Items="reportData" IsLoading="isLoading" ColumnCount="8"
               EmptyText="No se encontraron datos para este reporte">
        <HeaderTemplate>
            <th>Técnico</th>
            <th>Intervenciones</th>
            <th>Menor Calificación</th>
            <th>Calificación Promedio</th>
            <th>Mayor Calificación</th>
            <th>Cantidad de Valoraciones</th>
        </HeaderTemplate>
        <RowTemplate Context="item">
            <td class="name-cell">@item.TechnicianName</td>
            <td class="number-cell">@item.TotalInterventions</td>
            <td class="number-cell">@item.LowestRating</td>
            <td class="number-cell">@item.AverageRating</td>
            <td class="number-cell">@item.HighestRating</td>
            <td class="number-cell">@item.RatingCount</td>
        </RowTemplate>
    </DataTable>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="error-message">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
            </svg>
            @errorMessage
        </div>
    }
</div>

@code {

    private List<BonusDeterminationReportDto> reportData = new();
    private bool isLoading = true;
    private bool isExporting = false;
    private string? errorMessage;

    private byte[] bytes;
    protected override async Task OnInitializedAsync()
    {
        await LoadReport();
    }

    private async Task LoadReport()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            var criteria = new BonusReportCriteria();
            var report = await ReportService.GenerateBonusDeterminationReportAsync();

            reportData = report.ReportData;

            bytes = report.PdfBytes;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al cargar el reporte: {ex.Message}";
            Console.WriteLine($"[BonusReport] Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/reportes");
    }

    private async Task ExportToPdf()
    {
        try
        {
            isExporting = true;
            StateHasChanged();

            var pdfBytes = bytes;
            var base64 = Convert.ToBase64String(pdfBytes);
            await JS.InvokeVoidAsync("downloadFile", "reporte-bonificaciones.pdf", "application/pdf", base64);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error exporting PDF: {ex.Message}");
        }
        finally
        {
            isExporting = false;
            StateHasChanged();
        }
    }

   
}
