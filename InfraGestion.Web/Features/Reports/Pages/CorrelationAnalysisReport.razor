@page "/reports/correlation-analysis"
@page "/reports/technical-efficiency"
@page "/reportes/eficiencia-tecnica"
@using InfraGestion.Web.Features.Reports.DTOs
@using InfraGestion.Web.Features.Reports.Services
@inject FrontendReport ReportService
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>Análisis de Correlación Técnica - InfraCom</PageTitle>

<div class="report-page">
    <!-- Header -->
    <PageHeader Title="Análisis de Correlación Técnica" 
                Description="Relación entre costo de mantenimiento y longevidad de equipos por técnico">
        <Actions>
            <button class="btn-back" @onclick="GoBack">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
                </svg>
                Volver
            </button>
            <ExportButton OnClick="ExportToPdf" IsLoading="isExporting" />
        </Actions>
    </PageHeader>

    <!-- Stats Summary -->
    @if (!isLoading && reportData.Any())
    {
        <div class="stats-container">
            <StatCard Label="Técnicos Evaluados" 
                      Value="@reportData.Count.ToString()" 
                      Color="#673AB7">
                <IconContent>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M7 14s-1 0-1-1 1-4 5-4 5 3 5 4-1 1-1 1H7zm4-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
                        <path fill-rule="evenodd" d="M5.216 14A2.238 2.238 0 0 1 5 13c0-1.355.68-2.75 1.936-3.72A6.325 6.325 0 0 0 5 9c-4 0-5 3-5 4s1 1 1 1h4.216z"/>
                        <path d="M4.5 8a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5z"/>
                    </svg>
                </IconContent>
            </StatCard>
            
            <StatCard Label="Índice Promedio" 
                      Value="@($"{reportData.Average(r => r.CorrelationIndex):N2}")" 
                      Color="#2196F3">
                <IconContent>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M0 0h1v15h15v1H0V0Zm14.817 3.113a.5.5 0 0 1 .07.704l-4.5 5.5a.5.5 0 0 1-.74.037L7.06 6.767l-3.656 5.027a.5.5 0 0 1-.808-.588l4-5.5a.5.5 0 0 1 .758-.06l2.609 2.61 4.15-5.073a.5.5 0 0 1 .704-.07Z"/>
                    </svg>
                </IconContent>
            </StatCard>
        </div>
    }

    <!-- Data Table -->
    <DataTable TItem="CorrelationAnalysisReportDto" Items="reportData" IsLoading="isLoading" ColumnCount="6" EmptyText="No hay datos de correlación disponibles">
        <HeaderTemplate>
            <th>Técnico</th>
            <th>Especialidad</th>
            <th>Índice de Correlación</th>
            <th>Calificación Promedio</th>
        </HeaderTemplate>
        <RowTemplate Context="item">
            <td>@item.TechnicianName</td>
            <td>@item.Specialty</td>
            <td>@item.CorrelationIndex</td>
            <td>@item.AveragePerformanceRating</td>
        </RowTemplate>
    </DataTable>

    <!-- Legend -->
    
</div>

@code {
    private List<CorrelationAnalysisReportDto> reportData = new();
    private bool isLoading = true;
    private bool isExporting = false;
    private string? errorMessage;

    private byte[] bytes;

    protected override async Task OnInitializedAsync()
    {
        await LoadReport();
    }

    private async Task LoadReport()
    {
        try
        {
            isLoading = true;
            errorMessage = null;
            StateHasChanged();

            var report = await ReportService.GenerateCorrelationAnalysisReportAsync();

            reportData = report.ReportData;

            bytes = report.PdfBytes;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al cargar el reporte: {ex.Message}";
            Console.WriteLine($"Error loading correlation analysis report: {ex}");
           
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    

    
    private async Task ExportToPdf()
    {
        try
        {
            isExporting = true;
            StateHasChanged();

            var pdfBytes = bytes;
            if (pdfBytes != null && pdfBytes.Length > 0)
            {
                var base64 = Convert.ToBase64String(pdfBytes);
                await JS.InvokeVoidAsync("downloadFile", "reporte-correlacion.pdf", "application/pdf", base64);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error exporting PDF: {ex.Message}");
        }
        finally
        {
            isExporting = false;
            StateHasChanged();
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/reportes");
    }
}
