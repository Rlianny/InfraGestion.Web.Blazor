@page "/reportes"
@page "/director/reports"
@page "/technician/reports"
@page "/logistician/reports"
@using InfraGestion.Web.Features.Reports.Components
@using InfraGestion.Web.Features.Reports.Services
@using InfraGestion.Web.Features.Inventory.Services
@using InfraGestion.Web.Features.Inventory.Helpers
@using InfraGestion.Web.Features.Departments.Services
@using static InfraGestion.Web.Features.Reports.Components.SearchModal
@inject DeviceService DeviceService
@inject DepartmentService DepartmentService
@inject FrontendReport ReportService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>Sistema de Reportes - InfraCom</PageTitle>

<div class="reports-page">
    <!-- Header -->
    <div class="page-header-wrapper">
        <div class="page-header">
            <div class="header-text">
                <h1 class="page-title">Sistema de Reportes</h1>
                <p class="page-description">Análisis y estadísticas del sistema InfraGestión</p>
            </div>
            <button class="btn-export-all" @onclick="ExportAll">
                <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M74.34,85.66A8,8,0,0,1,85.66,74.34L120,108.69V24a8,8,0,0,1,16,0v84.69l34.34-34.35a8,8,0,0,1,11.32,11.32l-48,48a8,8,0,0,1-11.32,0ZM240,136v64a16,16,0,0,1-16,16H32a16,16,0,0,1-16-16V136a16,16,0,0,1,16-16H84.4a4,4,0,0,1,2.83,1.17L111,145A24,24,0,0,0,145,145l23.8-23.8A4,4,0,0,1,171.6,120H224A16,16,0,0,1,240,136Zm-40,32a12,12,0,1,0-12,12A12,12,0,0,0,200,168Z" />
                </svg>
                Exportar Todos
            </button>
        </div>
    </div>

    <!-- Reports Grid -->
    <div class="reports-grid">
        @foreach (var report in reports)
        {
            <div class="report-card">
                <div class="report-header">
                    <h2 class="report-title">@report.Title</h2>
                    <div class="pdf-icon">
                        <svg viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                            <path d="M44,120H212a4,4,0,0,0,4-4V88a8,8,0,0,0-2.34-5.66l-56-56A8,8,0,0,0,152,24H56A16,16,0,0,0,40,40v76A4,4,0,0,0,44,120ZM152,44l44,44H152Zm72,108.53a8.18,8.18,0,0,1-8.25,7.47H192v16h15.73a8.17,8.17,0,0,1,8.25,7.47,8,8,0,0,1-8,8.53H192v15.73a8.17,8.17,0,0,1-7.47,8.25,8,8,0,0,1-8.53-8V152a8,8,0,0,1,8-8h32A8,8,0,0,1,224,152.53ZM64,144H48a8,8,0,0,0-8,8v55.73A8.17,8.17,0,0,0,47.47,216,8,8,0,0,0,56,208v-8h7.4c15.24,0,28.14-11.92,28.59-27.15A28,28,0,0,0,64,144Zm-.35,40H56V160h8a12,12,0,0,1,12,13.16A12.25,12.25,0,0,1,63.65,184ZM128,144H112a8,8,0,0,0-8,8v56a8,8,0,0,0,8,8h15.32c19.66,0,36.21-15.48,36.67-35.13A36,36,0,0,0,128,144Zm-.49,56H120V160h8a20,20,0,0,1,20,20.77C147.58,191.59,138.34,200,127.51,200Z" />
                        </svg>
                    </div>
                </div>
                <p class="report-description">@report.Description</p>
                <div class="report-actions">
                    <button class="btn-generate" @onclick="() => HandleGenerateReport(report)">
                        <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                            <path d="M247.31,124.76c-.35-.79-8.82-19.58-27.65-38.41C194.57,61.26,162.88,48,128,48S61.43,61.26,36.34,86.35C17.51,105.18,9,124,8.69,124.76a8,8,0,0,0,0,6.5c.35.79,8.82,19.57,27.65,38.4C61.43,194.74,93.12,208,128,208s66.57-13.26,91.66-38.34c18.83-18.83,27.3-37.61,27.65-38.4A8,8,0,0,0,247.31,124.76ZM128,168a40,40,0,1,1,40-40A40,40,0,0,1,128,168Z" />
                        </svg>
                        Generar Reporte
                    </button>
                    <button class="btn-export" @onclick="() => ExportReport(report.Id)">
                        <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                            <path d="M74.34,85.66A8,8,0,0,1,85.66,74.34L120,108.69V24a8,8,0,0,1,16,0v84.69l34.34-34.35a8,8,0,0,1,11.32,11.32l-48,48a8,8,0,0,1-11.32,0ZM240,136v64a16,16,0,0,1-16,16H32a16,16,0,0,1-16-16V136a16,16,0,0,1,16-16H84.4a4,4,0,0,1,2.83,1.17L111,145A24,24,0,0,0,145,145l23.8-23.8A4,4,0,0,1,171.6,120H224A16,16,0,0,1,240,136Zm-40,32a12,12,0,1,0-12,12A12,12,0,0,0,200,168Z" />
                        </svg>
                        Exportar
                    </button>
                </div>
            </div>
        }
    </div>
</div>

<!-- Search Modal for Equipment -->
<SearchModal 
    IsVisible="@showEquipmentModal"
    Title="Buscar Equipo"
    Placeholder="Buscar por nombre o código del equipo..."
    Items="@equipmentItems"
    OnCancel="CloseEquipmentModal"
    OnAccept="OnEquipmentSelected" />

<!-- Search Modal for Department -->
<SearchModal 
    IsVisible="@showDepartmentModal"
    Title="Buscar Departamento"
    Placeholder="Buscar por nombre del departamento..."
    Items="@departmentItems"
    OnCancel="CloseDepartmentModal"
    OnAccept="OnDepartmentSelected" />

@code {
    private List<ReportItem> reports = new();
    
    // Modal states
    private bool showEquipmentModal = false;
    private bool showDepartmentModal = false;
    private bool isLoadingData = false;
    
    // Data for search from API
    private List<SearchItem> equipmentItems = new();
    private List<SearchItem> departmentItems = new();

    protected override async Task OnInitializedAsync()
    {
        LoadReports();
        await LoadDataFromApiAsync();
    }

    private void LoadReports()
    {
        reports = new List<ReportItem>
        {
            new ReportItem
            {
                Id = "performance-bonuses",
                Title = "Evaluación de Rendimiento para Bonificaciones",
                Description = "Análisis del rendimiento de los técnicos, basándose en las valoraciones recibidas y la cantidad de intervenciones realizadas, para determinar bonificaciones o penalizaciones en su salario.",
                RequiresSearch = false
            },
            new ReportItem
            {
                Id = "equipment-maintenance-history",
                Title = "Historial de mantenimientos de un equipo específico",
                Description = "Mantenimientos de un equipo específico, clasificando los mantenimientos por tipo y fecha, junto con los técnicos que realizaron las intervenciones.",
                RequiresSearch = true,
                SearchType = SearchType.Equipment
            },
            new ReportItem
            {
                Id = "department-equipment",
                Title = "Equipos recibidos en un departamento específico",
                Description = "Reporte de los equipos que han sido enviados a un departamento específico, indicando los nombres de la persona quien envía y quien recibe..",
                RequiresSearch = true,
                SearchType = SearchType.Department
            },
            new ReportItem
            {
                Id = "annual-decommissions",
                Title = "Registro de Bajas Anuales",
                Description = "Listado de los equipos dados de baja en el último año, incluyendo la causa de la baja, el destino final y el nombre de la persona que recibió el equipo."
            },
            new ReportItem
            {
                Id = "equipment-transfers",
                Title = "Historial de Traslados de Equipos",
                Description = "Listado de los equipos que han sido trasladados entre diferentes secciones, indicando las fechas, el origen, el destino, y el nombre de la persona que recibe el equipo."
            },
            new ReportItem
            {
                Id = "technical-efficiency",
                Title = "Análisis de Eficiencia Técnica",
                Description = "Análisis de correlación entre rendimiento técnico, longevidad de equipos y costos de mantenimiento para equipos declarados irreparables. Identifica a los 5 técnicos con mayor costo de mantenimiento asociado a equipos de baja duración."
            },
            new ReportItem
            {
                Id = "critical-equipment",
                Title = "Equipos Críticos para Reemplazo",
                Description = "Informe de los equipos que han recibido más de tres mantenimientos en el último año y que, por normativa, deben ser reemplazados."
            }
        };
    }

    private async Task LoadDataFromApiAsync()
    {
        try
        {
            isLoadingData = true;
            
            // Load devices from API (uses the same service as inventory page)
            var devices = await DeviceService.GetAllDevicesAsync();
            equipmentItems = devices.Select(d => new SearchItem
            {
                Id = d.Id.ToString(),
                Name = d.Name,
                SubText = $"{DeviceTypeHelper.GetTypeDisplayName(d.Type)} - {d.Location}"
            }).ToList();
            
            Console.WriteLine($"[Reports] Loaded {equipmentItems.Count} devices from API");

            // Load departments from API
            var departments = await DepartmentService.GetAllDepartmentNamesAsync();
            departmentItems = departments.Select((name, index) => new SearchItem
            {
                Id = name, // Use department name as ID since that's what the API expects
                Name = name,
                SubText = null
            }).ToList();
            
            Console.WriteLine($"[Reports] Loaded {departmentItems.Count} departments from API");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Reports] Error loading data: {ex.Message}");
        }
        finally
        {
            isLoadingData = false;
        }
    }

    private void HandleGenerateReport(ReportItem report)
    {
        if (report.RequiresSearch)
        {
            if (report.SearchType == SearchType.Equipment)
            {
                showEquipmentModal = true;
            }
            else if (report.SearchType == SearchType.Department)
            {
                showDepartmentModal = true;
            }
        }
        else
        {
            GenerateReport(report.Id);
        }
    }

    private void GenerateReport(string reportId, string? selectedItemId = null)
    {
        // Navigate to report viewer page with parameters
        var url = reportId switch
        {
            "performance-bonuses" => "/reports/bonus-determination",
            "equipment-maintenance-history" => string.IsNullOrEmpty(selectedItemId) 
                ? "/reports/equipment-maintenance" 
                : $"/reports/equipment-maintenance/{selectedItemId}",
            "department-equipment" => string.IsNullOrEmpty(selectedItemId) 
                ? "/reports/department-equipment" 
                : $"/reports/department-equipment/{Uri.EscapeDataString(selectedItemId)}",
            "annual-decommissions" => "/reports/decommissioning",
            "equipment-transfers" => "/reports/department-transfers",
            "technical-efficiency" => "/reports/correlation-analysis",
            "critical-equipment" => "/reports/equipment-replacement",
            _ => "/reportes"
        };
        
        Navigation.NavigateTo(url);
    }

    private async Task ExportReport(string reportId)
    {
        try
        {
            var reportName = reportId switch
            {
                "performance-bonuses" => "bonus-determination",
                "annual-decommissions" => "decommissionings",
                "equipment-transfers" => "transfers",
                "technical-efficiency" => "correlation-analysis",
                "critical-equipment" => "equipment-replacement",
                _ => reportId
            };
            
            var pdfBytes = await ReportService.GetPdfReportAsync(reportName);
            await DownloadPdfAsync(pdfBytes, $"reporte-{reportName}.pdf");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error exporting report: {ex.Message}");
        }
    }

    private async Task ExportAll()
    {
        // Export each report type
        var reportTypes = new[] { "bonus-determination", "decommissionings", "transfers", "correlation-analysis", "equipment-replacement" };
        
        foreach (var reportType in reportTypes)
        {
            try
            {
                var pdfBytes = await ReportService.GetPdfReportAsync(reportType);
                await DownloadPdfAsync(pdfBytes, $"reporte-{reportType}.pdf");
                await Task.Delay(500); // Small delay between downloads
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error exporting {reportType}: {ex.Message}");
            }
        }
    }

    private async Task DownloadPdfAsync(byte[] pdfBytes, string fileName)
    {
        var base64 = Convert.ToBase64String(pdfBytes);
        await JSRuntime.InvokeVoidAsync("downloadFile", fileName, "application/pdf", base64);
    }

    // Equipment Modal handlers
    private void CloseEquipmentModal()
    {
        showEquipmentModal = false;
    }

    private void OnEquipmentSelected(SearchItem item)
    {
        showEquipmentModal = false;
        GenerateReport("equipment-maintenance-history", item.Id);
        Console.WriteLine($"Selected equipment: {item.Name} (ID: {item.Id})");
    }

    // Department Modal handlers
    private void CloseDepartmentModal()
    {
        showDepartmentModal = false;
    }

    private void OnDepartmentSelected(SearchItem item)
    {
        showDepartmentModal = false;
        GenerateReport("department-equipment", item.Id);
        Console.WriteLine($"Selected department: {item.Name}");
    }

    private class ReportItem
    {
        public string Id { get; set; } = string.Empty;
        public string Title { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public bool RequiresSearch { get; set; } = false;
        public SearchType SearchType { get; set; } = SearchType.None;
    }

    private enum SearchType
    {
        None,
        Equipment,
        Department
    }
}
