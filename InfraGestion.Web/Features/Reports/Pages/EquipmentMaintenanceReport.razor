@page "/reports/equipment-maintenance"
@page "/reports/equipment-maintenance/{EquipmentId:int}"
@page "/reportes/historial-mantenimiento"
@page "/reportes/historial-mantenimiento/{EquipmentId:int}"
@using InfraGestion.Web.Features.Reports.DTOs
@using InfraGestion.Web.Features.Reports.Services
@inject FrontendReport ReportService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject Inventory.Services.DeviceService DeviceService


<PageTitle>Historial de Mantenimiento - InfraCom</PageTitle>

<div class="report-page">
    <!-- Header -->
    <PageHeader Title="@GetPageTitle()" 
                Description="Registro completo de intervenciones de mantenimiento">
        <Actions>
            <button class="btn-back" @onclick="GoBack">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
                </svg>
                Volver
            </button>
            <ExportButton OnClick="ExportToPdf" IsLoading="isExporting" />
        </Actions>
    </PageHeader>

    <!-- Equipment Search -->
    @if (EquipmentId == 0)
    {
        <div class="equipment-search">
            <label>Buscar equipo por ID o nombre:</label>
            <div class="search-input-group">
                <input type="text" @bind="searchTerm" @bind:event="oninput" 
                       placeholder="Ingrese ID o nombre del equipo..." 
                       class="search-input" />
                <button class="btn-search" @onclick="SearchEquipment">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                    </svg>
                    Buscar
                </button>
            </div>
            
            @if (searchResults.Any())
            {
                <div class="search-results">
                    @foreach (var equipment in searchResults)
                    {
                        <button class="search-result-item" @onclick="() => SelectEquipment(equipment.Id)">
                            <span class="equipment-id">#@equipment.Id</span>
                            <span class="equipment-name">@equipment.Name</span>
                        </button>
                    }
                </div>
            }
        </div>
    }

    
    }

    <!-- Data Table -->
    <DataTable TItem="DeviceMantainenceReportDto" Items="reportData" IsLoading="isLoading" ColumnCount="7" EmptyText="@GetEmptyMessage()">
        <HeaderTemplate>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>Descripción</th>
            <th>Técnico</th>
        </HeaderTemplate>
        <RowTemplate Context="maintenance">
            <td>@maintenance.Date.ToString("dd/MM/yyyy")</td>
            <td>
                @maintenance.Type
            </td>
            <td>
                <div class="description-cell">
                    <span class="description-text">@maintenance.Description</span>
                </div>
            </td>
            <td>@maintenance.Technician</td>
            
        </RowTemplate>
    </DataTable>

    <!-- Timeline View Toggle -->
    @if (reportData.Any())
    {
        <div class="timeline-section">
            <button class="btn-toggle-timeline" @onclick="ToggleTimeline">
                @(showTimeline ? "Ocultar Línea de Tiempo" : "Ver Línea de Tiempo")
            </button>

            @if (showTimeline)
            {
                <div class="timeline">
                    @foreach (var item in reportData.OrderByDescending(r => r.Date))
                    {
                        <div class="timeline-item @GetTypeClass(item.Type)">
                            <div class="timeline-marker"></div>
                            <div class="timeline-content">
                                <div class="timeline-date">@item.Date.ToString("dd MMM yyyy")</div>
                                <div class="timeline-title">@item.Type: @item.Description</div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    }
</div>

@code {



    [Parameter]
    public int EquipmentId { get; set; }

    private List<DeviceMantainenceReportDto> reportData = new();
    private List<EquipmentSearchResult> searchResults = new();
    //private EquipmentInfo? selectedEquipment;
    private string searchTerm = "";
    private bool isLoading = true;
    private bool isExporting = false;
    private bool showTimeline = false;
    private string? errorMessage;

    private byte[] bytes;

    protected override async Task OnInitializedAsync()
    {
       
          
            await LoadReport();
        
            isLoading = false;
        
    }

  
      
    private async Task LoadReport()
    {
        if (EquipmentId == 0) return;

        try
        {
            isLoading = true;
            errorMessage = null;
            StateHasChanged();

            var report = await ReportService.GetEquipmentMaintenanceHistoryAsync(EquipmentId);
            reportData = report.ReportData;

            bytes = report.PdfBytes;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al cargar el reporte: {ex.Message}";
            Console.WriteLine($"Error loading maintenance history report: {ex}");
            
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

   
    private async Task SearchEquipment()
    {
        if (string.IsNullOrWhiteSpace(searchTerm)) 
        {
            searchResults.Clear();
            return;
        }

       
         searchResults =(await DeviceService.GetAllDevicesAsync())
        .Select(x => new EquipmentSearchResult(x.Id, x.Name))
        .ToList();
        

        StateHasChanged();
    }

    private async Task SelectEquipment(int equipmentId)
    {
        EquipmentId = equipmentId;
        searchResults.Clear();
        searchTerm = "";
     
        await LoadReport();
    }

    private void ToggleTimeline()
    {
        showTimeline = !showTimeline;
    }

    private string GetPageTitle() =>  "Historial de Mantenimiento";

    private string GetEmptyMessage() =>
        EquipmentId == 0 
            ? "Busque un equipo para ver su historial de mantenimiento" 
            : "No hay registros de mantenimiento para este equipo";

    private string GetStatusClass(string status) => status switch
    {
        "Activo" => "active",
        "En Mantenimiento" => "maintenance",
        "Inactivo" => "inactive",
        _ => "default"
    };

    private string GetTypeClass(string type) => type switch
    {
        "Preventivo" => "preventive",
        "Correctivo" => "corrective",
        _ => "default"
    };

    private string GetMaintenanceStatusClass(string status) => status switch
    {
        "Completado" => "completed",
        "En Progreso" => "in-progress",
        "Pendiente" => "pending",
        _ => "default"
    };

    private async Task ExportToPdf()
    {
        if (EquipmentId == 0) return;

        try
        {
            isExporting = true;
            StateHasChanged();

            
            if (bytes != null && bytes.Length > 0)
            {
                var base64 = Convert.ToBase64String(bytes);
                await JS.InvokeVoidAsync("downloadFile", $"historial-mantenimiento-{EquipmentId}.pdf", "application/pdf", base64);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error exporting PDF: {ex.Message}");
        }
        finally
        {
            isExporting = false;
            StateHasChanged();
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/reportes");
    }

    // Local helper classes
    public class EquipmentInfo
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public string Model { get; set; } = "";
        public string Category { get; set; } = "";
        public string Status { get; set; } = "";
    }

    private record EquipmentSearchResult(int Id, string Name);
}
