@page "/reports/equipment-maintenance"
@page "/reports/equipment-maintenance/{EquipmentId:int}"
@page "/reportes/historial-mantenimiento"
@page "/reportes/historial-mantenimiento/{EquipmentId:int}"
@using InfraGestion.Web.Features.Reports.DTOs
@using InfraGestion.Web.Features.Reports.Services
@inject FrontendReport ReportService
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>Historial de Mantenimiento - InfraCom</PageTitle>

<div class="report-page">
    <!-- Header -->
    <PageHeader Title="@GetPageTitle()" 
                Description="Registro completo de intervenciones de mantenimiento">
        <Actions>
            <button class="btn-back" @onclick="GoBack">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
                </svg>
                Volver
            </button>
            <ExportButton OnClick="ExportToPdf" IsLoading="isExporting" />
        </Actions>
    </PageHeader>

    <!-- Equipment Search -->
    @if (EquipmentId == 0)
    {
        <div class="equipment-search">
            <label>Buscar equipo por ID o nombre:</label>
            <div class="search-input-group">
                <input type="text" @bind="searchTerm" @bind:event="oninput" 
                       placeholder="Ingrese ID o nombre del equipo..." 
                       class="search-input" />
                <button class="btn-search" @onclick="SearchEquipment">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                    </svg>
                    Buscar
                </button>
            </div>
            
            @if (searchResults.Any())
            {
                <div class="search-results">
                    @foreach (var equipment in searchResults)
                    {
                        <button class="search-result-item" @onclick="() => SelectEquipment(equipment.Id)">
                            <span class="equipment-id">#@equipment.Id</span>
                            <span class="equipment-name">@equipment.Name</span>
                        </button>
                    }
                </div>
            }
        </div>
    }

    <!-- Equipment Info Card -->
    @if (selectedEquipment != null)
    {
        <div class="equipment-card">
            <div class="equipment-header">
                <div class="equipment-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4a1 1 0 0 0-1-1H2z"/>
                        <path d="M14 4a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h1zm-2 0a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h1zm-2 0a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h1z"/>
                    </svg>
                </div>
                <div class="equipment-details">
                    <h3>@selectedEquipment.Name</h3>
                    <p>@selectedEquipment.Model • @selectedEquipment.Category</p>
                </div>
                <div class="equipment-status @GetStatusClass(selectedEquipment.Status)">
                    @selectedEquipment.Status
                </div>
            </div>
        </div>
    }

    <!-- Stats Summary -->
    @if (!isLoading && reportData.Any())
    {
        <div class="stats-container">
            <StatCard Label="Total Intervenciones" 
                      Value="@reportData.Count.ToString()" 
                      Color="#2196F3">
                <IconContent>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M1 0 0 1l2.2 3.081a1 1 0 0 0 .815.419h.07a1 1 0 0 1 .708.293l2.675 2.675-2.617 2.654A3.003 3.003 0 0 0 0 13a3 3 0 1 0 5.878-.851l2.654-2.617.968.968-.305.914a1 1 0 0 0 .242 1.023l3.27 3.27a.997.997 0 0 0 1.414 0l1.586-1.586a.997.997 0 0 0 0-1.414l-3.27-3.27a1 1 0 0 0-1.023-.242L10.5 9.5l-.96-.96 2.68-2.643A3.005 3.005 0 0 0 16 3c0-.269-.035-.53-.102-.777l-2.14 2.141L12 4l-.364-1.757L13.777.102a3 3 0 0 0-3.675 3.68L7.462 6.46 4.793 3.793a1 1 0 0 1-.293-.707v-.071a1 1 0 0 0-.419-.814L1 0Z"/>
                    </svg>
                </IconContent>
            </StatCard>
            <StatCard Label="Costo Total" 
                      Value="@($"${reportData.Sum(r => r.Cost):N0}")" 
                      Color="#F44336">
                <IconContent>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M4 10.781c.148 1.667 1.513 2.85 3.591 3.003V15h1.043v-1.216c2.27-.179 3.678-1.438 3.678-3.3 0-1.59-.947-2.51-2.956-3.028l-.722-.187V3.467c1.122.11 1.879.714 2.07 1.616h1.47c-.166-1.6-1.54-2.748-3.54-2.875V1H7.591v1.233c-1.939.23-3.27 1.472-3.27 3.156 0 1.454.966 2.483 2.661 2.917l.61.162v4.031c-1.149-.17-1.94-.8-2.131-1.718H4zm3.391-3.836c-1.043-.263-1.6-.825-1.6-1.616 0-.944.704-1.641 1.8-1.828v3.495l-.2-.05zm1.591 1.872c1.287.323 1.852.859 1.852 1.769 0 1.097-.826 1.828-2.2 1.939V8.73l.348.086z"/>
                    </svg>
                </IconContent>
            </StatCard>
            <StatCard Label="Preventivos" 
                      Value="@reportData.Count(r => r.MaintenanceType == "Preventivo").ToString()" 
                      Color="#4CAF50">
                <IconContent>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                        <path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/>
                    </svg>
                </IconContent>
            </StatCard>
            <StatCard Label="Correctivos" 
                      Value="@reportData.Count(r => r.MaintenanceType == "Correctivo").ToString()" 
                      Color="#FF9800">
                <IconContent>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                    </svg>
                </IconContent>
            </StatCard>
        </div>
    }

    <!-- Data Table -->
    <DataTable TItem="MaintenanceHistoryItemDto" Items="reportData" IsLoading="isLoading" ColumnCount="7" EmptyText="@GetEmptyMessage()">
        <HeaderTemplate>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>Descripción</th>
            <th>Técnico</th>
            <th>Costo</th>
            <th>Duración</th>
            <th>Estado</th>
        </HeaderTemplate>
        <RowTemplate Context="maintenance">
            <td>@maintenance.MaintenanceDate.ToString("dd/MM/yyyy")</td>
            <td>
                <span class="type-badge @GetTypeClass(maintenance.MaintenanceType)">
                    @maintenance.MaintenanceType
                </span>
            </td>
            <td>
                <div class="description-cell">
                    <span class="description-text">@maintenance.Description</span>
                </div>
            </td>
            <td>@maintenance.TechnicianName</td>
            <td>
                <span class="cost-value">$@maintenance.Cost.ToString("N0")</span>
            </td>
            <td>@maintenance.DurationHours h</td>
            <td>
                <span class="status-badge @GetMaintenanceStatusClass(maintenance.Status)">
                    @maintenance.Status
                </span>
            </td>
        </RowTemplate>
    </DataTable>

    <!-- Timeline View Toggle -->
    @if (reportData.Any())
    {
        <div class="timeline-section">
            <button class="btn-toggle-timeline" @onclick="ToggleTimeline">
                @(showTimeline ? "Ocultar Línea de Tiempo" : "Ver Línea de Tiempo")
            </button>

            @if (showTimeline)
            {
                <div class="timeline">
                    @foreach (var item in reportData.OrderByDescending(r => r.MaintenanceDate))
                    {
                        <div class="timeline-item @GetTypeClass(item.MaintenanceType)">
                            <div class="timeline-marker"></div>
                            <div class="timeline-content">
                                <div class="timeline-date">@item.MaintenanceDate.ToString("dd MMM yyyy")</div>
                                <div class="timeline-title">@item.MaintenanceType: @item.Description</div>
                                <div class="timeline-details">
                                    <span>Técnico: @item.TechnicianName</span>
                                    <span>Costo: $@item.Cost.ToString("N0")</span>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter]
    public int EquipmentId { get; set; }

    private List<MaintenanceHistoryItemDto> reportData = new();
    private List<EquipmentSearchResult> searchResults = new();
    private EquipmentInfo? selectedEquipment;
    private string searchTerm = "";
    private bool isLoading = true;
    private bool isExporting = false;
    private bool showTimeline = false;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        if (EquipmentId > 0)
        {
            await LoadEquipmentInfo();
            await LoadReport();
        }
        else
        {
            isLoading = false;
        }
    }

    private async Task LoadEquipmentInfo()
    {
        // In real implementation, this would fetch from a service
        selectedEquipment = new EquipmentInfo
        {
            Id = EquipmentId,
            Name = "Servidor Dell PowerEdge R720",
            Model = "PowerEdge R720",
            Category = "Servidores",
            Status = "Activo"
        };
        await Task.CompletedTask;
    }

    private async Task LoadReport()
    {
        if (EquipmentId == 0) return;

        try
        {
            isLoading = true;
            errorMessage = null;
            StateHasChanged();

            reportData = await ReportService.GetEquipmentMaintenanceHistoryAsync(EquipmentId);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al cargar el reporte: {ex.Message}";
            Console.WriteLine($"Error loading maintenance history report: {ex}");
            LoadMockData();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void LoadMockData()
    {
        reportData = new List<MaintenanceHistoryItemDto>
        {
            new() { MaintenanceDate = DateTime.Now.AddDays(-10), MaintenanceType = "Preventivo", Description = "Limpieza de componentes y revisión de conexiones", TechnicianName = "Carlos Rodríguez", Cost = 5000, DurationHours = 2, Status = "Completado" },
            new() { MaintenanceDate = DateTime.Now.AddDays(-45), MaintenanceType = "Correctivo", Description = "Reemplazo de fuente de poder", TechnicianName = "María González", Cost = 25000, DurationHours = 4, Status = "Completado" },
            new() { MaintenanceDate = DateTime.Now.AddDays(-90), MaintenanceType = "Preventivo", Description = "Actualización de firmware y parches de seguridad", TechnicianName = "Pedro Sánchez", Cost = 3000, DurationHours = 1, Status = "Completado" },
            new() { MaintenanceDate = DateTime.Now.AddDays(-180), MaintenanceType = "Correctivo", Description = "Reemplazo de disco duro defectuoso", TechnicianName = "Ana Martínez", Cost = 35000, DurationHours = 3, Status = "Completado" },
            new() { MaintenanceDate = DateTime.Now.AddDays(-270), MaintenanceType = "Preventivo", Description = "Revisión general y limpieza", TechnicianName = "Luis García", Cost = 4500, DurationHours = 2, Status = "Completado" }
        };
    }

    private void SearchEquipment()
    {
        if (string.IsNullOrWhiteSpace(searchTerm)) 
        {
            searchResults.Clear();
            return;
        }

        // Mock search results
        searchResults = new List<EquipmentSearchResult>
        {
            new(101, "Servidor Dell PowerEdge R720"),
            new(102, "Laptop Dell XPS 15"),
            new(103, "Monitor LG UltraWide 34\""),
            new(104, "Impresora HP LaserJet Pro")
        }.Where(e => e.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) || 
                     e.Id.ToString().Contains(searchTerm)).ToList();

        StateHasChanged();
    }

    private async Task SelectEquipment(int equipmentId)
    {
        EquipmentId = equipmentId;
        searchResults.Clear();
        searchTerm = "";
        await LoadEquipmentInfo();
        await LoadReport();
    }

    private void ToggleTimeline()
    {
        showTimeline = !showTimeline;
    }

    private string GetPageTitle() => 
        selectedEquipment != null 
            ? $"Historial - {selectedEquipment.Name}" 
            : "Historial de Mantenimiento";

    private string GetEmptyMessage() =>
        EquipmentId == 0 
            ? "Busque un equipo para ver su historial de mantenimiento" 
            : "No hay registros de mantenimiento para este equipo";

    private string GetStatusClass(string status) => status switch
    {
        "Activo" => "active",
        "En Mantenimiento" => "maintenance",
        "Inactivo" => "inactive",
        _ => "default"
    };

    private string GetTypeClass(string type) => type switch
    {
        "Preventivo" => "preventive",
        "Correctivo" => "corrective",
        _ => "default"
    };

    private string GetMaintenanceStatusClass(string status) => status switch
    {
        "Completado" => "completed",
        "En Progreso" => "in-progress",
        "Pendiente" => "pending",
        _ => "default"
    };

    private async Task ExportToPdf()
    {
        if (EquipmentId == 0) return;

        try
        {
            isExporting = true;
            StateHasChanged();

            var pdfBytes = await ReportService.ExportToPdfAsync($"equipment-maintenance-{EquipmentId}");
            if (pdfBytes != null && pdfBytes.Length > 0)
            {
                var base64 = Convert.ToBase64String(pdfBytes);
                await JS.InvokeVoidAsync("downloadFile", $"historial-mantenimiento-{EquipmentId}.pdf", "application/pdf", base64);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error exporting PDF: {ex.Message}");
        }
        finally
        {
            isExporting = false;
            StateHasChanged();
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/reportes");
    }

    // Local helper classes
    public class EquipmentInfo
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public string Model { get; set; } = "";
        public string Category { get; set; } = "";
        public string Status { get; set; } = "";
    }

    private record EquipmentSearchResult(int Id, string Name);
}
