@using InfraGestion.Web.Features.Inventory.Models
@using InfraGestion.Web.Features.Organization.Models
@using InfraGestion.Web.Features.Organization.Services
@using InfraGestion.Web.Features.Users.Models
@using InfraGestion.Web.Features.Users.Services
@using InfraGestion.Web.Features.Transfers.DTOs
@using InfraGestion.Web.Features.Transfers.Services
@using InfraGestion.Web.Shared.Components
@inject OrganizationService OrganizationService
@inject UserService UserService
@inject TransferService TransferService

<Modal IsOpen="@IsOpen" Title="Iniciar Traslado de Equipo" OnClose="@HandleClose">
    <form class="transfer-form" @onsubmit="HandleSubmit" @onsubmit:preventDefault="true">
        @if (isLoading)
        {
            <div class="loading-container">
                <div class="spinner"></div>
                <p>Cargando información...</p>
            </div>
        }
        else
        {
            <div class="form-section">
                <!-- Device Info (Read-only) -->
                <div class="form-group">
                    <label class="form-label">
                        ID del Equipo
                    </label>
                    <input type="text"
                           class="form-control readonly-field"
                           value="@($"DEV{DeviceId:D3}")"
                           readonly
                           disabled />
                    <span class="field-hint">Este campo no es editable</span>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        Nombre del Equipo
                    </label>
                    <input type="text"
                           class="form-control readonly-field"
                           value="@DeviceName"
                           readonly
                           disabled />
                    <span class="field-hint">Este campo no es editable</span>
                </div>

                <!-- Origin Section (Read-only) -->
                <div class="form-group">
                    <label class="form-label">
                        Sección de Origen
                    </label>
                    <input type="text"
                           class="form-control readonly-field"
                           value="@OriginSectionName"
                           readonly
                           disabled />
                    <span class="field-hint">Sección actual del equipo</span>
                </div>

                <!-- Destination Section (Dropdown) -->
                <div class="form-group">
                    <label class="form-label">
                        Sección de Destino <span class="required">*</span>
                    </label>
                    <select class="form-control" @bind="selectedDestinationSectionName" required>
                        <option value="">Seleccione una sección</option>
                        @foreach (var destSection in GetAvailableSections())
                        {
                            <option value="@destSection.Name">@destSection.Name</option>
                        }
                    </select>
                </div>

                <!-- Device Receiver (Logistician Dropdown) -->
                <div class="form-group">
                    <label class="form-label">
                        Receptor del Equipo <span class="required">*</span>
                    </label>
                    <select class="form-control" @bind="selectedReceiverUsername" required>
                        <option value="">Seleccione un logístico</option>
                        @foreach (var logistician in logisticians)
                        {
                            <option value="@logistician.Name">@logistician.Name</option>
                        }
                    </select>
                    <span class="field-hint">Usuario logístico que recibirá el equipo</span>
                </div>

                <!-- Transfer Date -->
                <div class="form-group">
                    <label class="form-label">
                        Fecha del Traslado <span class="required">*</span>
                    </label>
                    <input type="datetime-local"
                           class="form-control"
                           @bind="transferDate"
                           required />
                </div>
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="error-message">
                    <svg class="error-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm-8,56a8,8,0,0,1,16,0v56a8,8,0,0,1-16,0Zm8,104a12,12,0,1,1,12-12A12,12,0,0,1,128,184Z"/>
                    </svg>
                    <span>@errorMessage</span>
                </div>
            }

            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="success-message">
                    <svg class="success-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm45.66,85.66-56,56a8,8,0,0,1-11.32,0l-24-24a8,8,0,0,1,11.32-11.32L112,148.69l50.34-50.35a8,8,0,0,1,11.32,11.32Z"/>
                    </svg>
                    <span>@successMessage</span>
                </div>
            }

            <div class="form-actions">
                <button type="button" class="btn btn-cancel" @onclick="HandleClose" disabled="@isSubmitting">
                    Cancelar
                </button>
                <button type="submit" class="btn btn-submit" disabled="@(isSubmitting || !IsFormValid())">
                    @if (isSubmitting)
                    {
                        <span class="spinner-small"></span>
                        <span>Procesando...</span>
                    }
                    else
                    {
                        <span>Iniciar Traslado</span>
                    }
                </button>
            </div>
        }
    </form>
</Modal>

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public int DeviceId { get; set; }
    [Parameter] public string DeviceName { get; set; } = string.Empty;
    [Parameter] public string OriginSectionName { get; set; } = string.Empty;
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback<bool> OnTransferCompleted { get; set; }

    // Dropdown data
    private List<Section> sections = new();
    private List<User> logisticians = new();

    // Form values
    private string selectedDestinationSectionName = string.Empty;
    private string selectedReceiverUsername = string.Empty;
    private DateTime transferDate = DateTime.Now;

    // State
    private bool isLoading = false;
    private bool isSubmitting = false;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;

    // Helper method to get available sections (excluding origin)
    private List<Section> GetAvailableSections()
    {
        return sections.Where(s => s.Name != OriginSectionName).ToList();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (IsOpen && sections.Count == 0)
        {
            await LoadDropdownData();
        }
        
        // Reset form when opening with new device
        if (IsOpen)
        {
            ResetForm();
        }
    }

    private async Task LoadDropdownData()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            // Load sections and logisticians in parallel
            var sectionsTask = OrganizationService.GetAllSectionsAsync();
            var logisticiansTask = UserService.GetUsersByRoleAsync("Logistician");

            await Task.WhenAll(sectionsTask, logisticiansTask);

            sections = await sectionsTask;
            logisticians = await logisticiansTask;

            Console.WriteLine($"[DEBUG] InitiateTransferModal - Loaded {sections.Count} sections and {logisticians.Count} logisticians");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[ERROR] InitiateTransferModal.LoadDropdownData: {ex.Message}");
            errorMessage = "Error al cargar los datos. Por favor, intente nuevamente.";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void ResetForm()
    {
        selectedDestinationSectionName = string.Empty;
        selectedReceiverUsername = string.Empty;
        transferDate = DateTime.Now;
        errorMessage = string.Empty;
        successMessage = string.Empty;
    }

    private bool IsFormValid()
    {
        return !string.IsNullOrEmpty(selectedDestinationSectionName)
            && !string.IsNullOrEmpty(selectedReceiverUsername)
            && !string.IsNullOrEmpty(DeviceName);
    }

    private async Task HandleSubmit()
    {
        if (isSubmitting || !IsFormValid()) return;

        isSubmitting = true;
        errorMessage = string.Empty;
        successMessage = string.Empty;
        StateHasChanged();

        try
        {
            var request = new InitiateTransferDto
            {
                DeviceName = DeviceName,
                DestinationSectionName = selectedDestinationSectionName,
                DeviceReceiverUsername = selectedReceiverUsername,
                TransferDate = transferDate
            };

            Console.WriteLine($"[DEBUG] InitiateTransferModal - Submitting transfer: Device={request.DeviceName}, Destination={request.DestinationSectionName}, Receiver={request.DeviceReceiverUsername}");

            var success = await TransferService.InitiateTransferAsync(request);

            if (success)
            {
                successMessage = "Traslado iniciado correctamente.";
                StateHasChanged();
                
                // Wait a moment to show success message, then close
                await Task.Delay(1500);
                await OnTransferCompleted.InvokeAsync(true);
                await HandleClose();
            }
            else
            {
                errorMessage = "Error al iniciar el traslado. Por favor, verifique los datos e intente nuevamente.";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[ERROR] InitiateTransferModal.HandleSubmit: {ex.Message}");
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    private async Task HandleClose()
    {
        if (!isSubmitting)
        {
            ResetForm();
            await OnClose.InvokeAsync();
        }
    }
}
