@page "/transfers"
@using InfraGestion.Web.Features.Transfers.Models
@using InfraGestion.Web.Features.Transfers.Services
@using InfraGestion.Web.Features.Transfers.Components
@inject TransferService TransferService
@inject Inventory.Services.DeviceService  DeviceService;
@inject Organization.Services.OrganizationService OrganizationService;
@inject NavigationManager Navigation

<PageTitle>Gestión de Traslados - InfraCom</PageTitle>

<div class="transfers-page">
    <!-- Header -->
    <div class="page-header-wrapper">
        <div class="page-header">
            <div class="header-text">
                <h1 class="page-title">Gestión de Traslados</h1>
                <p class="page-description">Administración de traslados de equipos entre secciones de la empresa</p>
            </div>
            <div class="header-actions">
                <button class="btn-add-primary" @onclick="OpenCreateModal">
                    <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M228,128a12,12,0,0,1-12,12H140v76a12,12,0,0,1-24,0V140H40a12,12,0,0,1,0-24h76V40a12,12,0,0,1,24,0v76h76A12,12,0,0,1,228,128Z" />
                    </svg>
                    Agregar Traslado
                </button>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filters-container">
        <div class="search-box">
            <svg class="search-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z" />
            </svg>
            <input type="text" class="search-input" placeholder="Buscar por nombre ..." @bind="searchTerm"
                @bind:event="oninput" @bind:after="HandleSearch" />
        </div>

        <div class="filter-group">
            <select class="filter-select" @bind="selectedDateFilter" @bind:after="HandleFilterChange">
                <option value="">Fecha: Todos</option>
                <option value="2024">2024</option>
                <option value="2023">2023</option>
                <option value="2022">2022</option>
                <option value="2021">2021</option>
            </select>

            <button class="btn-export">
                <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M74.34,85.66A8,8,0,0,1,85.66,74.34L120,108.69V24a8,8,0,0,1,16,0v84.69l34.34-34.35a8,8,0,0,1,11.32,11.32l-48,48a8,8,0,0,1-11.32,0ZM240,136v64a16,16,0,0,1-16,16H32a16,16,0,0,1-16-16V136a16,16,0,0,1,16-16H84.4a4,4,0,0,1,2.83,1.17L111,145A24,24,0,0,0,145,145l23.8-23.8A4,4,0,0,1,171.6,120H224A16,16,0,0,1,240,136Zm-40,32a12,12,0,1,0-12,12A12,12,0,0,0,200,168Z" />
                </svg>
                Exportar
            </button>
        </div>
    </div>

    <!-- Table -->
    <div class="table-container">
        <table class="transfers-table">
            <thead>
                <tr>
                    <th>ID de equipo</th>
                    <th>Nombre del equipo</th>
                    <th>Origen</th>
                    <th>Destino</th>
                    <th>Fecha</th>
                    <th class="actions-column"></th>
                </tr>
            </thead>
            <tbody>
                @if (isLoading)
                {
                    <tr>
                        <td colspan="6" class="loading-cell">
                            <div class="spinner"></div>
                            <span>Cargando datos...</span>
                        </td>
                    </tr>
                }
                else if (filteredTransfers == null || !filteredTransfers.Any())
                {
                    <tr>
                        <td colspan="6" class="empty-cell">
                            <svg class="empty-icon" viewBox="0 0 256 256" fill="currentColor"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z" />
                            </svg>
                            <p>No se encontraron registros que coincidan con los filtros aplicados</p>
                        </td>
                    </tr>
                }
                else
                {
                    @foreach (var transfer in filteredTransfers)
                    {
                        <tr>
                            <td class="device-id-cell">>@($"DEV{transfer.DeviceId}")</td>
                            <td class="device-name-cell">@transfer.DeviceName</td>
                            <td class="origin-cell">@transfer.SourceSectionName</td>
                            <td class="destination-cell">@transfer.DestinationSectionName</td>
                            <td class="date-cell">@transfer.TransferDate.ToString("dd/MM/yyyy")</td>
                            <td class="actions-cell">
                                <button class="btn-action btn-edit" @onclick="() => OpenEditModal(transfer.TransferId)" title="Editar">
                                    <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path
                                            d="M229.66,58.34l-32-32a8,8,0,0,0-11.32,0l-96,96A8,8,0,0,0,88,128v32a8,8,0,0,0,8,8h32a8,8,0,0,0,5.66-2.34l96-96A8,8,0,0,0,229.66,58.34ZM124.69,152H104V131.31l64-64L188.69,88ZM200,76.69,179.31,56,192,43.31,212.69,64ZM224,128v80a16,16,0,0,1-16,16H48a16,16,0,0,1-16-16V48A16,16,0,0,1,48,32h80a8,8,0,0,1,0,16H48V208H208V128a8,8,0,0,1,16,0Z" />
                                    </svg>
                                </button>
                                <button class="btn-action btn-delete"
                                    @onclick="() => OpenDeleteConfirmModal(transfer.TransferId, transfer.DeviceName)" title="Eliminar">
                                    <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path
                                            d="M216,48H176V40a24,24,0,0,0-24-24H104A24,24,0,0,0,80,40v8H40a8,8,0,0,0,0,16h8V208a16,16,0,0,0,16,16H192a16,16,0,0,0,16-16V64h8a8,8,0,0,0,0-16ZM112,168a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Zm48,0a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Zm0-120H96V40a8,8,0,0,1,8-8h48a8,8,0,0,1,8,8Z" />
                                    </svg>
                                </button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Create Transfer Modal -->
<InfraGestion.Web.Shared.Components.Modal IsOpen="@showCreateModal" Title="Agregar Traslado"
    OnClose="@CloseCreateModal">
    <TransferForm FormModel="@createRequest" Devices="@devices" Locations="@locations" OnValidSubmit="@HandleCreate"
        OnCancel="@CloseCreateModal" />
</InfraGestion.Web.Shared.Components.Modal>

<!-- Edit Transfer Modal -->
<InfraGestion.Web.Shared.Components.Modal IsOpen="@showEditModal" Title="Editar Traslado" OnClose="@CloseEditModal">
    <TransferFormEdit FormModel="@updateRequest" Devices="@devices" Locations="@locations" OnValidSubmit="@HandleUpdate"
        OnCancel="@CloseEditModal" />
</InfraGestion.Web.Shared.Components.Modal>

<!-- Delete Confirm Modal -->
<InfraGestion.Web.Shared.Components.ConfirmDialog IsOpen="@showDeleteConfirmModal" Title="Confirmar Eliminación"
    Message="@deleteConfirmMessage" ConfirmText="Eliminar" CancelText="Cancelar" OnConfirm="@HandleDeleteTransfer"
    OnCancel="@CloseDeleteConfirmModal" />

@code {







    // Data
    private List<Transfer> allTransfers = new();
    private List<Transfer> filteredTransfers = new();
    private List<(string Id, string Name)> devices = new();
    private List<string> locations = new();
    private bool isLoading = true;

    // Filters
    private string searchTerm = string.Empty;
    private string selectedDateFilter = string.Empty;

    // Modals
    private bool showCreateModal = false;
    private bool showEditModal = false;
    private CreateTransferRequest createRequest = new();
    private UpdateTransferRequest updateRequest = new();

    // Delete confirmation
    private bool showDeleteConfirmModal = false;
    private int transferIdToDelete = 0;
    private string deleteConfirmMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;

        allTransfers = await TransferService.GetAllTransfersAsync();

        devices = (await DeviceService.GetAllDevicesAsync()).Select(x => ($"DEV-{x.Id}", x.Name)).ToList();
        locations = (await OrganizationService.GetAllSectionsAsync()).Select(x=>x.Name).ToList();
        ApplyFilters();
        isLoading = false;
    }

    private void HandleSearch()
    {
        ApplyFilters();
    }

    private void HandleFilterChange()
    {
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        var query = allTransfers.AsEnumerable();

        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            query = query.Where(t =>
                t.DeviceName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                t.SourceSectionName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                t.DestinationSectionName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrEmpty(selectedDateFilter) && int.TryParse(selectedDateFilter, out int year))
        {
            query = query.Where(t => t.TransferDate.Year == year);
        }

        filteredTransfers = query.ToList();
    }

    // Modal handlers
    private void OpenCreateModal()
    {
        createRequest = new CreateTransferRequest
        {
            TransferDate = DateTime.Now
        };
        showCreateModal = true;
    }

    private void CloseCreateModal()
    {
        showCreateModal = false;
        createRequest = new CreateTransferRequest();
    }

    private async Task HandleCreate(CreateTransferRequest request)
    {
        await TransferService.CreateTransferAsync(request);
        await LoadData();
        CloseCreateModal();
    }

    private async Task OpenEditModal(int transferId)
    {
        var transfer = await TransferService.GetTransferByIdAsync(transferId);
        if (transfer != null)
        {
            updateRequest = new UpdateTransferRequest
            {
                Id = transfer.TransferId,
                DeviceId = transfer.DeviceId,
                Origin = transfer.SourceSectionName,
                Destination = transfer.DestinationSectionName,
                TransferDate = transfer.TransferDate,
                ReceiverName = transfer.DeviceReceiverName,
                Notes = transfer.Notes
            };
            showEditModal = true;
        }
    }

    private void CloseEditModal()
    {
        showEditModal = false;
        updateRequest = new UpdateTransferRequest();
    }

    private async Task HandleUpdate(UpdateTransferRequest request)
    {
        await TransferService.UpdateTransferAsync(request);
        await LoadData();
        CloseEditModal();
    }

    // Delete handlers
    private void OpenDeleteConfirmModal(int transferId, string deviceName)
    {
        transferIdToDelete = transferId;
        deleteConfirmMessage = $"¿Está seguro que desea eliminar el traslado del equipo \"{deviceName}\"? Esta acción no se puede deshacer.";
        showDeleteConfirmModal = true;
    }

    private void CloseDeleteConfirmModal()
    {
        showDeleteConfirmModal = false;
        transferIdToDelete = 0;
        deleteConfirmMessage = string.Empty;
    }

    private async Task HandleDeleteTransfer()
    {
        var success = await TransferService.DeleteTransferAsync(transferIdToDelete);
        await LoadData();
        CloseDeleteConfirmModal();
    }
}