@page "/technician/profile"
@using InfraGestion.Web.Features.Technicians.Models
@using InfraGestion.Web.Features.Technicians.Services
@using InfraGestion.Web.Features.Technicians.Helpers
@using InfraGestion.Web.Features.Auth.Services
@inject TechnicianService TechnicianService
@inject AuthService AuthService
@inject NavigationManager Navigation

@if (isLoading)
{
    <div class="loading-container">
        <div class="spinner"></div>
        <p>Cargando perfil...</p>
    </div>
}
else if (technician == null)
{
    <div class="error-container">
        <p>No se pudo cargar la información del perfil.</p>
        <button class="btn-retry" @onclick="LoadProfile">Reintentar</button>
    </div>
}
else
{
    <div class="technician-profile-page">
        <!-- Header -->
        <div class="profile-header">
            <div class="header-content">
                <h1 class="technician-title">@technician.Name</h1>
                <span class="status-badge @TechnicianStatusHelper.GetStatusBadgeClass(technician.Status)">
                    <span class="status-dot"></span>
                    @TechnicianStatusHelper.GetStatusDisplayName(technician.Status)
                </span>
            </div>
            <p class="page-description">Perfil detallado de un miembro del personal técnico</p>
        </div>

        <!-- Main Content -->
        <div class="profile-content">
            <!-- Left Column: Main Details -->
            <div class="details-card">
                <h2 class="card-title">Detalles Principales</h2>
                <div class="details-grid">
                    <div class="detail-item">
                        <span class="detail-label">Especialidad</span>
                        <span class="detail-value">@technician.Specialty</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Número de Identificación</span>
                        <span class="detail-value technician-id">@technician.IdentificationNumber</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Fecha de creación de la cuenta</span>
                        <span class="detail-value">@technician.HireDate.ToString("dd/MM/yyyy")</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Años de experiencia</span>
                        <span class="detail-value">@technician.YearsOfExperience</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Promedio de Valoraciones</span>
                        <span class="detail-value">@technician.Rating.ToString("0.0", System.Globalization.CultureInfo.InvariantCulture)/5.0</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Fecha de la última intervención</span>
                        <span class="detail-value">@(technician.LastInterventionDate?.ToString("dd/MM/yyyy") ?? "N/A")</span>
                    </div>
                </div>
            </div>

            <!-- Right Column: Location -->
            <div class="location-card">
                <h2 class="card-title">Ubicación</h2>
                <div class="location-info">
                    <div class="location-item">
                        <span class="location-label">Sección</span>
                        <span class="location-value">@technician.Section</span>
                    </div>
                    <div class="location-item">
                        <span class="location-label">Departamento</span>
                        <span class="location-value">@technician.Department</span>
                    </div>
                    <div class="location-item">
                        <span class="location-label">Responsable de Sección</span>
                        <span class="location-value">@technician.SectionManager</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Maintenance History -->
        <div class="history-section">
            <h2 class="section-title">Historial de Mantenimientos Realizados</h2>
            <div class="table-container">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>FECHA</th>
                            <th>TIPO</th>
                            <th>EQUIPO</th>
                            <th>NOTAS</th>
                            <th>COSTO</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (technician.MaintenanceHistory == null || !technician.MaintenanceHistory.Any())
                        {
                            <tr>
                                <td colspan="5" class="empty-cell">
                                    No se encontraron registros de mantenimiento
                                </td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var maintenance in technician.MaintenanceHistory)
                            {
                                <tr>
                                    <td>@maintenance.Date.ToString("dd/MM/yyyy")</td>
                                    <td>
                                        <span class="maintenance-type-badge @GetMaintenanceTypeClass(maintenance.Type)">
                                            <span class="type-dot"></span>
                                            @maintenance.Type
                                        </span>
                                    </td>
                                    <td>@maintenance.DeviceName</td>
                                    <td>@maintenance.Notes</td>
                                    <td>@maintenance.Cost.ToString("F2")</td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Decommission Proposals -->
        <div class="history-section">
            <h2 class="section-title">Proposiciones de Baja</h2>
            <div class="table-container">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>FECHA</th>
                            <th>EQUIPO</th>
                            <th>CAUSA</th>
                            <th>RECEPTOR</th>
                            <th>ESTADO</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (technician.DecommissionProposals == null || !technician.DecommissionProposals.Any())
                        {
                            <tr>
                                <td colspan="5" class="empty-cell">
                                    No se encontraron proposiciones de baja
                                </td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var proposal in technician.DecommissionProposals)
                            {
                                <tr>
                                    <td>@proposal.Date.ToString("dd/MM/yyyy")</td>
                                    <td>@(proposal.DeviceName)</td>
                                    <td>@proposal.Cause</td>
                                    <td>@proposal.Receiver</td>
                                    <td>
                                        <span class="proposal-status @TechnicianStatusHelper.GetProposalStatusClass(proposal.Status)">
                                            @proposal.Status
                                        </span>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Ratings -->
        <div class="history-section">
            <h2 class="section-title">Valoraciones</h2>
            <div class="table-container">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>FECHA EMISIÓN</th>
                            <th>EMISOR</th>
                            <th>PUNTUACIÓN</th>
                            <th>DESCRIPCIÓN</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (technician.Ratings == null || !technician.Ratings.Any())
                        {
                            <tr>
                                <td colspan="4" class="empty-cell">
                                    No se encontraron valoraciones
                                </td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var rating in technician.Ratings)
                            {
                                <tr>
                                    <td>@rating.Date.ToString("dd/MM/yyyy")</td>
                                    <td>@rating.Issuer</td>
                                    <td>@rating.Score.ToString("0.0", System.Globalization.CultureInfo.InvariantCulture)</td>
                                    <td>@rating.Description</td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>

    </div>
}

@code {
    private TechnicianDetails? technician;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadProfile();
    }

    private async Task LoadProfile()
    {
        try
        {
            isLoading = true;
            
            // Get current logged-in user
            var currentUser = await AuthService.GetCurrentUserAsync();
            if (currentUser == null)
            {
                Navigation.NavigateTo("/login");
                return;
            }

            // Load technician details using the current user's ID
            technician = await TechnicianService.GetTechnicianDetailsAsync(currentUser.Id);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading profile: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetMaintenanceTypeClass(string type)
    {
        return type?.ToLower() switch
        {
            "preventivo" => "type-preventivo",
            "correctivo" => "type-correctivo",
            "predictivo" => "type-predictivo",
            _ => "type-default"
        };
    }
}
