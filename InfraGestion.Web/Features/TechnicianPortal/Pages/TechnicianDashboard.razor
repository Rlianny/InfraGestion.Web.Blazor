@page "/technician/dashboard"
@using InfraGestion.Web.Features.Auth.Services
@using InfraGestion.Web.Features.Inventory.Services
@using InfraGestion.Web.Features.TechnicianPortal.Components
@using InfraGestion.Web.Features.Inventory.DTOs
@using InfraGestion.Web.Features.Inventory.Models
@inject AuthService AuthService
@inject InspectionService InspectionService
@inject DeviceService DeviceService
@inject DecommissioningService DecommissioningService
@inject MaintenanceService MaintenanceService

<PageTitle>Dashboard Técnico - InfraCom</PageTitle>

<h1 class="page-title">Dashboard</h1>

<div class="dashboard-content">
    <!-- Quick Actions Section -->
    <div class="quick-actions-card">
        <h2 class="card-title">Acciones Rápidas</h2>
        <div class="action-buttons">
            <button class="btn-action btn-primary" @onclick="RegisterMaintenance">
                <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M224,128a8,8,0,0,1-8,8H136v80a8,8,0,0,1-16,0V136H40a8,8,0,0,1,0-16h80V40a8,8,0,0,1,16,0v80h80A8,8,0,0,1,224,128Z" />
                </svg>
                Registrar Mantenimiento
            </button>
            <button class="btn-action btn-danger" @onclick="CreateDecommissionRequest">
                <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M224,128a8,8,0,0,1-8,8H136v80a8,8,0,0,1-16,0V136H40a8,8,0,0,1,0-16h80V40a8,8,0,0,1,16,0v80h80A8,8,0,0,1,224,128Z" />
                </svg>
                Crear solicitud de baja
            </button>
        </div>
    </div>

    <!-- Pending Initial Defect Requests Section -->
    <div class="pending-requests-card">
        <h2 class="card-title">Solicitudes de Defectación Inicial pendientes</h2>

        @if (isLoading)
        {
            <div class="loading-state">Cargando solicitudes...</div>
        }
        else if (!pendingRequests.Any())
        {
            <div class="empty-state">No hay solicitudes pendientes</div>
        }
        else
        {
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>FECHA EMISIÓN</th>
                            <th>ID EQUIPO</th>
                            <th>NOMBRE DEL EQUIPO</th>
                            <th>SOLICITANTE</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var request in pendingRequests)
                        {
                            <tr>
                                <td>@request.EmissionDate.ToString("dd/MM/yyyy")</td>
                                <td>@request.FormatedDeviceId</td>
                                <td>@request.DeviceName</td>
                                <td>@request.RequesterName</td>
                                <td>
                                    <button class="btn-icon-action" @onclick="() => OpenReviewModal(request)"
                                        title="Revisar solicitud">
                                        <svg class="action-icon" viewBox="0 0 256 256" fill="currentColor"
                                            xmlns="http://www.w3.org/2000/svg">
                                            <path
                                                d="M229.66,58.34l-32-32a8,8,0,0,0-11.32,0l-96,96A8,8,0,0,0,88,128v32a8,8,0,0,0,8,8h32a8,8,0,0,0,5.66-2.34l96-96A8,8,0,0,0,229.66,58.34ZM124.69,152H104V131.31l64-64L188.69,88ZM200,76.69,179.31,56,192,43.31,212.69,64ZM224,128v80a16,16,0,0,1-16,16H48a16,16,0,0,1-16-16V48A16,16,0,0,1,48,32h80a8,8,0,0,1,0,16H48V208H208V128a8,8,0,0,1,16,0Z" />
                                        </svg>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

<!-- Review Modal -->
<Modal IsOpen="@showReviewModal" Title="Revisar Solicitud de Defectación Inicial" OnClose="@CloseReviewModal">
    <InitialInspectionReviewForm Request="@selectedRequest" OnReviewComplete="@HandleReviewComplete" />
</Modal>

<!-- Maintenance Modal -->
<Modal IsOpen="@showMaintenanceModal" Title="Registrar Mantenimiento" OnClose="@CloseMaintenanceModal">
    <MaintenanceForm FormModel="@maintenanceRequest" 
                     AvailableDevices="@availableDevices"
                     PreselectedDeviceId="@null"
                     OnValidSubmit="@HandleMaintenanceSubmit" 
                     OnCancel="@CloseMaintenanceModal"
                     IsSubmitting="@isSubmitting" />
</Modal>

<!-- Decommissioning Modal -->
<Modal IsOpen="@showDecommissioningModal" Title="Crear Solicitud de Baja" OnClose="@CloseDecommissioningModal">
    <DecommissioningRequestForm FormModel="@decommissioningRequest" 
                                AvailableDevices="@availableDevices"
                                PreselectedDeviceId="@null"
                                OnValidSubmit="@HandleDecommissioningSubmit" 
                                OnCancel="@CloseDecommissioningModal"
                                IsSubmitting="@isSubmitting" />
</Modal>

@code {
    private bool isLoading = true;
    private bool showReviewModal = false;
    private bool showMaintenanceModal = false;
    private bool showDecommissioningModal = false;
    private bool isSubmitting = false;
    private List<PendingInspection> pendingRequests = new();
    private PendingInspection selectedRequest = new();
    private int currentTechnicianId = 0;

    // Modal data
    private List<Device> availableDevices = new();
    private CreateMaintenanceRequest maintenanceRequest = new();
    private CreateDecommissioningRequest decommissioningRequest = new();

    protected override async Task OnInitializedAsync()
    {
        // Get current user's technician ID
        var currentUser = await AuthService.GetCurrentUserAsync();
        if (currentUser != null)
        {
            currentTechnicianId = currentUser.Id;
        }

        await LoadPendingRequests();
        await LoadAvailableDevices();
    }

    private async Task LoadPendingRequests()
    {
        isLoading = true;
        StateHasChanged();

        try
        {

            // Get pending inspection requests from backend
            List<Inventory.DTOs.InspectionRequestDto>? requests = await
            InspectionService.GetPendingInspectionsAsync(currentTechnicianId);


            // Map backend DTOs to UI model
            pendingRequests = requests.Select(r => new PendingInspection
            {
                Id = r.RequestId,
                DeviceId = r.DeviceId,
                DeviceName = r.DeviceName,
                TechnicianId = r.TechnicianId,
                EmissionDate = r.RequestDate,
                RequesterName = string.IsNullOrWhiteSpace(r.RequesterFullName)
            ? $"Usuario #{r.RequesterId}"
            : r.RequesterFullName
            }).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[ERROR] TechnicianDashboard - LoadPendingRequests: {ex.Message}");
            pendingRequests = new List<PendingInspection>();
        }

        isLoading = false;
        StateHasChanged();
    }

    private async Task LoadAvailableDevices()
    {
        try
        {
            // Get all devices for modal selection
            availableDevices = await DeviceService.GetAllDevicesAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[ERROR] LoadAvailableDevices: {ex.Message}");
            availableDevices = new List<Device>();
        }
    }

    // Maintenance Modal Handlers
    private void RegisterMaintenance()
    {
        maintenanceRequest = new CreateMaintenanceRequest
        {
            TechnicianId = currentTechnicianId,
            MaintenanceDate = DateTime.Now,
            MaintenanceType = MaintenanceType.Preventive
        };
        showMaintenanceModal = true;
    }

    private void CloseMaintenanceModal()
    {
        showMaintenanceModal = false;
        maintenanceRequest = new();
    }

    private async Task HandleMaintenanceSubmit(CreateMaintenanceRequest request)
    {
        isSubmitting = true;
        try
        {
            var success = await MaintenanceService.CreateMaintenanceRecordAsync(request);
            if (success)
            {
                await LoadAvailableDevices();
            }
            CloseMaintenanceModal();
        }
        finally
        {
            isSubmitting = false;
        }
    }

    // Decommissioning Modal Handlers
    private void CreateDecommissionRequest()
    {
        decommissioningRequest = new CreateDecommissioningRequest
        {
            TechnicianId = currentTechnicianId,
            RequestDate = DateTime.Now
        };
        showDecommissioningModal = true;
    }

    private void CloseDecommissioningModal()
    {
        showDecommissioningModal = false;
        decommissioningRequest = new();
    }

    private async Task HandleDecommissioningSubmit(CreateDecommissioningRequest request)
    {
        isSubmitting = true;
        try
        {
            var success = await DecommissioningService.CreateDecommissioningRequestAsync(request);
            if (success)
            {
                await LoadAvailableDevices();
            }
            CloseDecommissioningModal();
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void OpenReviewModal(PendingInspection request)
    {
        selectedRequest = request;
        showReviewModal = true;
    }

    private void CloseReviewModal()
    {
        showReviewModal = false;
        selectedRequest = new();
    }

    private async Task HandleReviewComplete(InspectionDecisionDto result)
    {
        bool success = await InspectionService.ProcessInspectionDecisionAsync(result);
        CloseReviewModal();
        await LoadPendingRequests();
    }
}