@using InfraGestion.Web.Features.Inventory.Models
@using InfraGestion.Web.Features.Inventory.DTOs


<div class="review-form">
    <!-- Device Info Summary -->
    <div class="device-info-section">
        <div class="info-row">
            <span class="info-label">ID Equipo:</span>
            <span class="info-value">@Request.FormatedDeviceId</span>
        </div>
        <div class="info-row">
            <span class="info-label">Nombre del Equipo:</span>
            <span class="info-value">@Request.DeviceName</span>
        </div>
        <div class="info-row">
            <span class="info-label">Fecha de Emisión:</span>
            <span class="info-value">@Request.EmissionDate.ToString("dd/MM/yyyy")</span>
        </div>
        <div class="info-row">
            <span class="info-label">Solicitante:</span>
            <span class="info-value">@Request.RequesterName</span>
        </div>
    </div>

    <div class="form-group">
        <label for="rejectionReason" class="form-label">Motivo de Rechazo</label>
        <select id="rejectionReason" 
                class="form-input form-select" 
                @bind="selectedRejectionReason"
                disabled="@isProcessing">
            <option value="">-- Seleccione un motivo (solo si rechaza) --</option>
            <option value="@DecommissioningReason.IrreparableTechnicalFailure">Fallo técnico irreparable</option>
            <option value="@DecommissioningReason.TechnologicalObsolescence">Obsolescencia tecnológica</option>
            <option value="@DecommissioningReason.EOL">Fin de vida útil</option>
            <option value="@DecommissioningReason.ExcessiveRepairCost">Costo de reparación excesivo</option>
            <option value="@DecommissioningReason.SeverePhysicalDamage">Daño físico severo</option>
            <option value="@DecommissioningReason.IncompatibilityWithNewInfrastructure">Incompatibilidad con nueva infraestructura</option>
            <option value="@DecommissioningReason.PlannedTechnologyUpgrade">Actualización tecnológica planificada</option>
            <option value="@DecommissioningReason.TheftOrLoss">Robo o pérdida</option>
            <option value="@DecommissioningReason.CustomerContractTermination">Terminación de contrato</option>
        </select>
        
        @if (!string.IsNullOrEmpty(validationError))
        {
            <div class="validation-message">@validationError</div>
        }
    </div>

    <div class="form-actions">
        <button type="button" 
                class="btn-reject" 
                @onclick="HandleReject" 
                disabled="@isProcessing">
            <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path d="M205.66,194.34a8,8,0,0,1-11.32,11.32L128,139.31,61.66,205.66a8,8,0,0,1-11.32-11.32L116.69,128,50.34,61.66A8,8,0,0,1,61.66,50.34L128,116.69l66.34-66.35a8,8,0,0,1,11.32,11.32L139.31,128Z" />
            </svg>
            @(isProcessing ? "Procesando..." : "Rechazar")
        </button>
        <button type="button" 
                class="btn-accept" 
                @onclick="HandleAccept" 
                disabled="@isProcessing">
            <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path d="M229.66,77.66l-128,128a8,8,0,0,1-11.32,0l-56-56a8,8,0,0,1,11.32-11.32L96,188.69,218.34,66.34a8,8,0,0,1,11.32,11.32Z" />
            </svg>
            @(isProcessing ? "Procesando..." : "Aceptar")
        </button>
    </div>
</div>

@code {
    [Parameter, EditorRequired]
    public PendingInspection Request { get; set; } = new();

    [Parameter, EditorRequired]
    public EventCallback<InspectionDecisionDto> OnReviewComplete { get; set; }

    private DecommissioningReason? selectedRejectionReason;
    private bool isProcessing;
    private string? validationError;

    private async Task HandleAccept()
    {
        if (isProcessing) return;

        try
        {
            isProcessing = true;
            validationError = null;

            var result = new InspectionDecisionDto
            {
                DeviceId = Request.DeviceId,
                TechnicianId = Request.TechnicianId,
                IsApproved = true,
                Reason = null
            };

            await OnReviewComplete.InvokeAsync(result);
            ResetForm();
        }
        catch (Exception ex)
        {
            validationError = $"Error al procesar la aceptación: {ex.Message}";
            isProcessing = false;
        }
    }

    private async Task HandleReject()
    {
        if (isProcessing) return;

        if (!selectedRejectionReason.HasValue)
        {
            validationError = "Debe seleccionar un motivo de rechazo";
            return;
        }

        try
        {
            isProcessing = true;
            validationError = null;

            var result = new InspectionDecisionDto
            {
                DeviceId = Request.DeviceId,
                TechnicianId = Request.TechnicianId,
                IsApproved = false,
                Reason = selectedRejectionReason
            };

            await OnReviewComplete.InvokeAsync(result);
            ResetForm();
        }
        catch (Exception ex)
        {
            validationError = $"Error al procesar el rechazo: {ex.Message}";
            isProcessing = false;
        }
    }

    private void ResetForm()
    {
        selectedRejectionReason = null;
        validationError = null;
        isProcessing = false;
    }
}