@page "/technicians/edit/{TechnicianId:int}"
@using InfraGestion.Web.Features.Users.Models
@using InfraGestion.Web.Features.Users.Services
@using InfraGestion.Web.Features.Users.Components
@inject UserService UserService
@inject NavigationManager Navigation

<div class="user-list-page">
    <div class="page-header-wrapper">
        <div class="page-header">
            <div class="header-text">
                <h1 class="page-title">Editar Técnico</h1>
                <p class="page-description">Modificar información del técnico</p>
            </div>
            <button class="btn-back" @onclick="NavigateBack">
                <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M224,128a8,8,0,0,1-8,8H59.31l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L59.31,120H216A8,8,0,0,1,224,128Z"/>
                </svg>
                Volver
            </button>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="loading-container">
            <div class="spinner"></div>
            <p>Cargando técnico...</p>
        </div>
    }
    else if (user == null)
    {
        <div class="error-container">
            <p>Técnico no encontrado</p>
            <button class="btn-back" @onclick="NavigateBack">Volver al directorio</button>
        </div>
    }
    else
    {
        <div class="form-container">
            <UserFormEdit FormModel="@updateUserRequest" 
                          OnValidSubmit="@HandleUpdateUser" 
                          OnCancel="@NavigateBack" />
        </div>
    }
</div>

@code {
    [Parameter]
    public int TechnicianId { get; set; }

    private User? user;
    private UpdateUserRequest updateUserRequest = new();
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadUser();
    }

    private async Task LoadUser()
    {
        isLoading = true;
        user = await UserService.GetUserByIdAsync(TechnicianId);
        
        if (user != null)
        {
            updateUserRequest = new UpdateUserRequest
            {
                Id = user.Id,
                Name = user.Name,
                Role = user.Role,
                Department = user.Department,
                Password = null // Optional
            };
        }
        
        isLoading = false;
    }

    private async Task HandleUpdateUser(UpdateUserRequest request)
    {
        var result = await UserService.UpdateUserAsync(request);
        if (result != null)
        {
            NavigateBack();
        }
    }

    private void NavigateBack()
    {
        Navigation.NavigateTo($"/technicians/{TechnicianId}");
    }
}
