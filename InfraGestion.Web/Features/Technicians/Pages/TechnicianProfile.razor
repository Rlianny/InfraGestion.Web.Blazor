@* filepath: InfraGestion.Web/Features/Technicians/Pages/TechnicianProfile.razor *@
@page "/technicians/{TechnicianId:int}"
@using InfraGestion.Web.Features.Technicians.Models
@using InfraGestion.Web.Features.Technicians.Services
@using InfraGestion.Web.Features.Technicians.Helpers
@using InfraGestion.Web.Features.Technicians.Components
@using InfraGestion.Web.Shared.Components
@inject TechnicianService TechnicianService
@inject NavigationManager Navigation

@if (isLoading)
{
    <div class="loading-container">
        <div class="spinner"></div>
        <p>Cargando perfil del técnico...</p>
    </div>
}
else if (technician == null)
{
    <div class="error-container">
        <p>No se encontró el técnico solicitado.</p>
        <button class="btn-back" @onclick="NavigateBack">Volver al directorio</button>
    </div>
}
else
{
    <div class="technician-profile-page">
        <!-- Header -->
        <div class="profile-header">
            <div class="header-content">
                <h1 class="technician-title">@technician.Name</h1>
                <span class="status-badge @TechnicianStatusHelper.GetStatusBadgeClass(technician.Status)">
                    <span class="status-dot"></span>
                    @TechnicianStatusHelper.GetStatusDisplayName(technician.Status)
                </span>
            </div>
            <p class="page-description">Perfil detallado de un miembro del personal técnico</p>
            <div class="header-actions">
                <button class="btn-export">
                    <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M74.34,85.66A8,8,0,0,1,85.66,74.34L120,108.69V24a8,8,0,0,1,16,0v84.69l34.34-34.35a8,8,0,0,1,11.32,11.32l-48,48a8,8,0,0,1-11.32,0ZM240,136v64a16,16,0,0,1-16,16H32a16,16,0,0,1-16-16V136a16,16,0,0,1,16-16H84.4a4,4,0,0,1,2.83,1.17L111,145A24,24,0,0,0,145,145l23.8-23.8A4,4,0,0,1,171.6,120H224A16,16,0,0,1,240,136Zm-40,32a12,12,0,1,0-12,12A12,12,0,0,0,200,168Z" />
                    </svg>
                    Exportar
                </button>
                <button class="btn-edit" @onclick="NavigateToEdit">
                    <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M229.66,58.34l-32-32a8,8,0,0,0-11.32,0l-96,96A8,8,0,0,0,88,128v32a8,8,0,0,0,8,8h32a8,8,0,0,0,5.66-2.34l96-96A8,8,0,0,0,229.66,58.34ZM124.69,152H104V131.31l64-64L188.69,88ZM200,76.69,179.31,56,192,43.31,212.69,64ZM224,128v80a16,16,0,0,1-16,16H48a16,16,0,0,1-16-16V48A16,16,0,0,1,48,32h80a8,8,0,0,1,0,16H48V208H208V128a8,8,0,0,1,16,0Z" />
                    </svg>
                    Editar
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="profile-content">
            <!-- Left Column: Main Details -->
            <div class="details-card">
                <h2 class="card-title">Detalles Principales</h2>
                <div class="details-grid">
                    <div class="detail-item">
                        <span class="detail-label">Especialidad</span>
                        <span class="detail-value">@technician.Specialty</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Número de Identificación</span>
                        <span class="detail-value technician-id">@technician.IdentificationNumber</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Fecha de creación de la cuenta</span>
                        <span class="detail-value">@technician.HireDate.ToString("dd/MM/yyyy")</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Anos de experiencia</span>
                        <span class="detail-value">@technician.YearsOfExperience</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Promedio de Valoraciones</span>
                        <span class="detail-value">@technician.Rating.ToString("0.0",
                                                    System.Globalization.CultureInfo.InvariantCulture)/5.0</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Fecha de la última intervención</span>
                    <span class="detail-value">@(technician.LastInterventionDate?.ToString("dd/MM/yyyy") ??
                                                "N/A")</span>
                    </div>
                </div>
            </div>

            <!-- Right Column: Location -->
            <div class="location-card">
                <h2 class="card-title">Ubicación</h2>
                <div class="location-info">
                    <div class="location-item">
                        <span class="location-label">Sección</span>
                        <span class="location-value">@technician.Section</span>
                    </div>
                    <div class="location-item">
                        <span class="location-label">Departamento</span>
                        <span class="location-value">@technician.Department</span>
                    </div>
                    <div class="location-item">
                        <span class="location-label">Responsable de Sección</span>
                        <span class="location-value">@technician.SectionManager</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Maintenance History -->
        <div class="history-section">
            <h2 class="section-title">Historial de Mantenimientos Realizados</h2>
            <div class="table-container">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>FECHA</th>
                            <th>TIPO</th>
                            <th>EQUIPO</th>
                            <th>TÉCNICO</th>
                            <th>NOTAS</th>
                            <th>COSTO</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (technician.MaintenanceHistory == null || !technician.MaintenanceHistory.Any())
                        {
                            <tr>
                                <td colspan="5" class="empty-cell">
                                    No se encontraron registros de mantenimiento
                                </td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var maintenance in technician.MaintenanceHistory)
                            {
                                <tr>
                                    <td>@maintenance.Date.ToString("dd/MM/yyyy")</td>
                                    <td>@maintenance.Type</td>
                                    <td>@(string.IsNullOrWhiteSpace(maintenance.DeviceName) ? maintenance.DeviceId : maintenance.DeviceName)</td>
                                    <td>@maintenance.TechnicianName</td>
                                    <td>@maintenance.Notes</td>
                                    <td>@maintenance.Cost.ToString("F2")</td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Decommission Proposals -->
        <div class="history-section">
            <h2 class="section-title">Proposiciones de Baja</h2>
            <div class="table-container">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>FECHA</th>
                            <th>ID EQUIPO</th>
                            <th>CAUSA</th>
                            <th>RECEPTOR</th>
                            <th>ESTADO</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (technician.DecommissionProposals == null || !technician.DecommissionProposals.Any())
                        {
                            <tr>
                                <td colspan="5" class="empty-cell">
                                    No se encontraron proposiciones de baja
                                </td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var proposal in technician.DecommissionProposals)
                            {
                                <tr>
                                    <td>@proposal.Date.ToString("dd/MM/yyyy")</td>
                                    <td>@(string.IsNullOrWhiteSpace(proposal.DeviceName) ? proposal.DeviceId : proposal.DeviceName)</td>
                                    <td>@proposal.Cause</td>
                                    <td>@proposal.Receiver</td>
                                    <td>
                                        <span class="proposal-status @TechnicianStatusHelper.GetProposalStatusClass(proposal.Status)">
                                            @proposal.Status
                                        </span>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Ratings -->
        <div class="history-section">
            <h2 class="section-title">Valoraciones</h2>
            <div class="table-container">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>FECHA EMISIÓN</th>
                            <th>EMISOR</th>
                            <th>PUNTUACIÓN</th>
                            <th>DESCRIPCIÓN</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (technician.Ratings == null || !technician.Ratings.Any())
                        {
                            <tr>
                                <td colspan="4" class="empty-cell">
                                    No se encontraron valoraciones
                                </td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var rating in technician.Ratings)
                            {
                                <tr>
                                    <td>@rating.Date.ToString("dd/MM/yyyy")</td>
                                    <td>@rating.Issuer</td>
                                    <td>@rating.Score.ToString("0.0", System.Globalization.CultureInfo.InvariantCulture)</td>
                                    <td>@rating.Description</td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>

    </div>
}

@code {
    [Parameter]
    public int TechnicianId { get; set; }

    private TechnicianDetails? technician;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadTechnicianDetails();
    }

    private async Task LoadTechnicianDetails()
    {
        isLoading = true;
        technician = await TechnicianService.GetTechnicianDetailsAsync(TechnicianId);
        isLoading = false;
    }

    private void NavigateBack()
    {
        Navigation.NavigateTo("/technicians");
    }

    private void NavigateToEdit()
    {
        Navigation.NavigateTo($"/technicians/edit/{TechnicianId}");
    }
}