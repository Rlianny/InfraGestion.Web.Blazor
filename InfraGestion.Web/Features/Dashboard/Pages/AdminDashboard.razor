@page "/admin/dashboard"
@using InfraGestion.Web.Features.Auth.Services
@using InfraGestion.Web.Features.Inventory.Services
@using InfraGestion.Web.Features.Inventory.Models
@using InfraGestion.Web.Features.Inventory.Helpers
@using InfraGestion.Web.Features.Inventory.Components
@using InfraGestion.Web.Features.Inventory.DTOs
@using InfraGestion.Web.Features.Users.Services
@using InfraGestion.Web.Features.Users.Models
@using InfraGestion.Web.Features.Users.Components
@using InfraGestion.Web.Shared.Components
@inject AuthService AuthService
@inject InspectionService InspectionService
@inject DeviceService DeviceService
@inject UserService UserService

<PageTitle>Dashboard Administrador - InfraCom</PageTitle>

<h1 class="page-title">Dashboard</h1>

<div class="dashboard-content">
    <!-- Quick Actions Section -->
    <div class="quick-actions-card">
        <h2 class="card-title">Acciones RÃ¡pidas</h2>
        <div class="action-buttons">
            <button class="btn-action btn-primary" @onclick="OpenCreateDeviceModal">
                <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M228,128a12,12,0,0,1-12,12H140v76a12,12,0,0,1-24,0V140H40a12,12,0,0,1,0-24h76V40a12,12,0,0,1,24,0v76h76A12,12,0,0,1,228,128Z" />
                </svg>
                Agregar Dispositivo
            </button>
            <button class="btn-action btn-primary" @onclick="OpenCreateUserModal">
                <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M228,128a12,12,0,0,1-12,12H140v76a12,12,0,0,1-24,0V140H40a12,12,0,0,1,0-24h76V40a12,12,0,0,1,24,0v76h76A12,12,0,0,1,228,128Z" />
                </svg>
                Agregar Usuario
            </button>
        </div>
    </div>

    <!-- Revised Devices Section -->
    <div class="pending-requests-card">
        <h2 class="card-title">Dispositivos Revisados - Completar Registro</h2>

        @if (isLoading)
        {
            <div class="loading-state">Cargando dispositivos...</div>
        }
        else if (!revisedDevices.Any())
        {
            <div class="empty-state">No hay dispositivos pendientes de completar registro</div>
        }
        else
        {
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID DEL EQUIPO</th>
                            <th>NOMBRE</th>
                            <th>TIPO</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var device in revisedDevices)
                        {
                            <tr>
                                <td>@device.EquipmentId</td>
                                <td>@device.Name</td>
                                <td>@DeviceTypeHelper.GetTypeDisplayName(device.Type)</td>
                                <td>
                                    <button class="btn-icon-action" @onclick="() => OpenEditDeviceModal(device.DeviceId)" title="Completar registro">
                                        <svg class="action-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M229.66,58.34l-32-32a8,8,0,0,0-11.32,0l-96,96A8,8,0,0,0,88,128v32a8,8,0,0,0,8,8h32a8,8,0,0,0,5.66-2.34l96-96A8,8,0,0,0,229.66,58.34ZM124.69,152H104V131.31l64-64L188.69,88ZM200,76.69,179.31,56,192,43.31,212.69,64ZM224,128v80a16,16,0,0,1-16,16H48a16,16,0,0,1-16-16V48A16,16,0,0,1,48,32h80a8,8,0,0,1,0,16H48V208H208V128a8,8,0,0,1,16,0Z" />
                                        </svg>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

<!-- Create Device Modal -->
<Modal IsOpen="@showCreateDeviceModal" Title="Agregar Equipo" OnClose="@CloseCreateDeviceModal">
    <DeviceFormCreate FormModel="@createDeviceRequest" OnValidSubmit="@HandleCreateDevice" OnCancel="@CloseCreateDeviceModal" />
</Modal>

<!-- Edit Device Modal -->
<Modal IsOpen="@showEditDeviceModal" Title="Editar Equipo" OnClose="@CloseEditDeviceModal">
    <DeviceFormEdit FormModel="@updateDeviceRequest" OnValidSubmit="@HandleUpdateDevice" OnCancel="@CloseEditDeviceModal" />
</Modal>

<!-- Create User Modal -->
<Modal IsOpen="@showCreateUserModal" Title="Agregar Usuario" OnClose="@CloseCreateUserModal">
    <CreateUserForm FormModel="@createUserRequest" OnValidSubmit="@HandleCreateUser" OnCancel="@CloseCreateUserModal" />
</Modal>

@code {
    private bool isLoading = true;
    private List<RevisedDevice> revisedDevices = new();
    private int currentAdminId = 0;

    // Device modals
    private bool showCreateDeviceModal = false;
    private CreateDeviceRequest createDeviceRequest = new();
    private bool showEditDeviceModal = false;
    private UpdateDeviceRequest updateDeviceRequest = new();

    // User modals
    private bool showCreateUserModal = false;
    private CreateUserRequest createUserRequest = new();

    protected override async Task OnInitializedAsync()
    {
        // Get current user's admin ID
        var currentUser = await AuthService.GetCurrentUserAsync();
        if (currentUser != null)
        {
            currentAdminId = currentUser.Id;
        }

        await LoadRevisedDevices();
    }

    private async Task LoadRevisedDevices()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            // Get revised devices from backend
            List<RevisedDeviceDto>? devices = await InspectionService.GetRevisedDevicesAsync(currentAdminId);

            // Map backend DTOs to UI model
            revisedDevices = devices.Select(d => new RevisedDevice
                {
                    DeviceId = d.DeviceId,
                    EquipmentId = $"DEV{d.DeviceId:D3}",
                    Name = d.Name,
                    Type = (DeviceType)d.DeviceType
                }).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[ERROR] AdminDashboard - LoadRevisedDevices: {ex.Message}");
            revisedDevices = new List<RevisedDevice>();
        }

        isLoading = false;
        StateHasChanged();
    }

    // Device actions
    private void OpenCreateDeviceModal()
    {
        createDeviceRequest = new CreateDeviceRequest();
        showCreateDeviceModal = true;
    }

    private void CloseCreateDeviceModal()
    {
        showCreateDeviceModal = false;
        createDeviceRequest = new CreateDeviceRequest();
    }

    private async Task HandleCreateDevice(CreateDeviceRequest request)
    {
        var device = await DeviceService.CreateDeviceAsync(request);
        if (device != null)
        {
            Console.WriteLine($"[INFO] Device created successfully: {device.Name}");
        }
        CloseCreateDeviceModal();
    }

    private async Task OpenEditDeviceModal(int deviceId)
    {
        try
        {
            var device = await DeviceService.GetDeviceByIdAsync(deviceId);
            if (device != null)
            {
                updateDeviceRequest = new UpdateDeviceRequest
                    {
                        Id = device.Id,
                        Name = device.Name,
                        Type = device.Type,
                        State = device.State,
                        Location = device.Location,
                        PurchaseDate = device.AcquisitionDate
                    };
                showEditDeviceModal = true;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[ERROR] OpenEditDeviceModal: {ex.Message}");
        }
    }

    private void CloseEditDeviceModal()
    {
        showEditDeviceModal = false;
        updateDeviceRequest = new UpdateDeviceRequest();
    }

    private async Task HandleUpdateDevice(UpdateDeviceRequest request)
    {
        var device = await DeviceService.UpdateDeviceAsync(request);
        if (device != null)
        {
            Console.WriteLine($"[INFO] Device updated successfully: {device.Name}");
            await LoadRevisedDevices(); // Reload the list
        }
        CloseEditDeviceModal();
    }

    // User actions
    private void OpenCreateUserModal()
    {
        createUserRequest = new CreateUserRequest();
        showCreateUserModal = true;
    }

    private void CloseCreateUserModal()
    {
        showCreateUserModal = false;
        createUserRequest = new CreateUserRequest();
    }

    private async Task HandleCreateUser(CreateUserRequest request)
    {
        var user = await UserService.CreateUserAsync(request);
        if (user != null)
        {
            Console.WriteLine($"[INFO] User created successfully: {user.Name}");
        }
        CloseCreateUserModal();
    }

    // Inner class for UI model
    private class RevisedDevice
    {
        public int DeviceId { get; set; }
        public string EquipmentId { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public DeviceType Type { get; set; }
    }
}
